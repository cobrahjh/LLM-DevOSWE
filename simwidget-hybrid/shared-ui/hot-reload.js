/**\n * Hot Reload Client for SimWidget Engine\n * \n * Include this script in any HTML page to enable hot reloading:\n * <script src=\"/shared-ui/hot-reload.js\"></script>\n * \n * Features:\n * - Automatic reconnection\n * - CSS hot reload without page refresh\n * - Visual indicators for reload status\n * - Graceful fallback when server unavailable\n */\n\n(function() {\n    'use strict';\n    \n    // Only enable in development\n    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {\n        return;\n    }\n    \n    console.log('üî• SimWidget Hot Reload Client v1.0.0');\n    \n    let ws = null;\n    let reconnectAttempts = 0;\n    const maxReconnectAttempts = 10;\n    const reconnectDelay = 2000;\n    \n    function connect() {\n        try {\n            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n            ws = new WebSocket(protocol + '//' + window.location.host);\n            \n            ws.onopen = function() {\n                console.log('üî• Hot reload connected to SimWidget server');\n                reconnectAttempts = 0;\n                showConnectionStatus('connected');\n            };\n            \n            ws.onmessage = function(event) {\n                try {\n                    const data = JSON.parse(event.data);\n                    handleHotReloadMessage(data);\n                } catch (error) {\n                    // Ignore non-JSON messages (likely flight data)\n                }\n            };\n            \n            ws.onclose = function() {\n                console.log('üî• Hot reload disconnected');\n                showConnectionStatus('disconnected');\n                attemptReconnect();\n            };\n            \n            ws.onerror = function(error) {\n                console.warn('üî• Hot reload connection error:', error);\n            };\n            \n        } catch (error) {\n            console.warn('üî• Hot reload not available:', error.message);\n            attemptReconnect();\n        }\n    }\n    \n    function attemptReconnect() {\n        if (reconnectAttempts >= maxReconnectAttempts) {\n            console.log('üî• Hot reload: Maximum reconnection attempts reached');\n            showConnectionStatus('failed');\n            return;\n        }\n        \n        reconnectAttempts++;\n        const delay = reconnectDelay * reconnectAttempts;\n        \n        console.log(`üîÑ Reconnecting to hot reload server in ${delay/1000}s (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);\n        \n        setTimeout(() => {\n            connect();\n        }, delay);\n    }\n    \n    function handleHotReloadMessage(data) {\n        switch(data.type) {\n            case 'hot-reload-connected':\n                console.log('‚úÖ Hot reload server confirmed connection');\n                break;\n                \n            case 'file-changed':\n                console.log('üìÑ File changed:', data.path, `(${data.type})`);\n                handleFileChange(data);\n                break;\n                \n            case 'file-added':\n                console.log('‚ûï File added:', data.path);\n                showReloadNotification(`New file: ${data.path}`, 'reload');\n                setTimeout(() => window.location.reload(), 800);\n                break;\n                \n            case 'file-deleted':\n                console.log('üóëÔ∏è File deleted:', data.path);\n                showReloadNotification(`File deleted: ${data.path}`, 'reload');\n                setTimeout(() => window.location.reload(), 800);\n                break;\n        }\n    }\n    \n    function handleFileChange(data) {\n        const filePath = data.path.toLowerCase();\n        \n        if (data.type === 'css' || filePath.endsWith('.css')) {\n            reloadCSS();\n            showReloadNotification('Styles updated', 'css');\n        } else if (data.type === 'html' || filePath.endsWith('.html')) {\n            showReloadNotification(`Page updated: ${data.path}`, 'reload');\n            setTimeout(() => window.location.reload(), 800);\n        } else if (data.type === 'javascript' || filePath.endsWith('.js')) {\n            showReloadNotification(`Script updated: ${data.path}`, 'reload');\n            setTimeout(() => window.location.reload(), 800);\n        } else if (data.type === 'json' || filePath.endsWith('.json')) {\n            showReloadNotification(`Config updated: ${data.path}`, 'reload');\n            setTimeout(() => window.location.reload(), 800);\n        } else {\n            // Unknown file type, do a full reload\n            showReloadNotification(`File updated: ${data.path}`, 'reload');\n            setTimeout(() => window.location.reload(), 800);\n        }\n    }\n    \n    function reloadCSS() {\n        const links = document.querySelectorAll('link[rel=\"stylesheet\"]');\n        let reloaded = 0;\n        \n        links.forEach(link => {\n            const href = link.href;\n            if (href && href.includes(window.location.hostname)) {\n                const url = new URL(href);\n                url.searchParams.set('_hr', Date.now());\n                link.href = url.toString();\n                reloaded++;\n            }\n        });\n        \n        console.log(`üé® Reloaded ${reloaded} CSS files`);\n    }\n    \n    function showConnectionStatus(status) {\n        let indicator = document.getElementById('simwidget-hot-reload-indicator');\n        \n        if (!indicator) {\n            indicator = document.createElement('div');\n            indicator.id = 'simwidget-hot-reload-indicator';\n            indicator.style.cssText = `\n                position: fixed;\n                top: 8px;\n                right: 8px;\n                padding: 6px 10px;\n                border-radius: 12px;\n                font-family: 'Segoe UI', Tahoma, sans-serif;\n                font-size: 11px;\n                font-weight: 500;\n                z-index: 999999;\n                pointer-events: none;\n                transition: all 0.3s ease;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n                backdrop-filter: blur(4px);\n            `;\n            document.body.appendChild(indicator);\n        }\n        \n        switch(status) {\n            case 'connected':\n                indicator.textContent = 'üî• Hot Reload';\n                indicator.style.backgroundColor = 'rgba(16, 185, 129, 0.9)';\n                indicator.style.color = 'white';\n                indicator.style.opacity = '1';\n                \n                // Fade to subtle after 3 seconds\n                setTimeout(() => {\n                    if (indicator.textContent.includes('Hot Reload')) {\n                        indicator.style.opacity = '0.6';\n                        indicator.style.transform = 'scale(0.9)';\n                    }\n                }, 3000);\n                break;\n                \n            case 'disconnected':\n                indicator.textContent = 'üî• Reconnecting...';\n                indicator.style.backgroundColor = 'rgba(245, 158, 11, 0.9)';\n                indicator.style.color = 'white';\n                indicator.style.opacity = '1';\n                indicator.style.transform = 'scale(1)';\n                break;\n                \n            case 'failed':\n                indicator.textContent = 'üî• Offline';\n                indicator.style.backgroundColor = 'rgba(239, 68, 68, 0.9)';\n                indicator.style.color = 'white';\n                indicator.style.opacity = '0.8';\n                indicator.style.transform = 'scale(1)';\n                break;\n        }\n    }\n    \n    function showReloadNotification(message, type = 'info') {\n        const notification = document.createElement('div');\n        notification.style.cssText = `\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: rgba(20, 25, 45, 0.95);\n            backdrop-filter: blur(8px);\n            color: white;\n            padding: 20px 30px;\n            border-radius: 12px;\n            font-family: 'Segoe UI', Tahoma, sans-serif;\n            text-align: center;\n            z-index: 1000000;\n            box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n            border: 1px solid rgba(126, 200, 227, 0.2);\n            animation: slideInScale 0.3s ease-out;\n        `;\n        \n        const icon = type === 'css' ? 'üé®' : type === 'reload' ? 'üîÑ' : '‚ÑπÔ∏è';\n        \n        notification.innerHTML = `\n            <div style=\"font-size: 18px; margin-bottom: 8px;\">${icon}</div>\n            <div style=\"font-size: 14px; font-weight: 500;\">${message}</div>\n            ${type === 'reload' ? '<div style=\"font-size: 12px; color: #94a3b8; margin-top: 8px;\">Reloading...</div>' : ''}\n        `;\n        \n        // Add animation keyframes\n        if (!document.getElementById('hot-reload-animations')) {\n            const style = document.createElement('style');\n            style.id = 'hot-reload-animations';\n            style.textContent = `\n                @keyframes slideInScale {\n                    from {\n                        opacity: 0;\n                        transform: translate(-50%, -50%) scale(0.8);\n                    }\n                    to {\n                        opacity: 1;\n                        transform: translate(-50%, -50%) scale(1);\n                    }\n                }\n            `;\n            document.head.appendChild(style);\n        }\n        \n        document.body.appendChild(notification);\n        \n        // Remove notification after delay\n        setTimeout(() => {\n            if (notification.parentNode) {\n                notification.style.animation = 'slideInScale 0.3s ease-out reverse';\n                setTimeout(() => {\n                    if (notification.parentNode) {\n                        notification.remove();\n                    }\n                }, 300);\n            }\n        }, type === 'css' ? 1500 : 2500);\n    }\n    \n    // Start connection when DOM is ready\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', connect);\n    } else {\n        connect();\n    }\n    \n    // Expose hot reload API\n    window.SimWidgetHotReload = {\n        reconnect: connect,\n        reloadCSS: reloadCSS,\n        isConnected: () => ws && ws.readyState === WebSocket.OPEN\n    };\n    \n})();\n