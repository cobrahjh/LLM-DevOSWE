/**\n * Component Markers Integration v1.0.0\n * \n * Integration module to add component processing markers to the SimWidget server\n * This file contains the server integration code for component markers.\n * \n * Path: C:\\DevOSWE\\simwidget-hybrid\\backend\\component-markers-integration.js\n * Created: 2025-01-08\n */\n\nconst ComponentMarkers = require('./component-markers');\n\nclass ComponentMarkersIntegration {\n    constructor() {\n        this.markers = new ComponentMarkers();\n        console.log('[ComponentMarkers] Integration loaded');\n    }\n    \n    /**\n     * Initialize API routes for component markers\n     * @param {Express} app - Express app instance\n     */\n    initializeRoutes(app) {\n        // Get all components with their markers\n        app.get('/api/components', (req, res) => {\n            try {\n                const components = this.markers.getAllComponents();\n                res.json({\n                    success: true,\n                    data: components,\n                    count: components.length\n                });\n            } catch (error) {\n                res.status(500).json({\n                    success: false,\n                    error: error.message\n                });\n            }\n        });\n        \n        // Get markers for a specific component\n        app.get('/api/components/:name/markers', (req, res) => {\n            try {\n                const { name } = req.params;\n                const markers = this.markers.getComponentMarkers(name);\n                const costEstimate = this.markers.getComponentCostEstimate(name);\n                \n                res.json({\n                    success: true,\n                    component: name,\n                    markers,\n                    costEstimate,\n                    requiresAPI: this.markers.requiresAPIAccess(name),\n                    requiresUserInput: this.markers.requiresUserInput(name)\n                });\n            } catch (error) {\n                res.status(500).json({\n                    success: false,\n                    error: error.message\n                });\n            }\n        });\n        \n        // Get HTML markers for a component\n        app.get('/api/components/:name/markers/html', (req, res) => {\n            try {\n                const { name } = req.params;\n                const options = {\n                    showTooltips: req.query.tooltips !== 'false',\n                    showIcons: req.query.icons !== 'false',\n                    showClasses: req.query.classes !== 'false'\n                };\n                \n                const html = this.markers.generateMarkersHTML(name, options);\n                \n                res.json({\n                    success: true,\n                    component: name,\n                    html,\n                    options\n                });\n            } catch (error) {\n                res.status(500).json({\n                    success: false,\n                    error: error.message\n                });\n            }\n        });\n        \n        // Get CSS for markers\n        app.get('/api/components/markers.css', (req, res) => {\n            try {\n                const css = this.markers.generateMarkersCSS();\n                res.setHeader('Content-Type', 'text/css');\n                res.send(css);\n            } catch (error) {\n                res.status(500).json({\n                    success: false,\n                    error: error.message\n                });\n            }\n        });\n        \n        // Register a new component with markers\n        app.post('/api/components/:name/markers', (req, res) => {\n            try {\n                const { name } = req.params;\n                const { markers } = req.body;\n                \n                if (!Array.isArray(markers)) {\n                    return res.status(400).json({\n                        success: false,\n                        error: 'Markers must be an array'\n                    });\n                }\n                \n                this.markers.registerComponent(name, markers);\n                \n                res.json({\n                    success: true,\n                    message: `Component '${name}' registered with ${markers.length} markers`,\n                    component: name,\n                    markers: this.markers.getComponentMarkers(name)\n                });\n            } catch (error) {\n                res.status(500).json({\n                    success: false,\n                    error: error.message\n                });\n            }\n        });\n        \n        // Get cost estimates for all components\n        app.get('/api/components/costs', (req, res) => {\n            try {\n                const components = this.markers.getAllComponents();\n                const costs = components.map(comp => comp.costEstimate);\n                \n                const totalHourlyCost = costs.reduce((sum, cost) => sum + cost.estimatedHourlyCost, 0);\n                const highRiskComponents = costs.filter(cost => cost.riskLevel === 'high');\n                \n                res.json({\n                    success: true,\n                    data: {\n                        components: costs,\n                        summary: {\n                            totalComponents: costs.length,\n                            totalHourlyCost: parseFloat(totalHourlyCost.toFixed(4)),\n                            highRiskCount: highRiskComponents.length,\n                            averageCost: parseFloat((totalHourlyCost / costs.length).toFixed(4))\n                        }\n                    }\n                });\n            } catch (error) {\n                res.status(500).json({\n                    success: false,\n                    error: error.message\n                });\n            }\n        });\n        \n        console.log('[ComponentMarkers] API routes initialized');\n    }\n    \n    /**\n     * Get component markers instance\n     * @returns {ComponentMarkers} Component markers instance\n     */\n    getMarkers() {\n        return this.markers;\n    }\n    \n    /**\n     * Enhanced widget listing with markers\n     * @returns {Array} Widget list with marker information\n     */\n    getEnhancedWidgetList() {\n        const widgets = [\n            { name: 'aircraft-control', title: 'Aircraft Control', icon: 'âœˆï¸' },\n            { name: 'camera-widget', title: 'Camera Widget', icon: 'ğŸ“·' },\n            { name: 'flight-data-widget', title: 'Flight Data Widget', icon: 'ğŸ“Š' },\n            { name: 'flight-recorder', title: 'Flight Recorder', icon: 'ğŸ¬' },\n            { name: 'fuel-widget', title: 'Fuel Widget', icon: 'â›½' },\n            { name: 'keymap-editor', title: 'Keymap Editor', icon: 'âŒ¨ï¸' },\n            { name: 'services-panel', title: 'Services Panel', icon: 'ğŸ”§' },\n            { name: 'voice-control', title: 'Voice Control', icon: 'ğŸ¤' },\n            { name: 'wasm-camera', title: 'WASM Camera', icon: 'ğŸ¥' }\n        ];\n        \n        return widgets.map(widget => {\n            const markers = this.markers.getComponentMarkers(widget.name);\n            const costEstimate = this.markers.getComponentCostEstimate(widget.name);\n            \n            return {\n                ...widget,\n                markers: markers.map(m => ({ icon: m.icon, tooltip: m.tooltip, class: m.class })),\n                costEstimate: {\n                    hourlyCost: costEstimate.estimatedHourlyCost,\n                    riskLevel: costEstimate.riskLevel\n                },\n                requiresAPI: this.markers.requiresAPIAccess(widget.name),\n                requiresUserInput: this.markers.requiresUserInput(widget.name)\n            };\n        });\n    }\n    \n    /**\n     * Generate enhanced home page HTML with component markers\n     * @param {string} serverVersion - Server version\n     * @param {string} keySenderVersion - KeySender version\n     * @returns {string} Enhanced HTML\n     */\n    generateEnhancedHomePage(serverVersion, keySenderVersion) {\n        const widgets = this.getEnhancedWidgetList();\n        \n        let widgetHTML = '';\n        widgets.forEach(widget => {\n            const markersHTML = widget.markers.map(m => \n                `<span class=\"marker\" title=\"${m.tooltip}\" style=\"color: ${this.markers.markers[Object.keys(this.markers.markers).find(k => this.markers.markers[k].class === m.class)]?.color || '#888'};\">${m.icon}</span>`\n            ).join('');\n            \n            const riskClass = widget.costEstimate.riskLevel === 'high' ? 'high-risk' : \n                             widget.costEstimate.riskLevel === 'medium' ? 'medium-risk' : 'low-risk';\n            \n            widgetHTML += `\n                <li class=\"widget-item ${riskClass}\">\n                    <a href=\"/ui/${widget.name}/\">${widget.icon} ${widget.title}</a>\n                    <div class=\"widget-indicators\">\n                        ${markersHTML}\n                        ${widget.costEstimate.hourlyCost > 0 ? `<span class=\"cost-indicator\">$${widget.costEstimate.hourlyCost.toFixed(3)}/h</span>` : ''}\n                    </div>\n                </li>`;\n        });\n        \n        return `\n<!DOCTYPE html>\n<html>\n<head>\n    <title>SimWidget Engine</title>\n    <style>\n        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; padding: 40px; }\n        h1 { color: #7ec8e3; }\n        a { color: #7ec8e3; text-decoration: none; }\n        a:hover { text-decoration: underline; }\n        .section { margin: 20px 0; padding: 15px; background: #16213e; border-radius: 8px; }\n        .section h2 { margin-top: 0; color: #4ade80; font-size: 16px; }\n        ul { list-style: none; padding: 0; }\n        li { padding: 5px 0; }\n        .version { color: #888; font-size: 12px; }\n        \n        /* Enhanced widget styling */\n        .widget-item {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            padding: 8px 12px;\n            background: rgba(255, 255, 255, 0.05);\n            border-radius: 6px;\n            margin: 4px 0;\n            border-left: 3px solid transparent;\n        }\n        \n        .widget-item.high-risk {\n            border-left-color: #ef4444;\n            background: rgba(239, 68, 68, 0.1);\n        }\n        \n        .widget-item.medium-risk {\n            border-left-color: #f59e0b;\n            background: rgba(245, 158, 11, 0.1);\n        }\n        \n        .widget-item.low-risk {\n            border-left-color: #10b981;\n        }\n        \n        .widget-indicators {\n            display: flex;\n            align-items: center;\n            gap: 6px;\n        }\n        \n        .marker {\n            font-size: 14px;\n            opacity: 0.8;\n            cursor: help;\n        }\n        \n        .cost-indicator {\n            font-size: 10px;\n            padding: 2px 6px;\n            background: rgba(239, 68, 68, 0.2);\n            border-radius: 4px;\n            color: #fca5a5;\n        }\n    </style>\n</head>\n<body>\n    <h1>SimWidget Engine</h1>\n    <p class=\"version\">Server v${serverVersion} | KeySender v${keySenderVersion} | Component Markers v1.0.0</p>\n    \n    <div class=\"section\">\n        <h2>ğŸ“ Directories</h2>\n        <ul>\n            <li><a href=\"/ui/\">ğŸ“‚ /ui/</a> - UI Widgets & Controls</li>\n            <li><a href=\"/config/\">ğŸ“‚ /config/</a> - Configuration Files</li>\n            <li><a href=\"/backend/\">ğŸ“‚ /backend/</a> - Backend Source</li>\n        </ul>\n    </div>\n    \n    <div class=\"section\">\n        <h2>ğŸ® UI Widgets with Processing Indicators</h2>\n        <ul>\n            ${widgetHTML}\n        </ul>\n        <p style=\"font-size: 12px; color: #888; margin-top: 10px;\">\n            Indicators: ğŸ’° Cost-intensive | âš¡ Real-time | ğŸ”Œ API calls | ğŸ¯ User input | ğŸ“Š Compute-heavy | ğŸ”„ Background\n        </p>\n    </div>\n    \n    <div class=\"section\">\n        <h2>ğŸ”Œ API</h2>\n        <ul>\n            <li><a href=\"/api\">/api</a> - API Index (all endpoints)</li>\n            <li><a href=\"/api/components\">/api/components</a> - Component Markers</li>\n            <li><a href=\"/api/components/costs\">/api/components/costs</a> - Cost Estimates</li>\n            <li><a href=\"/api/status\">/api/status</a> - Connection Status</li>\n            <li><a href=\"/api/keymaps\">/api/keymaps</a> - Key Mappings</li>\n        </ul>\n    </div>\n</body>\n</html>\n        `;\n    }\n}\n\nmodule.exports = ComponentMarkersIntegration;\n"