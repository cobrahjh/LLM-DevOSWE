<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Launcher - SimGlass</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="/ui/shared/settings-panel.css">
    <link rel="stylesheet" href="/ui/shared/widget-customizer.css">
    <style>
        /* Theme selector styles */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .theme-selector {
            background: var(--widget-bg-secondary, #16213e);
            color: var(--widget-text, #fff);
            border: 1px solid var(--widget-border, rgba(255,255,255,0.1));
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s ease;
        }
        .theme-selector:hover,
        .theme-selector:focus {
            border-color: var(--widget-accent, #667eea);
        }
        .theme-selector option {
            background: var(--widget-bg, #1a1a2e);
            color: var(--widget-text, #fff);
        }
        .auto-theme-toggle {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            user-select: none;
            font-size: 11px;
            color: var(--widget-text-muted, #888);
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--widget-bg-secondary, #16213e);
            border: 1px solid var(--widget-border, rgba(255,255,255,0.1));
            transition: all 0.2s ease;
        }
        .auto-theme-toggle:hover {
            border-color: var(--widget-accent, #667eea);
            color: var(--widget-text, #fff);
        }
        .auto-theme-toggle input {
            width: 14px;
            height: 14px;
            accent-color: var(--widget-accent, #667eea);
            cursor: pointer;
            margin: 0;
        }
        .auto-theme-toggle.active {
            border-color: var(--widget-accent, #667eea);
            color: var(--widget-text, #fff);
        }
    </style>
    <script src="/ui/shared/themes.js"></script>
    <script src="/ui/shared/auto-theme.js"></script>
</head>
<body>
    <button class="settings-btn" id="settings-btn" title="Settings">‚öôÔ∏è</button>
    <div class="widget-container">
        <header class="widget-header">
            <h1>Panel Launcher</h1>
            <div class="header-controls">
                <label class="auto-theme-toggle" title="Auto-switch theme based on simulator time (19:00-06:00 = night)">
                    <input type="checkbox" id="auto-theme-toggle">
                    <span>Auto</span>
                </label>
                <select class="theme-selector" id="theme-selector" title="Select Theme">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="midnight">Midnight</option>
                    <option value="sunset">Sunset</option>
                    <option value="cockpit">Cockpit</option>
                    <option value="amoled">AMOLED</option>
                    <option value="highContrast">High Contrast</option>
                </select>
                <span class="status-dot" id="status"></span>
            </div>
        </header>

        <!-- Avionics Power -->
        <section class="panel-section">
            <h2>Avionics Power</h2>
            <div class="button-grid power-grid">
                <button class="power-btn" data-command="TOGGLE_MASTER_BATTERY" title="Battery Master">
                    <span class="icon">üîã</span>
                    <span class="label">BATT</span>
                </button>
                <button class="power-btn" data-command="TOGGLE_MASTER_ALTERNATOR" title="Alternator">
                    <span class="icon">‚ö°</span>
                    <span class="label">ALT</span>
                </button>
                <button class="power-btn" data-command="TOGGLE_AVIONICS_MASTER" title="Avionics Master">
                    <span class="icon">üì°</span>
                    <span class="label">AVNCS</span>
                </button>
            </div>
        </section>

        <!-- G1000 PFD Controls -->
        <section class="panel-section">
            <h2>G1000 PFD</h2>
            <div class="button-grid">
                <button class="panel-btn" data-hevent="AS1000_PFD_SOFTKEYS_1" title="Softkey 1">SK1</button>
                <button class="panel-btn" data-hevent="AS1000_PFD_SOFTKEYS_2" title="Softkey 2">SK2</button>
                <button class="panel-btn" data-hevent="AS1000_PFD_SOFTKEYS_3" title="Softkey 3">SK3</button>
                <button class="panel-btn" data-hevent="AS1000_PFD_SOFTKEYS_4" title="Softkey 4">SK4</button>
                <button class="panel-btn" data-hevent="AS1000_PFD_SOFTKEYS_5" title="Softkey 5">SK5</button>
                <button class="panel-btn" data-hevent="AS1000_PFD_SOFTKEYS_6" title="Softkey 6">SK6</button>
            </div>
            <div class="knob-row">
                <div class="knob-group">
                    <span class="knob-label">NAV VOL</span>
                    <button class="knob-btn" data-hevent="AS1000_PFD_VOL_1_DEC">-</button>
                    <button class="knob-btn" data-hevent="AS1000_PFD_VOL_1_INC">+</button>
                </div>
                <div class="knob-group">
                    <span class="knob-label">HDG</span>
                    <button class="knob-btn" data-hevent="AS1000_PFD_CRS_DEC">-</button>
                    <button class="knob-btn" data-hevent="AS1000_PFD_CRS_INC">+</button>
                </div>
                <div class="knob-group">
                    <span class="knob-label">ALT</span>
                    <button class="knob-btn" data-hevent="AS1000_PFD_BARO_DEC">-</button>
                    <button class="knob-btn" data-hevent="AS1000_PFD_BARO_INC">+</button>
                </div>
            </div>
        </section>

        <!-- G1000 MFD Controls -->
        <section class="panel-section">
            <h2>G1000 MFD</h2>
            <div class="button-grid">
                <button class="panel-btn" data-hevent="AS1000_MFD_SOFTKEYS_1" title="Softkey 1">SK1</button>
                <button class="panel-btn" data-hevent="AS1000_MFD_SOFTKEYS_2" title="Softkey 2">SK2</button>
                <button class="panel-btn" data-hevent="AS1000_MFD_SOFTKEYS_3" title="Softkey 3">SK3</button>
                <button class="panel-btn" data-hevent="AS1000_MFD_SOFTKEYS_4" title="Softkey 4">SK4</button>
                <button class="panel-btn" data-hevent="AS1000_MFD_SOFTKEYS_5" title="Softkey 5">SK5</button>
                <button class="panel-btn" data-hevent="AS1000_MFD_SOFTKEYS_6" title="Softkey 6">SK6</button>
            </div>
            <div class="knob-row">
                <div class="knob-group">
                    <span class="knob-label">FMS</span>
                    <button class="knob-btn" data-hevent="AS1000_MFD_FMS_Lower_DEC">-</button>
                    <button class="knob-btn" data-hevent="AS1000_MFD_FMS_Lower_INC">+</button>
                </div>
                <div class="knob-group">
                    <span class="knob-label">RANGE</span>
                    <button class="knob-btn" data-hevent="AS1000_MFD_RANGE_DEC">-</button>
                    <button class="knob-btn" data-hevent="AS1000_MFD_RANGE_INC">+</button>
                </div>
                <div class="knob-group">
                    <span class="knob-label">ENT/CLR</span>
                    <button class="knob-btn" data-hevent="AS1000_MFD_ENT">ENT</button>
                    <button class="knob-btn" data-hevent="AS1000_MFD_CLR">CLR</button>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="panel-section">
            <h2>Quick Actions</h2>
            <div class="button-grid actions-grid">
                <button class="action-btn" data-hevent="AS1000_PFD_DIRECTTO" title="Direct To">
                    <span class="icon">‚û°Ô∏è</span>
                    <span class="label">D‚Üí</span>
                </button>
                <button class="action-btn" data-hevent="AS1000_MFD_MENU" title="Menu">
                    <span class="icon">üìã</span>
                    <span class="label">MENU</span>
                </button>
                <button class="action-btn" data-hevent="AS1000_MFD_FPL" title="Flight Plan">
                    <span class="icon">üó∫Ô∏è</span>
                    <span class="label">FPL</span>
                </button>
                <button class="action-btn" data-hevent="AS1000_MFD_PROC" title="Procedures">
                    <span class="icon">üìù</span>
                    <span class="label">PROC</span>
                </button>
                <button class="action-btn" data-command="VIEW_MODE" title="Cycle Camera View">
                    <span class="icon">üì∑</span>
                    <span class="label">VIEW</span>
                </button>
                <button class="action-btn" data-command="COCKPIT_VIEW" title="Cockpit View">
                    <span class="icon">üéØ</span>
                    <span class="label">COCKPIT</span>
                </button>
            </div>
        </section>

        <!-- Preset Layouts -->
        <section class="panel-section">
            <h2>Presets</h2>
            <div class="button-grid preset-grid">
                <button class="preset-btn" data-preset="IFR" title="Instrument Flight Rules - Copilot, Flight Plan, Map, Weather, Radio Stack">
                    <span class="preset-icon" id="icon-IFR"></span>
                    <span class="label">IFR</span>
                </button>
                <button class="preset-btn" data-preset="VFR" title="Visual Flight Rules - Map, Checklist, Timer, Notepad">
                    <span class="preset-icon" id="icon-VFR"></span>
                    <span class="label">VFR</span>
                </button>
                <button class="preset-btn" data-preset="Cruise" title="Cruise Phase - Copilot, Flight Plan, Notepad, Timer">
                    <span class="preset-icon" id="icon-Cruise"></span>
                    <span class="label">Cruise</span>
                </button>
                <button class="preset-btn" data-preset="Ground" title="Ground Operations - Checklist, Fuel, SimBrief">
                    <span class="preset-icon" id="icon-Ground"></span>
                    <span class="label">Ground</span>
                </button>
            </div>
        </section>

        <!-- SimGlasss Quick Launch -->
        <section class="panel-section">
            <h2>SimGlasss</h2>
            <div class="button-grid widget-grid">
                <a href="/ui/copilot-widget/" target="_blank" class="widget-btn" title="AI Copilot">
                    <span class="icon">üßë‚Äç‚úàÔ∏è</span>
                    <span class="label">Copilot</span>
                </a>
                <a href="/ui/checklist-widget/" target="_blank" class="widget-btn" title="Checklists">
                    <span class="icon">‚úÖ</span>
                    <span class="label">Checklist</span>
                </a>
                <a href="/ui/flightplan-widget/" target="_blank" class="widget-btn" title="Flight Plan">
                    <span class="icon">üõ´</span>
                    <span class="label">FPL</span>
                </a>
                <a href="/ui/map-widget/" target="_blank" class="widget-btn" title="Live Map">
                    <span class="icon">üó∫Ô∏è</span>
                    <span class="label">Map</span>
                </a>
                <a href="/ui/weather-widget/" target="_blank" class="widget-btn" title="Weather/METAR">
                    <span class="icon">üå§Ô∏è</span>
                    <span class="label">Weather</span>
                </a>
                <a href="/ui/timer-widget/" target="_blank" class="widget-btn" title="Timer">
                    <span class="icon">‚è±Ô∏è</span>
                    <span class="label">Timer</span>
                </a>
                <a href="/ui/simbrief-widget/" target="_blank" class="widget-btn" title="SimBrief">
                    <span class="icon">üìã</span>
                    <span class="label">SimBrief</span>
                </a>
                <a href="/ui/notepad-widget/" target="_blank" class="widget-btn" title="Notepad">
                    <span class="icon">üìù</span>
                    <span class="label">Notes</span>
                </a>
                <a href="/ui/camera-control/" target="_blank" class="widget-btn" title="Camera Control">
                    <span class="icon">üì∑</span>
                    <span class="label">Camera</span>
                </a>
                <a href="/ui/voice-control/" target="_blank" class="widget-btn" title="Voice Control">
                    <span class="icon">üé§</span>
                    <span class="label">Voice</span>
                </a>
                <a href="/ui/health-dashboard/" target="_blank" class="widget-btn" title="System Health">
                    <span class="icon">üíö</span>
                    <span class="label">Health</span>
                </a>
            </div>
        </section>

        <!-- Pop-Out Info -->
        <section class="panel-section info-section">
            <h2>Panel Pop-Out</h2>
            <p class="info-text">
                <strong>Right-Alt + Click</strong> on any avionics panel to pop it out as a separate window.
            </p>
            <p class="info-hint">
                Use MSFS Pop Out Panel Manager for automated pop-outs.
            </p>
        </section>

        <!-- Hotkeys Info -->
        <section class="panel-section info-section hotkeys-section">
            <h2>Keyboard Shortcuts</h2>
            <p class="info-text">
                <strong>Hotkeys: Ctrl+1-5</strong> for quick widget access
            </p>
            <p class="info-hint">
                Ctrl+1 Copilot | Ctrl+2 Flight Plan | Ctrl+3 Map | Ctrl+4 Checklist | Ctrl+5 Weather<br>
                Ctrl+Shift+S SimBrief | Ctrl+Shift+N Notepad | Escape to close
            </p>
        </section>

        <!-- Settings Backup -->
        <section class="panel-section settings-backup-section">
            <h2>Settings</h2>
            <div class="settings-backup-info">
                <span class="settings-count" id="settings-count">Loading...</span>
            </div>
            <div class="settings-backup-actions">
                <button class="backup-btn export-btn" id="export-settings-btn" title="Download all settings as JSON">
                    <span class="icon">üì•</span>
                    <span class="label">Export Settings</span>
                </button>
                <label class="backup-btn import-btn" title="Restore settings from JSON file">
                    <span class="icon">üì§</span>
                    <span class="label">Import Settings</span>
                    <input type="file" id="import-settings-input" accept=".json" hidden>
                </label>
            </div>
            <p class="import-status" id="import-status"></p>
        </section>
    </div>

    <script src="/ui/shared/settings-panel.js"></script>
    <script src="/ui/shared/widget-customizer.js"></script>
    <script src="/ui/shared/hotkeys.js"></script>
    <script src="/ui/shared/presets.js"></script>
    <script src="/ui/shared/settings-backup.js"></script>
    <script src="widget.js"></script>
    <script>
        const settings = new SettingsPanel();
        const customizer = new WidgetCustomizer({ widgetId: 'panel-launcher', settingsPanel: settings });
        document.getElementById('settings-btn').addEventListener('click', () => settings.toggle());

        // Theme selector integration
        const themeSelector = document.getElementById('theme-selector');
        if (themeSelector && window.SimGlassThemes) {
            // Set initial value from saved theme
            themeSelector.value = SimGlassThemes.getCurrentTheme();

            // Handle theme changes
            themeSelector.addEventListener('change', (e) => {
                SimGlassThemes.setTheme(e.target.value);
            });

            // Update selector when theme changes from another widget
            window.addEventListener('SimGlass-theme-changed', (e) => {
                themeSelector.value = e.detail.theme;
            });
        }

        // Auto theme toggle integration
        const autoThemeToggle = document.getElementById('auto-theme-toggle');
        const autoThemeLabel = autoThemeToggle ? autoThemeToggle.closest('.auto-theme-toggle') : null;
        if (autoThemeToggle && window.SimGlassAutoTheme) {
            // Set initial state
            autoThemeToggle.checked = SimGlassAutoTheme.isEnabled();
            if (autoThemeLabel) {
                autoThemeLabel.classList.toggle('active', autoThemeToggle.checked);
            }

            // Handle toggle changes
            autoThemeToggle.addEventListener('change', (e) => {
                if (e.target.checked) {
                    SimGlassAutoTheme.enable();
                } else {
                    SimGlassAutoTheme.disable();
                }
                if (autoThemeLabel) {
                    autoThemeLabel.classList.toggle('active', e.target.checked);
                }
            });

            // Update toggle when auto-theme state changes externally
            window.addEventListener('SimGlass-auto-theme-changed', (e) => {
                autoThemeToggle.checked = SimGlassAutoTheme.isEnabled();
                if (autoThemeLabel) {
                    autoThemeLabel.classList.toggle('active', autoThemeToggle.checked);
                }
            });
        }

        // Initialize preset buttons
        (function initPresets() {
            if (typeof SimGlassPresets === 'undefined') {
                console.warn('[Panel Launcher] SimGlassPresets not loaded');
                return;
            }

            const presets = SimGlassPresets.getBuiltInPresets();

            // Set icons for each preset button using safe DOM insertion
            Object.keys(presets).forEach(name => {
                const iconEl = document.getElementById('icon-' + name);
                if (iconEl) {
                    // Create a template element for safe SVG insertion from trusted source
                    const template = document.createElement('template');
                    template.innerHTML = SimGlassPresets.getPresetIcon(presets[name].icon);
                    iconEl.appendChild(template.content.cloneNode(true));
                }
            });

            // Add click handlers
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const presetName = btn.dataset.preset;
                    btn.classList.add('loading');
                    SimGlassPresets.applyPreset(presetName);
                    setTimeout(() => btn.classList.remove('loading'), 1000);
                });
            });
        })();

        // Initialize settings backup
        (function initSettingsBackup() {
            if (typeof SimGlassSettingsBackup === 'undefined') {
                console.warn('[Panel Launcher] SimGlassSettingsBackup not loaded');
                return;
            }

            const countEl = document.getElementById('settings-count');
            const statusEl = document.getElementById('import-status');
            const exportBtn = document.getElementById('export-settings-btn');
            const importInput = document.getElementById('import-settings-input');

            // Update settings count display
            function updateSettingsCount() {
                const summary = SimGlassSettingsBackup.getSettingsSummary();
                countEl.textContent = `${summary.total} saved settings`;
                if (summary.themes > 0 || summary.presets > 0 || summary.hotkeys > 0) {
                    const details = [];
                    if (summary.themes > 0) details.push(`${summary.themes} themes`);
                    if (summary.presets > 0) details.push(`${summary.presets} presets`);
                    if (summary.hotkeys > 0) details.push(`${summary.hotkeys} hotkeys`);
                    countEl.textContent += ` (${details.join(', ')})`;
                }
            }

            updateSettingsCount();

            // Export button handler
            exportBtn.addEventListener('click', () => {
                const count = SimGlassSettingsBackup.exportSettings();
                statusEl.textContent = `Exported ${count} settings`;
                statusEl.className = 'import-status success';
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            });

            // Import file handler
            importInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    statusEl.textContent = 'Importing...';
                    statusEl.className = 'import-status';
                    const result = await SimGlassSettingsBackup.importSettings(file);
                    statusEl.textContent = `Imported ${result.imported} settings. Reload to apply.`;
                    statusEl.className = 'import-status success';
                    updateSettingsCount();
                } catch (err) {
                    statusEl.textContent = 'Import failed: ' + err.message;
                    statusEl.className = 'import-status error';
                }

                // Reset input so same file can be selected again
                importInput.value = '';
            });
        })();
    </script>
</body>
</html>
