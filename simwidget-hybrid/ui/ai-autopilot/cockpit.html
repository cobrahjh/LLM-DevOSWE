<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Cockpit - Autopilot + Diagnostics</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { background: #0d1117; color: #c9d1d9; font-family: monospace; font-size: 10px; overflow: hidden; height: 100vh; }

/* Layout */
.cockpit-container { display: flex; flex-direction: column; height: 100vh; }
.cockpit-header { background: #161b22; border-bottom: 1px solid #30363d; padding: 4px 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; position: relative; }
.cockpit-title { color: #58a6ff; font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 4px; position: absolute; left: 8px; }
.cockpit-body { display: flex; flex: 1; overflow: hidden; }

/* Panes */
.pane { flex: 1; overflow-y: auto; padding: 6px; border-right: 1px solid #30363d; }
.pane:last-child { border-right: none; }
.pane-left { background: #0d1117; }
.pane-right { background: #0a0c10; }

/* Header controls */
.header-controls { display: flex; align-items: center; gap: 3px; }
.header-btn { background: #21262d; border: 1px solid #30363d; color: #c9d1d9; border-radius: 3px; padding: 3px 6px; cursor: pointer; font-family: monospace; font-size: 9px; }
.header-btn:hover { background: #30363d; }
.header-btn.active { background: #0d2a18; border-color: #3fb950; color: #3fb950; }
.header-btn.off { background: #2a0d0d; border-color: #f85149; color: #f85149; }
.conn-dot { width: 7px; height: 7px; border-radius: 50%; background: #f85149; }
.conn-dot.ok { background: #3fb950; }
.lock-status { font-size: 10px; opacity: 0.6; transition: opacity 0.3s; }
.lock-status.locked { opacity: 1; }

/* Phase indicators */
.phase-indicators { display: flex; gap: 2px; margin-left: 4px; }
.phase-chip {
    background: #161b22;
    border: 1px solid #30363d;
    color: #8b949e;
    border-radius: 2px;
    padding: 2px 4px;
    font-size: 7px;
    font-family: monospace;
    letter-spacing: 0.5px;
    transition: all 0.2s;
}
.phase-chip.active {
    background: #0d2533;
    border-color: #58a6ff;
    color: #58a6ff;
    font-weight: bold;
    box-shadow: 0 0 4px #58a6ff;
}

/* Autopilot Section */
.section { background: #161b22; border: 1px solid #30363d; border-radius: 3px; padding: 5px; margin-bottom: 4px; }
.section-title { color: #58a6ff; font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; border-bottom: 1px solid #21262d; padding-bottom: 2px; }

/* Phase Display */
.phase-display { text-align: center; margin-bottom: 4px; }
.phase-name { font-size: 14px; font-weight: bold; color: #58a6ff; display: block; margin-bottom: 3px; }
.phase-bar { background: #21262d; height: 3px; border-radius: 2px; overflow: hidden; margin-bottom: 3px; }
.phase-progress { background: linear-gradient(90deg, #3fb950, #58a6ff); height: 100%; width: 0%; transition: width 0.3s; }
.phase-targets { display: flex; justify-content: space-around; font-size: 9px; color: #8b949e; gap: 2px; }
.phase-targets .target { padding: 2px 4px; background: #21262d; border-radius: 2px; }

/* State Cards */
.cards { display: flex; flex-wrap: wrap; gap: 3px; }
.card { background: #161b22; border: 1px solid #30363d; border-radius: 3px; padding: 3px 5px; min-width: 60px; flex: 1; }
.card-label { color: #8b949e; font-size: 7px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1px; }
.card-val { font-size: 10px; font-weight: bold; color: #f0f6fc; }
.card-val.ok { color: #3fb950; }
.card-val.warn { color: #d29922; }
.card-val.err { color: #f85149; }

/* Controls */
.btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 3px; }
.btn { background: #21262d; border: 1px solid #30363d; color: #c9d1d9; border-radius: 2px; padding: 4px 6px; cursor: pointer; font-family: monospace; font-size: 9px; text-align: center; }
.btn:hover { background: #30363d; }
.btn.green { border-color: #3fb950; color: #3fb950; }
.btn.green:hover { background: #0d2a18; }
.btn.red { border-color: #f85149; color: #f85149; }
.btn.red:hover { background: #2a0d0d; }
.btn.blue { border-color: #58a6ff; color: #58a6ff; }
.btn.blue:hover { background: #0d2533; }
.btn.warn { border-color: #d29922; color: #d29922; }
.btn.warn:hover { background: #2a1f0d; }
.btn:disabled { opacity: 0.3; pointer-events: none; }

/* Input row */
.input-row { display: flex; align-items: center; gap: 4px; }
.input-row input { background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; border-radius: 2px; padding: 3px 5px; font-family: monospace; font-size: 9px; flex: 1; }
.input-unit { color: #8b949e; font-size: 8px; }
.status-text { font-size: 8px; color: #8b949e; margin-top: 3px; padding: 2px 4px; background: #0d1117; border-radius: 2px; text-align: center; }
.status-text.active { color: #3fb950; background: #0d2a18; }

/* Issues */
.issue { padding: 4px 6px; border-radius: 2px; margin-bottom: 3px; line-height: 1.3; font-size: 9px; }
.issue.ok { background: #0d2a18; border-left: 2px solid #3fb950; }
.issue.warn { background: #2a1f0d; border-left: 2px solid #d29922; }
.issue.err { background: #2a0d0d; border-left: 2px solid #f85149; }
.issue-code { font-size: 7px; color: #8b949e; margin-bottom: 1px; font-family: monospace; }

/* Toast */
#toast { position: fixed; bottom: 20px; right: 20px; background: #161b22; border: 1px solid #3fb950; border-radius: 6px; padding: 12px 16px; color: #3fb950; font-size: 12px; display: none; animation: slideIn 0.3s; }
@keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* Responsive */
@media (max-width: 1200px) {
    .cockpit-body { flex-direction: column; }
    .pane { border-right: none; border-bottom: 1px solid #30363d; max-height: 50vh; }
}
</style>
</head>
<body>

<div class="cockpit-container">
    <!-- Header -->
    <div class="cockpit-header">
        <div class="cockpit-title">
            ‚úàÔ∏è AI COCKPIT
            <span style="font-size: 11px; color: #8b949e; font-weight: normal;">Autopilot + Diagnostics</span>
        </div>
        <div class="header-controls">
            <div class="conn-dot" id="conn-status" title="Connection status"></div>
            <div class="lock-status" id="lock-status" title="Control ownership status">üîì</div>
            <button class="header-btn off" id="ai-toggle" title="Toggle Sally AI Autopilot on/off">SALLY OFF</button>
            <div class="phase-indicators">
                <span class="phase-chip" data-phase="PREFLIGHT">PRE</span>
                <span class="phase-chip" data-phase="TAXI">TAXI</span>
                <span class="phase-chip" data-phase="TAKEOFF">T/O</span>
                <span class="phase-chip" data-phase="CLIMB">CLB</span>
                <span class="phase-chip" data-phase="CRUISE">CRZ</span>
                <span class="phase-chip" data-phase="DESCENT">DES</span>
                <span class="phase-chip" data-phase="APPROACH">APP</span>
                <span class="phase-chip" data-phase="LANDING">LND</span>
            </div>
            <button class="header-btn" onclick="location.reload()" title="Reload cockpit page">üîÑ</button>
        </div>
    </div>

    <!-- Two-pane body -->
    <div class="cockpit-body">
        <!-- Left Pane: Autopilot Controls -->
        <div class="pane pane-left">
            <!-- Phase Display -->
            <div class="section">
                <div class="phase-display">
                    <span class="phase-name" id="phase-name">PREFLIGHT</span>
                    <div class="phase-bar">
                        <div class="phase-progress" id="phase-progress"></div>
                    </div>
                    <div class="phase-targets">
                        <span class="target" id="target-alt">--- ft</span>
                        <span class="target" id="target-spd">--- kt</span>
                        <span class="target" id="target-vs">--- fpm</span>
                    </div>
                </div>
            </div>

            <!-- State Cards -->
            <div class="section">
                <div class="section-title">Current State</div>
                <div class="cards" id="state-cards"></div>
            </div>

            <!-- Issues -->
            <div class="section" id="issues-section" style="display:none">
                <div class="section-title">Issues</div>
                <div id="issues"></div>
            </div>

            <!-- Flight Plan Control -->
            <div class="section">
                <div class="section-title">Flight Plan</div>
                <div class="btn-grid">
                    <button class="btn blue" onclick="importSimBrief()" title="Import flight plan from SimBrief">üì• SimBrief</button>
                    <button class="btn blue" onclick="importFromGTN750()" title="Import flight plan from GTN750Xi GPS">üó∫Ô∏è GTN750Xi</button>
                    <button class="btn red" onclick="clearFlightPlan()" title="Clear current flight plan and waypoints">üóëÔ∏è Clear</button>
                    <button class="btn" onclick="requestTaxi()" title="Request taxi clearance from ATC">üöï Taxi</button>
                    <button class="btn" onclick="clearedTakeoff()" title="Issue takeoff clearance">üõ´ T/O</button>
                </div>
            </div>

            <!-- AP Controls -->
            <div class="section">
                <div class="section-title">Autopilot Controls</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px;">
                    <!-- Cruise Alt -->
                    <div>
                        <div style="font-size: 7px; color: #8b949e; margin-bottom: 2px;">CRUISE ALT</div>
                        <div class="input-row">
                            <input type="number" id="cruise-alt" value="8500" min="1000" max="45000" step="500" style="width: 100%;" title="Target cruise altitude (1000-45000 ft)">
                            <span class="input-unit">ft</span>
                        </div>
                        <button class="btn blue" onclick="setCruiseAlt()" style="width: 100%; margin-top: 2px;" title="Set target cruise altitude for AI Autopilot">Set</button>
                    </div>
                    <!-- Heading -->
                    <div>
                        <div style="font-size: 7px; color: #8b949e; margin-bottom: 2px;">HEADING</div>
                        <div class="input-row">
                            <input type="number" id="heading-bug" value="360" min="0" max="360" step="1" style="width: 100%;" title="Heading bug (0-360¬∞)">
                            <span class="input-unit">¬∞</span>
                        </div>
                        <button class="btn blue" onclick="setHeading()" style="width: 100%; margin-top: 2px;" title="Set heading bug in autopilot">Set</button>
                    </div>
                    <!-- Speed -->
                    <div>
                        <div style="font-size: 7px; color: #8b949e; margin-bottom: 2px;">AI SPEED</div>
                        <div class="input-row">
                            <input type="number" id="target-speed" value="120" min="40" max="500" step="5" style="width: 100%;" title="Target airspeed (40-500 kt)">
                            <span class="input-unit">kt</span>
                        </div>
                        <button class="btn green" id="speed-toggle" onclick="toggleSpeedControl()" style="width: 100%; margin-top: 2px;" title="Enable AI auto-throttle to maintain target speed">Enable</button>
                    </div>
                </div>
                <div class="status-text" id="speed-status" style="margin-top: 4px;">Speed control disabled</div>
            </div>
        </div>

        <!-- Right Pane: Diagnostics & Tuning -->
        <div class="pane pane-right">
            <!-- Server Status -->
            <div class="section">
                <div class="section-title">Server Status</div>
                <div class="cards" id="server-cards"></div>
                <div class="btn-grid" style="margin-top: 8px">
                    <button class="btn warn" onclick="restartServer()" title="Restart SimGlass server">‚ü≥ Restart</button>
                    <button class="btn red" onclick="stopServer()" title="Stop SimGlass server">‚ñ† Stop</button>
                </div>
            </div>

            <!-- Sally Control -->
            <div class="section">
                <div class="section-title">Sally AI Control</div>
                <div class="btn-grid">
                    <button class="btn green" onclick="enableSally()" title="Enable Sally AI Autopilot">‚úì Enable</button>
                    <button class="btn red" onclick="disableSally()" title="Disable Sally AI Autopilot">‚úï Disable</button>
                    <button class="btn warn" onclick="clearATCGate()" title="Clear ATC gate hold (if stuck at runway)">Clear ATC Gate</button>
                    <button class="btn" onclick="resetLearning()" title="Reset all Sally learning data">Reset Learning</button>
                </div>
            </div>

            <!-- Force Phase -->
            <div class="section">
                <div class="section-title">Force Phase</div>
                <div class="btn-grid" id="phase-grid"></div>
            </div>

            <!-- Takeoff Tuning -->
            <div class="section">
                <div class="section-title">Takeoff Tuning</div>
                <div id="tuning-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 3px; margin-bottom: 4px;"></div>
                <div class="btn-grid">
                    <button class="btn green" onclick="applyAllTuning()">Apply All</button>
                    <button class="btn" onclick="loadTuning()">‚Üª Reload</button>
                </div>
            </div>

            <!-- Last Command -->
            <div class="section">
                <div class="section-title">Last Command</div>
                <div id="last-cmd" style="font-family: monospace; font-size: 11px; color: #8b949e;">---</div>
            </div>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
// Use current host for API and WebSocket (works with localhost and remote IP)
const BASE = window.location.origin;
let ws = null;
let tuningData = {};
let currentPhase = 'PREFLIGHT';

// Session management
const sessionId = 'cockpit-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
let isOwner = false;
let heartbeatTimer = null;
let lastManualToggle = 0; // Track manual button clicks

// Initialize
init();

async function init() {
    await registerSession();
    connectWebSocket();
    loadTuning();
    loadPhaseButtons();
    setInterval(updateTimestamp, 1000);
}

// Session Registration
async function registerSession() {
    try {
        const res = await fetch(BASE + '/api/ai-autopilot/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId, hostname: 'cockpit' })
        });

        if (res.ok) {
            const data = await res.json();
            isOwner = data.isOwner;
            console.log(`[Session] Registered - Owner: ${isOwner}`);

            // Start heartbeat
            if (heartbeatTimer) clearInterval(heartbeatTimer);
            heartbeatTimer = setInterval(sendHeartbeat, 5000);

            // Update UI to show ownership status
            updateOwnershipStatus();

            // Show user feedback if not owner
            if (!isOwner && data.ownerHostname) {
                showToast(`‚ö†Ô∏è Locked - ${data.ownerHostname} has control`, 'orange');
            }
        } else {
            console.error(`[Session] Registration failed: ${res.status}`);
            showToast('‚ö†Ô∏è Session registration failed', 'red');

            // Retry after 5 seconds
            setTimeout(registerSession, 5000);
        }
    } catch (e) {
        console.error('[Session] Registration error:', e);
        showToast('‚ö†Ô∏è Cannot connect to server', 'red');

        // Retry after 5 seconds
        setTimeout(registerSession, 5000);
    }
}

async function sendHeartbeat() {
    try {
        const res = await fetch(BASE + '/api/ai-autopilot/heartbeat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId, hostname: 'cockpit' })
        });

        if (res.ok) {
            const data = await res.json();
            if (data.isOwner !== isOwner) {
                isOwner = data.isOwner;
                updateOwnershipStatus();
            }
        }
    } catch (e) {
        // Heartbeat failed, but keep trying
    }
}

function updateOwnershipStatus() {
    const aiToggle = document.getElementById('ai-toggle');
    const lockStatus = document.getElementById('lock-status');

    // Null checks - elements might not exist yet
    if (!aiToggle || !lockStatus) {
        console.warn('[Session] UI elements not ready, will retry on next heartbeat');
        return;
    }

    if (!isOwner) {
        aiToggle.style.opacity = '0.5';
        aiToggle.title = 'Another page has control (locked)';
        lockStatus.textContent = 'üîí';
        lockStatus.classList.add('locked');
        lockStatus.title = 'Locked - Another page has control';
        console.log('[Session] Control locked by another page');
    } else {
        aiToggle.style.opacity = '1';
        aiToggle.title = 'Toggle Sally AI Autopilot on/off';
        lockStatus.textContent = 'üîì';
        lockStatus.classList.remove('locked');
        lockStatus.title = 'Unlocked - This page has control';
        console.log('[Session] This page has control');
    }
}

// Unregister on page unload
window.addEventListener('beforeunload', () => {
    if (heartbeatTimer) clearInterval(heartbeatTimer);
    navigator.sendBeacon(
        BASE + '/api/ai-autopilot/unregister',
        new Blob([JSON.stringify({ sessionId })], { type: 'application/json' })
    );
});

// WebSocket Connection
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}`;
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
        document.getElementById('conn-status').classList.add('ok');
    };

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            updateDisplay(data);
        } catch (e) {
            console.error('WebSocket parse error:', e);
        }
    };

    ws.onclose = () => {
        document.getElementById('conn-status').classList.remove('ok');
        setTimeout(connectWebSocket, 3000);
    };

    ws.onerror = () => {
        document.getElementById('conn-status').classList.remove('ok');
    };
}

// Update Display
function updateDisplay(data) {
    // Phase - check both data.phase and data.sallyState.currentPhase
    const phase = data.phase || data.currentPhase || data.sallyState?.currentPhase;
    if (phase) {
        currentPhase = phase;
        document.getElementById('phase-name').textContent = currentPhase;

        // Update header phase indicators
        document.querySelectorAll('.phase-chip').forEach(chip => {
            chip.classList.remove('active');
            if (chip.dataset.phase === currentPhase) {
                chip.classList.add('active');
            }
        });
    }

    // Phase progress (estimate based on altitude/speed)
    if (data.altitude && data.targetAltitude && data.targetAltitude > 0) {
        const progress = Math.min(100, (data.altitude / data.targetAltitude) * 100);
        document.getElementById('phase-progress').style.width = progress + '%';
    }

    // Targets
    document.getElementById('target-alt').textContent = data.targetAltitude ? `${Math.round(data.targetAltitude)} ft` : '--- ft';
    document.getElementById('target-spd').textContent = data.targetSpeed ? `${Math.round(data.targetSpeed)} kt` : '--- kt';
    document.getElementById('target-vs').textContent = data.verticalSpeed ? `${Math.round(data.verticalSpeed)} fpm` : '--- fpm';

    // Sally state toggle
    const aiToggle = document.getElementById('ai-toggle');
    // Don't override if manually toggled in last 2 seconds (prevents flicker)
    if (Date.now() - lastManualToggle < 2000) {
        // Skip WebSocket update, keep manual state
    } else {
        // Normal WebSocket-based update
        // Check both data.enabled and data.sallyState.enabled for compatibility
        const isEnabled = data.enabled || data.sallyState?.enabled;
        if (isEnabled) {
            aiToggle.textContent = 'SALLY ON';
            aiToggle.classList.remove('off');
            aiToggle.classList.add('active');
        } else {
            aiToggle.textContent = 'SALLY OFF';
            aiToggle.classList.remove('active');
            aiToggle.classList.add('off');
        }
    }

    // State cards
    updateStateCards(data);

    // Server cards
    updateServerCards(data.sallyState);

    // Issues
    updateIssues(data.sallyState?.issues || []);

    // Last command
    if (data.sallyState?.lastCommand) {
        document.getElementById('last-cmd').textContent = data.sallyState.lastCommand;
    }
}

// State Cards
function updateStateCards(data) {
    const cards = document.getElementById('state-cards');
    const metrics = [
        { label: 'Altitude', value: data.altitude ? `${Math.round(data.altitude)} ft` : '---', status: 'ok' },
        { label: 'Speed', value: data.groundSpeed ? `${Math.round(data.groundSpeed)} kt` : '---', status: 'ok' },
        { label: 'Heading', value: data.heading ? `${Math.round(data.heading)}¬∞` : '---', status: 'ok' },
        { label: 'V/S', value: data.verticalSpeed ? `${Math.round(data.verticalSpeed)} fpm` : '---', status: data.verticalSpeed > 0 ? 'ok' : 'warn' }
    ];

    cards.innerHTML = metrics.map(m => `
        <div class="card">
            <div class="card-label">${m.label}</div>
            <div class="card-val ${m.status}">${m.value}</div>
        </div>
    `).join('');
}

// Server Cards
function updateServerCards(sallyState) {
    const cards = document.getElementById('server-cards');
    if (!sallyState) return;

    const serverMetrics = [
        { label: 'Rule Engine', value: sallyState.ruleEngineOk ? 'OK' : 'DOWN', status: sallyState.ruleEngineOk ? 'ok' : 'err' },
        { label: 'Control Loop', value: sallyState.controlLoopActive ? 'ACTIVE' : 'IDLE', status: sallyState.controlLoopActive ? 'ok' : 'warn' }
    ];

    cards.innerHTML = serverMetrics.map(m => `
        <div class="card">
            <div class="card-label">${m.label}</div>
            <div class="card-val ${m.status}">${m.value}</div>
        </div>
    `).join('');
}

// Issues
function updateIssues(issues) {
    const issuesDiv = document.getElementById('issues');
    const section = document.getElementById('issues-section');

    if (!issues || issues.length === 0) {
        section.style.display = 'none';
        return;
    }

    section.style.display = 'block';
    issuesDiv.innerHTML = issues.map(issue => {
        const severity = issue.severity || 'warn';
        return `
            <div class="issue ${severity}">
                <div class="issue-code">${issue.code || 'ISSUE'}</div>
                ${issue.message || issue}
            </div>
        `;
    }).join('');
}

// API Helpers
async function api(method, endpoint, body = null) {
    try {
        const options = { method, headers: { 'Content-Type': 'application/json' } };

        // Include sessionId in request body for POST requests
        if (method === 'POST') {
            const requestBody = body ? { ...body, sessionId } : { sessionId };
            options.body = JSON.stringify(requestBody);
        } else if (body) {
            options.body = JSON.stringify(body);
        }

        const res = await fetch(BASE + endpoint, options);
        if (res.ok) {
            showToast('‚úì Success', 'green');
            return await res.json();
        } else if (res.status === 403) {
            const data = await res.json().catch(() => ({}));
            if (data.locked) {
                showToast(`‚úó Locked by ${data.ownerHostname}`, 'red');
            } else {
                showToast('‚úó Forbidden', 'red');
            }
            return null;
        } else {
            showToast('‚úó Error: ' + res.status, 'red');
            return null;
        }
    } catch (e) {
        showToast('‚úó Network Error', 'red');
        console.error(e);
        return null;
    }
}

// Flight Plan
async function importSimBrief() {
    await api('POST', '/api/ai-autopilot/simbrief-import');
}

async function importFromGTN750() {
    try {
        // Try both GTN750Xi and GTN750 localStorage keys
        const gtn750xiState = localStorage.getItem('gtn750xi_state');
        const gtn750State = localStorage.getItem('gtn750-state');
        const stateJson = gtn750xiState || gtn750State;

        if (!stateJson) {
            showToast('‚úó No GTN750 plan found', 'red');
            return;
        }

        const state = JSON.parse(stateJson);

        // Check if flight plan manager has waypoints
        if (!state.flightPlanManager?.waypoints || state.flightPlanManager.waypoints.length < 2) {
            showToast('‚úó No waypoints in GTN750', 'red');
            return;
        }

        // Convert GTN750 format to AI Autopilot format
        const flightPlan = {
            waypoints: state.flightPlanManager.waypoints.map(wp => ({
                ident: wp.ident || wp.name,
                lat: wp.lat || wp.latitude,
                lng: wp.lng || wp.lon || wp.longitude,
                type: wp.type || 'waypoint',
                altitude: wp.altitude || wp.alt,
                speed: wp.speed
            })),
            cruiseAltitude: state.flightPlanManager.cruiseAltitude || 8500,
            totalDistance: state.flightPlanManager.totalDistance || 0
        };

        // Send to AI Autopilot
        const result = await api('POST', '/api/ai-autopilot/execute-flight-plan', flightPlan);

        if (result) {
            showToast(`‚úì Imported ${flightPlan.waypoints.length} waypoints from GTN750`, 'green');
        }
    } catch (e) {
        console.error('GTN750 import error:', e);
        showToast('‚úó Import failed: ' + e.message, 'red');
    }
}

async function clearFlightPlan() {
    await api('POST', '/api/ai-autopilot/clear-plan');
}

async function requestTaxi() {
    await api('POST', '/api/ai-autopilot/request-taxi');
}

async function clearedTakeoff() {
    await api('POST', '/api/ai-autopilot/cleared-takeoff');
}

// Sally Control
async function enableSally() {
    const result = await api('POST', '/api/ai-autopilot/enable');
    if (result) {
        // Update button immediately (don't wait for WebSocket)
        lastManualToggle = Date.now();
        const aiToggle = document.getElementById('ai-toggle');
        aiToggle.textContent = 'SALLY ON';
        aiToggle.classList.remove('off');
        aiToggle.classList.add('active');
    }
}

async function disableSally() {
    const result = await api('POST', '/api/ai-autopilot/disable');
    if (result) {
        // Update button immediately (don't wait for WebSocket)
        lastManualToggle = Date.now();
        const aiToggle = document.getElementById('ai-toggle');
        aiToggle.textContent = 'SALLY OFF';
        aiToggle.classList.remove('active');
        aiToggle.classList.add('off');
    }
}

async function clearATCGate() {
    await api('POST', '/api/ai-autopilot/atc-deactivate');
}

async function resetLearning() {
    if (confirm('Reset all Sally learning data?')) {
        await api('POST', '/api/ai-pilot/reset-learning');
    }
}

// Cruise Altitude
async function setCruiseAlt() {
    const alt = parseInt(document.getElementById('cruise-alt').value);
    await api('POST', '/api/ai-autopilot/set-cruise-alt', { altitude: alt });
}

// Heading
async function setHeading() {
    const hdg = parseInt(document.getElementById('heading-bug').value);
    if (hdg < 0 || hdg > 360) {
        showToast('‚úó Heading must be 0-360', 'red');
        return;
    }
    await api('POST', '/api/command', { command: 'HEADING_BUG_SET', value: hdg });
}

// AI Speed Control
let speedControlEnabled = false;

async function toggleSpeedControl() {
    const targetSpeed = parseInt(document.getElementById('target-speed').value);
    if (targetSpeed < 40 || targetSpeed > 500) {
        showToast('‚úó Speed must be 40-500 kt', 'red');
        return;
    }

    speedControlEnabled = !speedControlEnabled;
    const btn = document.getElementById('speed-toggle');
    const status = document.getElementById('speed-status');

    if (speedControlEnabled) {
        btn.textContent = 'Disable';
        btn.classList.remove('green');
        btn.classList.add('red');
        status.textContent = `Speed control active - Target ${targetSpeed} kt`;
        status.classList.add('active');
        await api('POST', '/api/ai-autopilot/speed-control/enable', { targetSpeed });
    } else {
        btn.textContent = 'Enable';
        btn.classList.remove('red');
        btn.classList.add('green');
        status.textContent = 'Speed control disabled';
        status.classList.remove('active');
        await api('POST', '/api/ai-autopilot/speed-control/disable');
    }
}

// Server Control
async function restartServer() {
    await api('POST', '/api/ai-pilot/restart');
}

async function stopServer() {
    if (confirm('Stop Sally server?')) {
        await api('POST', '/api/ai-pilot/stop');
    }
}

// Phase Buttons
function loadPhaseButtons() {
    const phases = ['PREFLIGHT', 'TAXI', 'TAKEOFF', 'CLIMB', 'CRUISE', 'DESCENT', 'APPROACH', 'LANDING', 'TAXI_IN'];
    const grid = document.getElementById('phase-grid');

    grid.innerHTML = phases.map(phase => `
        <button class="btn" onclick="forcePhase('${phase}')">${phase}</button>
    `).join('');
}

async function forcePhase(phase) {
    await api('POST', '/api/ai-autopilot/force-phase', { phase });
}

// Tuning
async function loadTuning() {
    try {
        const res = await fetch(BASE + '/api/ai-pilot/tuning');
        tuningData = await res.json();
        renderTuning();
    } catch (e) {
        console.error('Load tuning error:', e);
    }
}

function renderTuning() {
    const grid = document.getElementById('tuning-grid');
    const keys = ['vr', 'v2', 'climbPitch', 'climbPower', 'rotateTime'];

    grid.innerHTML = keys.map(key => {
        const val = tuningData[key] || 0;
        return `
            <div style="background: #161b22; border: 1px solid #30363d; border-radius: 2px; padding: 3px 4px;">
                <div style="font-size: 7px; color: #8b949e; text-transform: uppercase; margin-bottom: 1px;">${key}</div>
                <input type="number" id="tune-${key}" value="${val}" step="0.1"
                       style="width: 100%; background: #0d1117; border: 1px solid #30363d; color: #c9d1d9;
                              border-radius: 2px; padding: 2px 3px; font-size: 9px; font-family: monospace;"
                       onchange="updateTuning('${key}', this.value)">
            </div>
        `;
    }).join('');
}

function updateTuning(key, value) {
    tuningData[key] = parseFloat(value);
}

async function applyAllTuning() {
    await api('POST', '/api/ai-pilot/update-tuning', tuningData);
}

// Toast
function showToast(msg, type = 'green') {
    const toast = document.getElementById('toast');
    const colors = {
        green: '#3fb950',
        red: '#f85149',
        orange: '#d29922'
    };
    const color = colors[type] || colors.green;

    toast.textContent = msg;
    toast.style.display = 'block';
    toast.style.borderColor = color;
    toast.style.color = color;
    setTimeout(() => toast.style.display = 'none', 3000);
}

// Timestamp
function updateTimestamp() {
    // Could add a timestamp display if needed
}

// Toggle buttons
document.getElementById('ai-toggle').onclick = function() {
    if (this.classList.contains('active')) {
        disableSally();
    } else {
        enableSally();
    }
};
</script>

</body>
</html>
