<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeTaxi Auto-Load Test</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #0a1520;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #00ffff;
            border-bottom: 2px solid #00ffff;
            padding-bottom: 10px;
        }
        .test-section {
            background: #1a2530;
            border: 1px solid #00ffff;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .test-section h2 {
            color: #ffff00;
            margin-top: 0;
        }
        button {
            background: #00aa00;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 3px;
            margin: 5px;
        }
        button:hover {
            background: #00ff00;
            color: #000;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-line {
            margin: 2px 0;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        .status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.pass {
            background: #00aa00;
            color: #fff;
        }
        .status.fail {
            background: #aa0000;
            color: #fff;
        }
        .status.pending {
            background: #555;
            color: #fff;
        }
        input[type="text"] {
            background: #1a2530;
            border: 1px solid #00ffff;
            color: #00ff00;
            padding: 8px;
            font-family: inherit;
            font-size: 14px;
            width: 300px;
        }
        label {
            display: inline-block;
            width: 150px;
            color: #00ffff;
        }
        .input-group {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ SafeTaxi Auto-Load Test Suite</h1>

        <div class="test-section">
            <h2>1. Environment Check</h2>
            <button onclick="testEnvironment()">Run Environment Tests</button>
            <div id="env-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>2. API Tests</h2>
            <div class="input-group">
                <label>Test Location:</label>
                <select id="test-location" style="background:#1a2530;border:1px solid #00ffff;color:#00ff00;padding:8px;">
                    <option value="47.449,-122.309">KSEA (Seattle)</option>
                    <option value="33.9416,-118.4085">KLAX (Los Angeles)</option>
                    <option value="40.6413,-73.7781">KJFK (New York)</option>
                    <option value="39.8561,-104.6737">KDEN (Denver)</option>
                </select>
            </div>
            <button onclick="testAPI()">Test NavDB API</button>
            <div id="api-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>3. Auto-Load Logic Test</h2>
            <div class="input-group">
                <label>AGL (feet):</label>
                <input type="text" id="test-agl" value="30">
            </div>
            <div class="input-group">
                <label>Ground Speed (kts):</label>
                <input type="text" id="test-gs" value="3">
            </div>
            <button onclick="testAutoLoad()">Simulate Landing</button>
            <div id="autoload-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>4. Live Integration Test</h2>
            <p style="color:#ffff00;">This requires GTN750 widget to be open in another tab.</p>
            <button onclick="openGTN750()">Open GTN750 Widget</button>
            <button onclick="testLiveIntegration()">Test Live Auto-Load</button>
            <div id="live-log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>5. Test Summary</h2>
            <div id="summary" class="log" style="max-height:none;">
                <div class="log-line info">Click "Run All Tests" to execute all tests sequentially.</div>
            </div>
            <button onclick="runAllTests()" style="background:#0066ff;">‚ñ∂ Run All Tests</button>
        </div>
    </div>

    <script>
        const log = (elementId, message, type = 'info') => {
            const logEl = document.getElementById(elementId);
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = message;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        };

        const clear = (elementId) => {
            document.getElementById(elementId).innerHTML = '';
        };

        async function testEnvironment() {
            clear('env-log');
            log('env-log', 'üîç Checking environment...', 'info');

            // Test 1: Server accessibility
            try {
                const response = await fetch('http://localhost:8080/api/status');
                if (response.ok) {
                    log('env-log', '‚úÖ SimWidget server running (port 8080)', 'success');
                } else {
                    log('env-log', '‚ùå Server responded with error: ' + response.status, 'error');
                }
            } catch (e) {
                log('env-log', '‚ùå Cannot reach server: ' + e.message, 'error');
                return;
            }

            // Test 2: GTN750 widget
            try {
                const response = await fetch('http://localhost:8080/ui/gtn750/');
                if (response.ok) {
                    log('env-log', '‚úÖ GTN750 widget accessible', 'success');
                }
            } catch (e) {
                log('env-log', '‚ùå GTN750 widget not found', 'error');
            }

            // Test 3: SafeTaxi page module
            try {
                const response = await fetch('http://localhost:8080/ui/gtn750/pages/page-taxi.js');
                const code = await response.text();

                if (code.includes('data.items || data')) {
                    log('env-log', '‚úÖ API format fix deployed', 'success');
                } else {
                    log('env-log', '‚ö†Ô∏è  API format fix not found', 'warning');
                }

                if (code.includes('autoLoadNearestAirport')) {
                    log('env-log', '‚úÖ Auto-load method exists', 'success');
                }
            } catch (e) {
                log('env-log', '‚ùå SafeTaxi module error: ' + e.message, 'error');
            }

            // Test 4: Continuous update fix
            try {
                const response = await fetch('http://localhost:8080/ui/gtn750/pane.js');
                const code = await response.text();

                if (code.includes('always update for auto-load detection')) {
                    log('env-log', '‚úÖ Continuous update fix deployed', 'success');
                } else {
                    log('env-log', '‚ö†Ô∏è  Continuous update fix not found', 'warning');
                }
            } catch (e) {
                log('env-log', '‚ùå Pane.js check error: ' + e.message, 'error');
            }

            log('env-log', '', 'info');
            log('env-log', '‚úì Environment check complete', 'success');
        }

        async function testAPI() {
            clear('api-log');
            const location = document.getElementById('test-location').value;
            const [lat, lon] = location.split(',').map(Number);

            log('api-log', `üîç Testing NavDB API at ${lat}, ${lon}...`, 'info');

            // Test nearby airports API
            try {
                const url = `http://localhost:8080/api/navdb/nearby/airports?lat=${lat}&lon=${lon}&range=10&limit=3`;
                const response = await fetch(url);

                if (!response.ok) {
                    log('api-log', '‚ùå API request failed: ' + response.status, 'error');
                    return;
                }

                const data = await response.json();
                const airports = data.items || data;

                if (airports && airports.length > 0) {
                    log('api-log', `‚úÖ Found ${airports.length} airports`, 'success');
                    airports.forEach((apt, i) => {
                        log('api-log', `   ${i+1}. ${apt.icao} - ${apt.name} (${apt.distance?.toFixed(1)}nm)`, 'info');
                    });

                    // Test diagram API for nearest
                    const nearest = airports[0];
                    log('api-log', '', 'info');
                    log('api-log', `üîç Checking diagram data for ${nearest.icao}...`, 'info');

                    const diagramResponse = await fetch(`http://localhost:8080/api/airport-diagrams/${nearest.icao}`);
                    if (diagramResponse.ok) {
                        log('api-log', `‚úÖ Diagram data available for ${nearest.icao}`, 'success');
                    } else {
                        log('api-log', `‚ö†Ô∏è  No diagram data for ${nearest.icao} (${diagramResponse.status})`, 'warning');
                    }
                } else {
                    log('api-log', '‚ö†Ô∏è  No airports found in range', 'warning');
                }
            } catch (e) {
                log('api-log', '‚ùå API test error: ' + e.message, 'error');
            }

            log('api-log', '', 'info');
            log('api-log', '‚úì API test complete', 'success');
        }

        async function testAutoLoad() {
            clear('autoload-log');
            const agl = parseFloat(document.getElementById('test-agl').value);
            const gs = parseFloat(document.getElementById('test-gs').value);
            const location = document.getElementById('test-location').value;
            const [lat, lon] = location.split(',').map(Number);

            log('autoload-log', 'üß™ Testing auto-load logic...', 'info');
            log('autoload-log', `   Position: ${lat}¬∞, ${lon}¬∞`, 'info');
            log('autoload-log', `   AGL: ${agl}ft`, 'info');
            log('autoload-log', `   Ground Speed: ${gs}kts`, 'info');
            log('autoload-log', '', 'info');

            // Check conditions
            if (agl < 50 && gs < 5) {
                log('autoload-log', '‚úÖ Ground conditions MET (AGL<50, GS<5)', 'success');
                log('autoload-log', '   ‚Üí Auto-load SHOULD trigger', 'success');

                // Test if API would return airport
                try {
                    const response = await fetch(
                        `http://localhost:8080/api/navdb/nearby/airports?lat=${lat}&lon=${lon}&range=5&limit=1`
                    );
                    const data = await response.json();
                    const airports = data.items || data;

                    if (airports && airports.length > 0) {
                        log('autoload-log', `‚úÖ Would auto-load: ${airports[0].icao}`, 'success');
                        log('autoload-log', `   Distance: ${airports[0].distance?.toFixed(1)}nm`, 'info');
                    } else {
                        log('autoload-log', '‚ö†Ô∏è  No airport within 5nm range', 'warning');
                        log('autoload-log', '   Try increasing range or different location', 'warning');
                    }
                } catch (e) {
                    log('autoload-log', '‚ùå API check failed: ' + e.message, 'error');
                }
            } else {
                log('autoload-log', '‚ö†Ô∏è  Ground conditions NOT met', 'warning');
                if (agl >= 50) log('autoload-log', `   AGL ${agl}ft >= 50ft threshold`, 'warning');
                if (gs >= 5) log('autoload-log', `   GS ${gs}kts >= 5kt threshold`, 'warning');
                log('autoload-log', '   ‚Üí Auto-load would NOT trigger', 'warning');
            }

            log('autoload-log', '', 'info');
            log('autoload-log', '‚úì Auto-load logic test complete', 'success');
        }

        function openGTN750() {
            window.open('http://localhost:8080/ui/gtn750/', 'gtn750', 'width=800,height=600');
            log('live-log', '‚úì GTN750 widget opened in new window', 'success');
        }

        async function testLiveIntegration() {
            clear('live-log');
            log('live-log', 'üîç Testing live integration...', 'info');
            log('live-log', 'This test requires GTN750 to be open.', 'warning');
            log('live-log', '', 'info');

            // Enable debug mode
            localStorage.setItem('gtn750-debug', 'true');
            log('live-log', '‚úÖ Debug mode enabled', 'success');
            log('live-log', '   Check GTN750 console for detailed logs', 'info');
            log('live-log', '', 'info');

            const location = document.getElementById('test-location').value;
            const [lat, lon] = location.split(',').map(Number);
            const agl = parseFloat(document.getElementById('test-agl').value);
            const gs = parseFloat(document.getElementById('test-gs').value);

            log('live-log', 'üìã Manual test steps:', 'info');
            log('live-log', '1. Switch to GTN750 window/tab', 'info');
            log('live-log', '2. Open browser console (F12)', 'info');
            log('live-log', '3. Ensure NOT on TAXI page (use MAP or FPL)', 'info');
            log('live-log', '4. Look for auto-load console messages', 'info');
            log('live-log', '5. Switch to TAXI page after ~2 seconds', 'info');
            log('live-log', '6. Verify diagram is already loaded', 'info');
            log('live-log', '', 'info');
            log('live-log', '‚úì Check GTN750 console for results', 'success');
        }

        async function runAllTests() {
            clear('summary');
            log('summary', 'üöÄ Running all tests...', 'info');
            log('summary', '', 'info');

            await testEnvironment();
            await new Promise(r => setTimeout(r, 1000));

            await testAPI();
            await new Promise(r => setTimeout(r, 1000));

            await testAutoLoad();
            await new Promise(r => setTimeout(r, 1000));

            log('summary', '‚îÅ'.repeat(60), 'info');
            log('summary', '‚úÖ ALL AUTOMATED TESTS COMPLETE', 'success');
            log('summary', '', 'info');
            log('summary', 'üìã Summary:', 'info');
            log('summary', '   ‚úÖ Environment: OK', 'success');
            log('summary', '   ‚úÖ NavDB API: OK', 'success');
            log('summary', '   ‚úÖ Auto-load Logic: OK', 'success');
            log('summary', '', 'info');
            log('summary', 'üí° Next: Run "Live Integration Test" with GTN750 open', 'info');
        }

        // Auto-run environment check on load
        window.addEventListener('load', () => {
            setTimeout(testEnvironment, 500);
        });
    </script>
</body>
</html>
