<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminal Hub - Hive</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #0c0c14;
            --bg-panel: #12121c;
            --bg-terminal: #0a0a10;
            --cyan: #00f0ff;
            --green: #00ff88;
            --amber: #ffaa00;
            --red: #ff4466;
            --text: #e0e0e0;
            --text-dim: #666;
            --border: rgba(0, 240, 255, 0.2);
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, #0a1520, #1a0a20);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 18px;
            color: var(--cyan);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1::before {
            content: '>';
            color: var(--green);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: rgba(0, 240, 255, 0.1);
            color: var(--cyan);
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: rgba(0, 240, 255, 0.2);
            border-color: var(--cyan);
        }

        .btn-new {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.3);
            color: var(--green);
        }

        .btn-new:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: var(--green);
        }

        /* Main Layout */
        .main {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        /* Terminal List Sidebar */
        .sidebar {
            width: 220px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-tab:hover {
            color: var(--text);
            background: rgba(0, 240, 255, 0.05);
        }

        .sidebar-tab.active {
            color: var(--cyan);
            border-bottom: 2px solid var(--cyan);
        }

        .sidebar-header {
            padding: 12px 15px;
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
        }

        .process-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .process-item {
            padding: 8px 10px;
            margin-bottom: 6px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 12px;
        }

        .process-item:hover {
            border-color: var(--border);
        }

        .process-name {
            font-weight: bold;
            color: var(--text);
            margin-bottom: 4px;
        }

        .process-info {
            display: flex;
            gap: 10px;
            font-size: 10px;
            color: var(--text-dim);
        }

        .process-info span {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .process-title {
            font-size: 11px;
            color: var(--cyan);
            margin-top: 6px;
            padding: 4px 6px;
            background: rgba(0, 240, 255, 0.1);
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .process-title.empty {
            color: var(--text-dim);
            background: rgba(255, 255, 255, 0.05);
            font-style: italic;
        }

        .process-filter {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-dim);
        }

        .process-filter input[type="checkbox"] {
            accent-color: var(--cyan);
        }

        .process-actions {
            margin-top: 6px;
        }

        .process-actions .btn {
            padding: 3px 8px;
            font-size: 10px;
        }

        .terminal-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .terminal-item {
            padding: 10px 12px;
            margin-bottom: 6px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .terminal-item:hover {
            border-color: var(--border);
            background: rgba(0, 240, 255, 0.05);
        }

        .terminal-item.active {
            border-color: var(--cyan);
            background: rgba(0, 240, 255, 0.1);
        }

        .terminal-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .terminal-item-title {
            font-size: 13px;
            font-weight: bold;
            color: var(--text);
        }

        .terminal-item-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }

        .terminal-item-status.dead {
            background: var(--red);
        }

        .terminal-item-info {
            font-size: 10px;
            color: var(--text-dim);
        }

        .terminal-item-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .terminal-item-actions .btn {
            padding: 4px 8px;
            font-size: 11px;
        }

        .btn-kill {
            background: rgba(255, 68, 102, 0.1);
            border-color: rgba(255, 68, 102, 0.3);
            color: var(--red);
        }

        .btn-kill:hover {
            background: rgba(255, 68, 102, 0.2);
            border-color: var(--red);
        }

        /* Terminal Area */
        .terminal-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .terminal-tabs {
            display: flex;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            flex-shrink: 0;
        }

        .terminal-tab {
            padding: 10px 20px;
            font-size: 12px;
            color: var(--text-dim);
            border-right: 1px solid var(--border);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .terminal-tab:hover {
            color: var(--text);
            background: rgba(0, 240, 255, 0.05);
        }

        .terminal-tab.active {
            color: var(--cyan);
            background: var(--bg-terminal);
            border-bottom: 2px solid var(--cyan);
        }

        .terminal-tab {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-close {
            opacity: 0.5;
            font-size: 14px;
            line-height: 1;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .tab-close:hover {
            opacity: 1;
            background: rgba(255, 68, 102, 0.3);
            color: var(--red);
        }

        .wt-badge {
            font-size: 9px;
            padding: 2px 5px;
            background: rgba(0, 255, 136, 0.2);
            color: var(--green);
            border-radius: 3px;
            margin-left: 6px;
        }

        .btn-wt {
            background: rgba(138, 43, 226, 0.1);
            border-color: rgba(138, 43, 226, 0.3);
            color: #9966ff;
        }

        .btn-wt:hover {
            background: rgba(138, 43, 226, 0.2);
            border-color: #9966ff;
        }

        .terminal-output {
            flex: 1;
            background: var(--bg-terminal);
            padding: 15px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .terminal-output span {
            display: inline;
        }

        .terminal-output::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-output::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        .terminal-output::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        /* Input Area */
        .terminal-input-area {
            display: flex;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            padding: 10px 15px;
            gap: 10px;
            flex-shrink: 0;
        }

        .terminal-input-area input {
            flex: 1;
            background: var(--bg-terminal);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px 15px;
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }

        .terminal-input-area input:focus {
            border-color: var(--cyan);
        }

        .terminal-input-area input::placeholder {
            color: var(--text-dim);
        }

        .btn-send {
            padding: 10px 20px;
            background: var(--cyan);
            color: var(--bg-dark);
            border: none;
            font-weight: bold;
        }

        .btn-send:hover {
            background: #00d0e0;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            color: var(--cyan);
            font-size: 16px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-terminal);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .shell-options {
            display: flex;
            gap: 10px;
        }

        .shell-btn {
            flex: 1;
            padding: 12px 10px;
            background: var(--bg-terminal);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .shell-btn:hover {
            border-color: var(--cyan);
        }

        .shell-btn.active {
            border-color: var(--cyan);
            background: rgba(0, 240, 255, 0.1);
        }

        .shell-icon {
            font-size: 20px;
        }

        .shell-btn span:last-child {
            font-size: 11px;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-dim);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: left 0.3s;
                width: 250px;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
            }

            .sidebar-overlay.open {
                display: block;
            }

            .header h1 {
                font-size: 16px;
            }

            .btn-menu {
                display: flex;
            }

            .terminal-output {
                font-size: 12px;
                padding: 10px;
            }

            .terminal-input-area {
                padding: 8px 10px;
            }

            .terminal-input-area input {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        @media (min-width: 769px) {
            .btn-menu {
                display: none;
            }
        }

        /* Safe area support */
        @supports (padding-top: env(safe-area-inset-top)) {
            .header {
                padding-top: calc(12px + env(safe-area-inset-top));
            }
            .terminal-input-area {
                padding-bottom: calc(10px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <button class="btn btn-menu" onclick="toggleSidebar()">☰</button>
            Terminal Hub
        </h1>
        <div class="header-actions">
            <button class="btn btn-new" onclick="createTerminal()">+ New</button>
            <button class="btn" onclick="createWTTerminal()" title="Open in Windows Terminal">+ WT</button>
            <button class="btn" onclick="refreshList()">↻</button>
        </div>
    </div>

    <!-- New Terminal Modal -->
    <div class="modal-overlay" id="newTermModal" onclick="closeNewTermModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>New Terminal</h3>
                <button class="modal-close" onclick="closeNewTermModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Shell Type</label>
                    <div class="shell-options">
                        <button class="shell-btn active" data-shell="powershell" onclick="selectShell(this)">
                            <span class="shell-icon">⚡</span>
                            <span>PowerShell</span>
                        </button>
                        <button class="shell-btn" data-shell="cmd" onclick="selectShell(this)">
                            <span class="shell-icon">▶</span>
                            <span>CMD</span>
                        </button>
                        <button class="shell-btn" data-shell="bash" onclick="selectShell(this)">
                            <span class="shell-icon">$</span>
                            <span>Git Bash</span>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Name (optional)</label>
                    <input type="text" id="newTermName" placeholder="Terminal name...">
                </div>
                <div class="form-group">
                    <label>Working Directory</label>
                    <input type="text" id="newTermCwd" value="C:\LLM-DevOSWE">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeNewTermModal()">Cancel</button>
                <button class="btn btn-new" onclick="submitNewTerminal()">Create</button>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div class="sidebar">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" onclick="showSidebarTab('terminals')">Terminals</button>
                <button class="sidebar-tab" onclick="showSidebarTab('processes')">Apps</button>
            </div>
            <div class="terminal-list" id="terminalList">
                <!-- Terminal items will be added here -->
            </div>
            <div class="process-list" id="processList" style="display:none;">
                <!-- Process items will be rendered here -->
            </div>
        </div>

        <div class="terminal-container">
            <div class="terminal-tabs" id="terminalTabs">
                <!-- Tabs will be added here -->
            </div>
            <div class="terminal-output" id="terminalOutput">
                <div class="empty-state">
                    <div class="empty-state-icon">⌨</div>
                    <div>Select or create a terminal to begin</div>
                </div>
            </div>
            <div class="terminal-input-area">
                <button class="btn" onclick="clearOutput()" title="Clear screen">CLR</button>
                <button class="btn btn-kill" id="btnInterrupt" onclick="sendInterrupt()" title="Send Ctrl+C" style="display:none">⏹ STOP</button>
                <input type="text" id="terminalInput" placeholder="Type command and press Enter..." onkeydown="handleInput(event)" autocomplete="off" autocapitalize="off" spellcheck="false">
                <button class="btn btn-send" onclick="sendCommand()">Send</button>
            </div>
        </div>
    </div>

    <script src="mobile-engine.js"></script>
    <script>
        const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const API_BASE = `${location.protocol}//${location.host}`;
        const WS_BASE = `${wsProtocol}//${location.host}`;

        let terminals = [];
        let activeTerminal = null;
        let ws = null;

        // Fetch terminal list
        async function refreshList() {
            try {
                const resp = await fetch(`${API_BASE}/api/terminals`);
                terminals = await resp.json();
                renderTerminalList();
                renderTabs();
            } catch (e) {
                console.error('Failed to fetch terminals:', e);
            }
        }

        // Render terminal list in sidebar
        function renderTerminalList() {
            const list = document.getElementById('terminalList');
            if (terminals.length === 0) {
                list.innerHTML = '<div style="padding: 20px; color: var(--text-dim); text-align: center;">No terminals</div>';
                return;
            }

            list.innerHTML = terminals.map(t => `
                <div class="terminal-item ${activeTerminal === t.id ? 'active' : ''}" onclick="selectTerminal(${t.id})">
                    <div class="terminal-item-header">
                        <span class="terminal-item-title">${escapeHtml(t.title)}${t.isWT ? '<span class="wt-badge">WT</span>' : ''}</span>
                        <span class="terminal-item-status ${t.running ? '' : 'dead'}"></span>
                    </div>
                    <div class="terminal-item-info">ID: ${t.id} • ${t.clients} connected${t.isWT ? ' • Windows Terminal' : ''}</div>
                    <div class="terminal-item-actions">
                        <button class="btn btn-kill" onclick="event.stopPropagation(); killTerminal(${t.id})">Kill</button>
                    </div>
                </div>
            `).join('');
        }

        // Render tabs
        function renderTabs() {
            const tabs = document.getElementById('terminalTabs');
            tabs.innerHTML = terminals.map(t => `
                <div class="terminal-tab ${activeTerminal === t.id ? 'active' : ''}" onclick="selectTerminal(${t.id})">
                    <span>${escapeHtml(t.title)}${t.isWT ? '<span class="wt-badge">WT</span>' : ''}</span>
                    <span class="tab-close" onclick="event.stopPropagation(); killTerminal(${t.id})" title="Close terminal">×</span>
                </div>
            `).join('');
        }

        // Select terminal
        function selectTerminal(id) {
            if (activeTerminal === id) return;

            // Close existing connection
            if (ws) {
                ws.close();
                ws = null;
            }

            activeTerminal = id;
            renderTerminalList();
            renderTabs();

            // Clear output
            const output = document.getElementById('terminalOutput');
            output.innerHTML = '';

            // Connect to terminal
            updateStatus('connecting', 'Connecting...');
            ws = new WebSocket(`${WS_BASE}/?id=${id}`);

            ws.onopen = () => {
                console.log(`Connected to terminal ${id}`);
                updateStatus('connected', 'Connected');
                // Request current buffer
                appendOutput('[Connected to terminal]\n');
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'output') {
                        appendOutput(msg.data);
                    } else if (msg.type === 'exit') {
                        appendOutput(`\n[Process exited with code ${msg.code}]\n`);
                        updateStatus('disconnected', 'Exited');
                        refreshList();
                    } else if (msg.type === 'error') {
                        appendOutput(`[Error: ${msg.message}]\n`);
                        updateStatus('error', 'Error');
                    }
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };

            ws.onclose = () => {
                console.log(`Disconnected from terminal ${id}`);
                updateStatus('disconnected', 'Disconnected');
            };

            ws.onerror = (e) => {
                console.error('WebSocket error:', e);
                updateStatus('error', 'Connection Error');
            };

            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                toggleSidebar(false);
            }

            // Focus input
            document.getElementById('terminalInput').focus();
        }

        // Append output to terminal
        function appendOutput(text) {
            const output = document.getElementById('terminalOutput');

            // Strip ANSI escape codes
            let clean = text.replace(/\x1b\[[0-9;]*[a-zA-Z]/g, '');

            // Create text node to preserve whitespace
            const span = document.createElement('span');
            span.textContent = clean;
            output.appendChild(span);

            // Auto-scroll to bottom
            output.scrollTop = output.scrollHeight;

            // Update status
            updateStatus('connected', 'Receiving...');
        }

        // Update connection status
        function updateStatus(state, text) {
            let status = document.getElementById('connStatus');
            if (!status) {
                status = document.createElement('div');
                status.id = 'connStatus';
                status.style.cssText = 'position:fixed;top:60px;right:10px;padding:6px 12px;border-radius:4px;font-size:11px;z-index:999;';
                document.body.appendChild(status);
            }
            status.textContent = text || state;
            status.style.background = state === 'connected' ? 'var(--green)' :
                                      state === 'connecting' ? 'var(--amber)' : 'var(--red)';
            status.style.color = '#000';
        }

        // Clear terminal output
        function clearOutput() {
            document.getElementById('terminalOutput').innerHTML = '';
        }

        // Handle input
        function handleInput(event) {
            if (event.key === 'Enter') {
                sendCommand();
            }
        }

        // Send command
        function sendCommand() {
            const input = document.getElementById('terminalInput');
            const cmd = input.value;

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Not connected to a terminal');
                return;
            }

            // Send with newline (Enter)
            ws.send(JSON.stringify({ type: 'input', data: cmd + '\r\n' }));
            input.value = '';

            // Show interrupt button when command is sent
            document.getElementById('btnInterrupt').style.display = '';
        }

        // Send interrupt (Ctrl+C)
        function sendInterrupt() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }
            ws.send(JSON.stringify({ type: 'interrupt' }));
            document.getElementById('btnInterrupt').style.display = 'none';
        }

        // Cancel via API (for external use)
        async function cancelCommand() {
            if (!activeTerminal) return;
            try {
                await fetch(`${API_BASE}/api/terminals/${activeTerminal}/cancel`, { method: 'POST' });
                document.getElementById('btnInterrupt').style.display = 'none';
            } catch (e) {
                console.error('Failed to cancel:', e);
            }
        }

        // New terminal modal
        let selectedShell = 'powershell';

        function createTerminal() {
            document.getElementById('newTermModal').classList.add('open');
            document.getElementById('newTermName').value = '';
            document.getElementById('newTermCwd').value = 'C:\\LLM-DevOSWE';
        }

        function closeNewTermModal(event) {
            if (!event || event.target.classList.contains('modal-overlay')) {
                document.getElementById('newTermModal').classList.remove('open');
            }
        }

        function selectShell(btn) {
            document.querySelectorAll('.shell-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedShell = btn.dataset.shell;
        }

        async function submitNewTerminal() {
            const name = document.getElementById('newTermName').value || `${selectedShell.charAt(0).toUpperCase() + selectedShell.slice(1)} ${terminals.length + 1}`;
            const cwd = document.getElementById('newTermCwd').value || 'C:\\LLM-DevOSWE';

            try {
                const resp = await fetch(`${API_BASE}/api/terminals`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: name, cwd, shell: selectedShell })
                });
                const data = await resp.json();
                closeNewTermModal();
                await refreshList();
                if (data.id) selectTerminal(data.id);
            } catch (e) {
                alert('Failed to create terminal: ' + e.message);
            }
        }

        // Create terminal in Windows Terminal
        async function createWTTerminal() {
            const shell = prompt('Shell type (powershell, cmd, bash):', 'powershell') || 'powershell';
            const name = prompt('Terminal name:', `WT ${shell}`) || `WT ${shell}`;
            const cwd = prompt('Working directory:', 'C:\\LLM-DevOSWE') || 'C:\\LLM-DevOSWE';

            try {
                const resp = await fetch(`${API_BASE}/api/terminals/wt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: name, cwd, shell })
                });
                const data = await resp.json();
                if (data.error) {
                    alert('Failed: ' + data.error);
                    return;
                }
                await refreshList();
                if (data.id) {
                    selectTerminal(data.id);
                    alert(`Windows Terminal tab opened!\n\nTerminal ID: ${data.id}\nThe tab will appear in your taskbar.`);
                }
            } catch (e) {
                alert('Failed to create WT terminal: ' + e.message);
            }
        }

        // Kill terminal
        async function killTerminal(id) {
            if (!confirm('Kill this terminal?')) return;

            try {
                await fetch(`${API_BASE}/api/terminals/${id}`, { method: 'DELETE' });
                if (activeTerminal === id) {
                    activeTerminal = null;
                    if (ws) {
                        ws.close();
                        ws = null;
                    }
                    document.getElementById('terminalOutput').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">⌨</div>
                            <div>Select or create a terminal to begin</div>
                        </div>
                    `;
                }
                await refreshList();
            } catch (e) {
                alert('Failed to kill terminal: ' + e.message);
            }
        }

        // Toggle sidebar (mobile)
        function toggleSidebar(force) {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const isOpen = force !== undefined ? force : !sidebar.classList.contains('open');

            sidebar.classList.toggle('open', isOpen);
            overlay.classList.toggle('open', isOpen);
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Sidebar tab switching
        function showSidebarTab(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.sidebar-tab[onclick*="${tab}"]`).classList.add('active');

            document.getElementById('terminalList').style.display = tab === 'terminals' ? 'block' : 'none';
            document.getElementById('processList').style.display = tab === 'processes' ? 'block' : 'none';

            if (tab === 'processes') {
                refreshProcesses();
            }
        }

        // Fetch running processes
        let processes = [];
        async function refreshProcesses() {
            try {
                const resp = await fetch(`${API_BASE}/api/processes`);
                processes = await resp.json();
                renderProcessList();
            } catch (e) {
                console.error('Failed to fetch processes:', e);
            }
        }

        // Render process list
        function renderProcessList() {
            const list = document.getElementById('processList');
            const filterCheckbox = document.getElementById('filterWindowed');
            const filterWindowed = filterCheckbox ? filterCheckbox.checked : false;

            // Filter processes
            let filtered = processes;
            if (filterWindowed) {
                filtered = processes.filter(p => p.title && p.title.trim().length > 0);
            }

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="process-filter">
                        <input type="checkbox" id="filterWindowed" ${filterWindowed ? 'checked' : ''} onchange="refreshProcesses()">
                        <label for="filterWindowed">Only apps with windows</label>
                    </div>
                    <div style="padding: 20px; color: var(--text-dim); text-align: center;">No processes found</div>
                `;
                return;
            }

            list.innerHTML = `
                <div class="process-filter">
                    <input type="checkbox" id="filterWindowed" ${filterWindowed ? 'checked' : ''} onchange="renderProcessList()">
                    <label for="filterWindowed">Only apps with windows</label>
                </div>
            ` + filtered.map(p => `
                <div class="process-item">
                    <div class="process-name">${escapeHtml(p.name)}</div>
                    <div class="process-info">
                        <span>PID: ${p.pid}</span>
                        <span>CPU: ${p.cpu}%</span>
                        <span>RAM: ${p.memory}MB</span>
                    </div>
                    <div class="process-title ${p.title ? '' : 'empty'}">${p.title ? escapeHtml(p.title) : '(no window title)'}</div>
                    <div class="process-actions">
                        <button class="btn" onclick="runInTerminal('${escapeHtml(p.name)}', ${p.pid})">Attach</button>
                        <button class="btn btn-kill" onclick="killProcess(${p.pid}, '${escapeHtml(p.name)}')">Kill</button>
                    </div>
                </div>
            `).join('');
        }

        // Attach to a process (create monitor terminal)
        async function runInTerminal(name, pid) {
            try {
                const resp = await fetch(`${API_BASE}/api/processes/attach`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pid, name })
                });
                const data = await resp.json();
                if (data.id) {
                    await refreshList();
                    selectTerminal(data.id);
                    // Switch to terminals tab
                    showSidebarTab('terminals');
                }
            } catch (e) {
                alert('Failed to attach: ' + e.message);
            }
        }

        // Kill a process
        async function killProcess(pid, name) {
            if (!confirm(`Kill process ${name} (PID: ${pid})?`)) return;

            try {
                await fetch(`${API_BASE}/api/processes/kill`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pid })
                });
                await refreshProcesses();
            } catch (e) {
                alert('Failed to kill process: ' + e.message);
            }
        }

        // Initialize
        refreshList();

        // Auto-refresh every 10 seconds
        setInterval(refreshList, 10000);

        // Auto-select first terminal if available
        setTimeout(() => {
            if (terminals.length > 0 && !activeTerminal) {
                selectTerminal(terminals[0].id);
            }
        }, 500);
    </script>
</body>
</html>
