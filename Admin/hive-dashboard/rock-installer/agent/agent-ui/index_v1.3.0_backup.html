<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SimWidget Agent - Kitt v1.3.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #1a1a2e;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #333;
        }
        .header h1 { font-size: 18px; font-weight: 600; }
        .kitt-status { font-size: 14px; margin-left: 8px; transition: all 0.3s ease; }
        .kitt-status.busy { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .btn-logs { background: #2a2a3e; border: none; color: #ccc; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .btn-logs:hover { background: #4a9eff; color: #fff; }
        .btn-menu, .btn-services, .btn-refresh {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            color: #888;
            transition: all 0.2s;
        }
        .btn-menu { font-size: 20px; }
        .btn-menu:hover, .btn-services:hover, .btn-refresh:hover { color: #4a9eff; }
        .btn-refresh.spinning { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .header-right { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        .header-cost { background: #1a3a1a; color: #22c55e; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; cursor: pointer; }
        .header-cost:hover { background: #22c55e; color: #000; }
        .btn-todo { background: #2a2a3e; border: none; color: #ccc; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .btn-todo:hover { background: #4a9eff; color: #fff; }
        .status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #ff4444;
            cursor: pointer;
        }
        .status.connected { background: #44aa44; }
        .status.busy { background: #eab308; color: #000; }
        .compact-status { display: flex; gap: 6px; margin-right: 8px; align-items: center; }
        .compact-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        .compact-dot.online { background: #10b981; box-shadow: 0 0 4px rgba(16,185,129,0.4); }
        .compact-dot.offline { background: #ef4444; box-shadow: 0 0 6px rgba(239,68,68,0.6); }
        .compact-dot.checking { background: #eab308; animation: pulse 1s infinite; }
        .header-cost { 
            font-size: 12px; color: #22c55e; cursor: pointer; margin-left: 4px;
            padding: 2px 6px; background: rgba(34,197,94,0.1); border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
        }
        .header-cost:hover { background: rgba(34,197,94,0.2); }
        .header-cost.cost-changed {
            animation: costPulse 0.6s ease;
            background: rgba(34,197,94,0.4);
        }
        .cost-delta {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #ff6b6b;
            background: rgba(255,107,107,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            animation: deltaFade 2s ease forwards;
        }
        @keyframes costPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); background: rgba(34,197,94,0.5); }
            100% { transform: scale(1); }
        }
        @keyframes deltaFade {
            0% { opacity: 1; transform: translateX(-50%) translateY(0); }
            70% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }

        /* Overlays & Panels */
        .overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 100;
        }
        .overlay.active { display: block; }
        .admin-menu, .services-panel {
            position: fixed; top: 0; width: 300px; height: 100%;
            background: #1a1a2e; z-index: 101;
            transition: all 0.3s ease;
            display: flex; flex-direction: column;
        }
        .admin-menu { left: -320px; border-right: 1px solid #333; }
        .admin-menu.active { left: 0; }
        .services-panel { right: -320px; border-left: 1px solid #333; }
        .services-panel.active { right: 0; }
        .admin-header, .services-header, .log-header {
            padding: 16px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .admin-header h2, .services-header h2, .log-header h2 { font-size: 16px; font-weight: 600; }
        .btn-close { background: none; border: none; color: #888; font-size: 20px; cursor: pointer; }
        .btn-close:hover { color: #fff; }
        .admin-content, .services-content { flex: 1; padding: 16px; overflow-y: auto; }
        .section-label { font-size: 10px; font-weight: 600; color: #666; letter-spacing: 1px; margin-bottom: 12px; }
        .admin-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .admin-btn {
            background: #2a2a3e; border: 1px solid #333; color: #ccc;
            padding: 10px 14px 18px 14px; border-radius: 8px; font-size: 13px; cursor: pointer;
            position: relative; flex: 0 0 auto; min-width: 80px;
        }
        .admin-btn:hover { background: #3a3a4e; color: #fff; border-color: #4a9eff; }
        .component-indicators {
            position: absolute; bottom: 2px; left: 0; right: 0;
            display: flex; justify-content: center; gap: 4px; font-size: 9px; opacity: 0.5;
        }
        .admin-btn:hover .component-indicators { opacity: 0.9; }
        .indicator-tokens { color: #f59e0b; }
        .indicator-free { color: #22c55e; }
        .indicator-kitt { color: #4a9eff; }
        .indicator-local { color: #a855f7; }
        .indicator-api { color: #ec4899; }
        .notes-section { padding: 0 12px; }
        .notes-section textarea { width: 100%; background: #1a1a2e; border: 1px solid #333; color: #e0e0e0; border-radius: 8px; padding: 10px; font-size: 13px; resize: vertical; margin-bottom: 8px; font-family: inherit; box-sizing: border-box; }
        .notes-section textarea:focus { outline: none; border-color: #4a9eff; }
        .notes-save { width: 100%; margin-bottom: 12px; }
        .service-row {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .status-dot {
            width: 10px; height: 10px; border-radius: 50%;
            background: #666; cursor: pointer; flex-shrink: 0;
        }
        .status-dot.online { background: #10b981; box-shadow: 0 0 4px rgba(16,185,129,0.3); }
        .status-dot.offline { background: #ef4444; }
        .status-dot.checking { background: #eab308; animation: pulse 1s infinite; }
        .service-info { flex: 1; cursor: pointer; }
        .service-name { font-size: 14px; font-weight: 500; }
        .service-port { font-size: 12px; color: #888; font-family: 'Consolas', monospace; }
        .service-controls { display: flex; gap: 4px; }
        .service-mode-toggle { display: flex; align-items: center; gap: 8px; padding: 8px 12px; margin-bottom: 12px; background: #1a1a2e; border-radius: 8px; }
        .mode-label { color: #888; font-size: 12px; }
        .mode-btn { padding: 6px 12px; border: 1px solid #333; border-radius: 6px; background: #2a2a3e; color: #aaa; cursor: pointer; font-size: 12px; transition: all 0.2s; }
        .mode-btn:hover { background: #3a3a4e; }
        .mode-btn.active { background: #4a9eff; color: white; border-color: #4a9eff; }
        .mode-status { font-size: 11px; color: #888; margin-left: auto; }
        .btn-control {
            width: 32px; height: 32px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 14px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .btn-control.loading { background: #eab308 !important; color: #000 !important; animation: pulse 0.8s infinite; pointer-events: none; }
        .btn-control.success { background: #22c55e !important; color: #fff !important; }
        .btn-control.error { background: #ef4444 !important; color: #fff !important; }
        .btn-start { background: #0f3460; color: #22c55e; }
        .btn-start:hover { background: #1a4a7a; }
        .btn-stop { background: #3d1a1a; color: #ef4444; }
        .btn-stop:hover { background: #5a2a2a; }
        .btn-log { background: #1a2a3d; color: #4a9eff; }
        .btn-log:hover { background: #2a3a4d; }
        .btn-restart { background: #2a2a1a; color: #eab308; }
        .btn-restart:hover { background: #3a3a2a; }
        .status-dot.starting { background: #eab308; animation: blink 0.5s infinite; }
        .service-mode-indicator { font-size: 10px; color: #666; margin-top: 2px; }
        .service-mode-indicator.dev { color: #eab308; }
        .service-mode-indicator.service { color: #4a9eff; }

        /* Server Controls in Admin Menu */
        .server-controls { padding: 0 12px 16px 12px; }
        .server-row { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: #2a2a3e; border-radius: 6px; margin-bottom: 6px; }
        .server-dot { width: 10px; height: 10px; border-radius: 50%; background: #666; }
        .server-dot.running { background: #10b981; }
        .server-dot.stopped { background: #ef4444; }
        .server-dot.checking { background: #eab308; animation: pulse 1s infinite; }
        .server-name { flex: 1; font-size: 13px; color: #e0e0e0; }
        .server-port { font-size: 11px; color: #888; width: 45px; }
        .server-btn { background: #333; border: none; color: #ccc; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
        .server-btn:hover { background: #4a9eff; color: #fff; }
        .server-btn.start { color: #10b981; }
        .server-btn.link { color: #4a9eff; }
        .server-btn.loading { background: #eab308; color: #000; animation: pulse 0.8s infinite; pointer-events: none; }
        .server-btn.success { background: #22c55e; color: #fff; }
        .server-btn.error { background: #ef4444; color: #fff; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Admin button states */
        .admin-btn.loading { background: #eab308 !important; color: #000 !important; animation: pulse 0.8s infinite; pointer-events: none; }
        .admin-btn.success { background: #22c55e !important; color: #fff !important; border-color: #22c55e !important; }
        .admin-btn.error { background: #ef4444 !important; color: #fff !important; border-color: #ef4444 !important; }
        
        /* Server dot blinking */
        .server-dot.starting { background: #eab308; animation: blink 0.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Log Viewer Modal */
        .log-modal {
            display: none; position: fixed;
            top: 100px; left: 50%; transform: translateX(-50%);
            width: 600px; height: 500px;
            background: #1a1a2e; border: 1px solid #333; border-radius: 12px;
            z-index: 102; flex-direction: column; overflow: hidden;
            resize: both; min-width: 300px; min-height: 200px;
        }
        .log-modal.active { display: flex; }
        .log-header {
            padding: 10px 14px; background: #2a2a3e; cursor: move;
            user-select: none; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .log-header h3 { margin: 0; font-size: 14px; color: #fff; }
        .log-header-btn {
            background: none; border: none; color: #888; cursor: pointer;
            font-size: 16px; padding: 4px; border-radius: 4px;
        }
        .log-header-btn:hover { background: #3a3a4e; color: #fff; }
        .log-selector {
            background: #1a1a2e; border: 1px solid #333; border-radius: 6px;
            padding: 4px 8px; color: #4a9eff; font-size: 12px; cursor: pointer;
        }
        .log-selector:hover { border-color: #4a9eff; }
        .log-selector:focus { outline: none; border-color: #4a9eff; }
        .log-content {
            flex: 1; padding: 16px; overflow-y: auto;
            font-family: 'Consolas', monospace; font-size: 12px;
            background: #0a0a14; white-space: pre-wrap; color: #88cc88;
        }
        .log-content .error { color: #ff6666; }
        /* Enhanced log formatting */
        .log-content .info { color: #4a9eff; }
        .log-content .debug { color: #888; }
        
        /* Chat history formatting */
        .chat-user, .chat-assistant {
            display: flex;
            gap: 10px;
            margin: 12px 0;
            padding: 10px;
            border-radius: 8px;
            line-height: 1.4;
        }
        
        .chat-user {
            background: rgba(74, 158, 255, 0.1);
            border-left: 3px solid #4a9eff;
        }
        
        .chat-assistant {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
        }
        
        .chat-icon {
            font-size: 16px;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .chat-content {
            flex: 1;
            word-wrap: break-word;
        }
        
        .chat-timestamp {
            color: #666;
            font-size: 11px;
            text-align: center;
            margin: 8px 0;
            padding: 4px 0;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
        }
        
        .chat-system {
            color: #888;
            font-style: italic;
            margin: 6px 0;
            padding: 6px 10px;
            background: rgba(136, 136, 136, 0.1);
            border-radius: 4px;
        }
        
        .chat-error {
            color: #ff6666;
            margin: 6px 0;
            padding: 8px 10px;
            background: rgba(255, 102, 102, 0.1);
            border-radius: 4px;
            border-left: 3px solid #ff6666;
        }
        
        .chat-warning {
            color: #ffcc00;
            margin: 6px 0;
            padding: 8px 10px;
            background: rgba(255, 204, 0, 0.1);
            border-radius: 4px;
            border-left: 3px solid #ffcc00;
        }
        
        .chat-empty {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        .log-content .warn { color: #ffcc00; }
        .log-footer { padding: 12px 16px; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .log-footer-left { display: flex; gap: 8px; }
        .log-footer button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .btn-refresh-log { background: #0f3460; color: #4a9eff; }
        .btn-copy-log { background: #1a3a1a; color: #22c55e; }
        .btn-copy-log.copied { background: #22c55e; color: #000; }
        .btn-clear-log { background: #3d1a1a; color: #ef4444; }
        .btn-close-log-bottom { background: #2a2a3e; color: #888; }
        .btn-close-log-bottom:hover { background: #3a3a4e; color: #fff; }
        
        /* Cost Report Modal */
        .cost-modal {
            display: none; position: fixed;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; max-height: 80vh;
            background: #1a1a2e; border: 1px solid #333; border-radius: 12px;
            z-index: 102; flex-direction: column; overflow: hidden;
        }
        .cost-modal.active { display: flex; }
        .cost-content { flex: 1; padding: 16px; overflow-y: auto; }
        .cost-card {
            background: #2a2a3e; border-radius: 8px; padding: 16px; margin-bottom: 12px;
        }
        .cost-card h3 { font-size: 12px; color: #888; margin-bottom: 8px; text-transform: uppercase; }
        .cost-row { display: flex; justify-content: space-between; padding: 4px 0; }
        .cost-label { color: #aaa; }
        .cost-value { color: #fff; font-weight: 500; }
        .cost-value.highlight { color: #4a9eff; font-size: 18px; }
        .cost-history { font-size: 12px; }
        .cost-history-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #333; }
        .cost-history-row:last-child { border-bottom: none; }
        
        /* Dev Tracker */
        .dev-tracker-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .dev-tracker-content { background: #1a1a2e; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; }
        .dev-tracker-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #333; }
        .dev-tracker-header h2 { margin: 0; font-size: 18px; }
        .dev-tracker-body { padding: 16px; overflow-y: auto; }
        .dev-tracker-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .dev-stat { background: #2a2a3e; padding: 12px; border-radius: 8px; text-align: center; }
        .dev-stat-value { display: block; font-size: 24px; font-weight: bold; color: #4a9eff; }
        .dev-stat-label { font-size: 11px; color: #888; }
        .dev-days { display: flex; flex-direction: column; gap: 12px; }
        .dev-day { background: #2a2a3e; border-radius: 8px; overflow: hidden; }
        .dev-day-header { display: flex; justify-content: space-between; padding: 10px 12px; background: #333; }
        .dev-day-date { font-weight: bold; }
        .dev-day-count { color: #4a9eff; font-size: 12px; }
        .dev-day-tasks { padding: 8px 12px; }
        .dev-task { display: flex; gap: 8px; padding: 4px 0; font-size: 13px; border-bottom: 1px solid #333; }
        .dev-task:last-child { border-bottom: none; }
        .dev-task-cat { width: 20px; }
        .dev-task-title { flex: 1; }
        .dev-task-time { color: #888; font-size: 11px; }
        .auto-tag { background: #4a9eff33; color: #4a9eff; font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 6px; }
        
        /* Chat */
        .chat-container {
            flex: 1; overflow-y: auto; padding: 16px;
            display: flex; flex-direction: column; gap: 12px;
        }
        .message-wrapper {
            display: flex; flex-direction: column; gap: 4px;
            max-width: 85%; position: relative;
        }
        .message-wrapper.user { align-self: flex-end; }
        .message-wrapper.assistant { align-self: flex-start; }
        .message-wrapper.system { align-self: center; }
        .message-wrapper.error { align-self: center; }
        .message {
            padding: 12px 16px; border-radius: 16px;
            line-height: 1.4; white-space: pre-wrap; word-wrap: break-word;
            transition: all 0.3s ease;
        }
        .message.user { background: #4a9eff; color: white; border-bottom-right-radius: 4px; }
        .message.assistant { background: #2a2a3e; color: #e0e0e0; border-bottom-left-radius: 4px; }
        .message.thinking { background: #2a2a3e; color: #888; font-style: italic; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .thinking-content { display: flex; flex-direction: column; gap: 2px; }
        .thinking-text { color: #888; }
        .thinking-status { color: #4a9eff; font-size: 12px; font-style: normal; }
        .thinking-timer { color: #666; font-size: 11px; font-family: monospace; font-style: normal; white-space: nowrap; }
        .message.error { background: #442222; color: #ff8888; }
        .message.system { background: #1a3a1a; color: #88cc88; font-size: 13px; }
        .message code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 13px; }
        .message pre { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; overflow-x: auto; margin: 8px 0; }
        
        /* Dismissed/struck through messages */
        .message-wrapper.dismissed .message {
            text-decoration: line-through;
            opacity: 0.4;
            filter: grayscale(100%);
        }
        .message-wrapper.dismissed .message.user { background: #666; }
        .message-wrapper.dismissed .message.assistant { background: #1a1a2e; }
        
        /* Message actions */
        .message-actions {
            display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s;
            position: absolute; top: -24px; right: 0;
        }
        .message-wrapper.user .message-actions { right: 0; left: auto; }
        .message-wrapper.assistant .message-actions { left: 0; right: auto; }
        .message-wrapper:hover .message-actions { opacity: 1; }
        .msg-action-btn {
            background: #2a2a3e; border: 1px solid #333; color: #888;
            padding: 2px 6px; border-radius: 4px; cursor: pointer;
            font-size: 11px; transition: all 0.2s;
        }
        .msg-action-btn:hover { background: #3a3a4e; color: #fff; border-color: #4a9eff; }
        .msg-action-btn.copied { background: #22c55e; color: #fff; border-color: #22c55e; }
        
        /* Pending Task Bubble */
        .pending-bubble {
            display: none; background: #2a2a3e; border: 1px solid #4a9eff;
            border-radius: 12px; padding: 12px 16px; margin: 0 16px 8px;
            animation: slideUp 0.2s ease;
        }
        .pending-bubble.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pending-text { font-size: 13px; color: #ccc; margin-bottom: 10px; max-height: 60px; overflow: hidden; cursor: pointer; }
        .pending-text:hover { color: #fff; }
        .pending-text:active { color: #4a9eff; }
        .pending-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .pending-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; }
        .pending-send { background: #4a9eff; color: white; }
        .pending-send:hover:not(:disabled) { background: #3a8eef; }
        .pending-send:disabled { background: #333; color: #666; cursor: not-allowed; }
        .pending-todo { background: #0f3460; color: #4a9eff; }
        .pending-todo:hover { background: #1a4a7a; }
        .priority-select { background: #1a1a2e; border: 1px solid #333; color: #ccc; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
        .priority-select option[value="mustdo"] { color: #ff4444; font-weight: bold; }
        .pending-cancel { background: none; color: #888; font-size: 16px; padding: 4px 8px; }
        .pending-cancel:hover { color: #ef4444; }

        /* Input */
        .input-container { background: #1a1a2e; padding: 12px 16px; display: flex; gap: 8px; border-top: 1px solid #333; }
        .input-wrapper { flex: 1; display: flex; background: #2a2a3e; border-radius: 24px; overflow: hidden; }
        #message-input { flex: 1; background: transparent; border: none; padding: 12px 16px; color: #e0e0e0; font-size: 16px; outline: none; }
        #message-input::placeholder { color: #666; }
        .btn { width: 48px; height: 48px; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .btn-send { background: #4a9eff; color: white; }
        .btn-send:hover { background: #3a8eef; }
        .btn-send:disabled { background: #333; cursor: not-allowed; }
        .btn-voice { background: transparent; color: #888; }
        .btn-voice:hover { color: #4a9eff; }
        .btn-voice.listening { color: #ff4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Attachment Styles */
        .btn-attach, .btn-ntt { background: transparent; color: #888; font-size: 18px; padding: 4px 8px; border: none; cursor: pointer; }
        .btn-attach:hover, .btn-ntt:hover { color: #4a9eff; }
        .btn-ntt { font-size: 12px; font-weight: bold; }
        .btn-ntt:hover { background: #4a9eff22; border-radius: 4px; }
        .attachment-preview {
            display: none; padding: 8px 16px; background: #2a2a3e; border-top: 1px solid #333;
            max-height: 120px; overflow-y: auto;
        }
        .attachment-preview.active { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .attachment-item {
            display: flex; align-items: center; gap: 6px; background: #1a1a2e;
            padding: 6px 10px; border-radius: 8px; font-size: 12px; max-width: 200px;
        }
        .attachment-item img { max-height: 40px; max-width: 60px; border-radius: 4px; object-fit: cover; }
        .attachment-item .file-icon { font-size: 18px; }
        .attachment-item .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px; }
        .attachment-item .btn-remove { background: none; border: none; color: #888; cursor: pointer; font-size: 14px; }
        .attachment-item .btn-remove:hover { color: #ef4444; }
        
        .quick-actions { display: flex; gap: 8px; padding: 8px 16px; overflow-x: auto; background: #1a1a2e; }
        .quick-btn { background: #2a2a3e; border: 1px solid #333; color: #aaa; padding: 8px 12px; border-radius: 16px; font-size: 12px; white-space: nowrap; cursor: pointer; }
        .quick-btn:hover { background: #3a3a4e; color: #fff; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <button class="btn-menu" id="btn-menu" title="Menu">‚ò∞</button>
        <h1>ü§ñ Admin Kitt <span id="kitt-status" class="kitt-status">‚ú®</span></h1>
        <div class="header-right">
            <button class="btn-todo" id="btn-todo" onclick="TodoModule.toggle()" title="TODO List">üìã</button>
            <button class="btn-logs" onclick="toggleLog('agent')" title="View Logs">üìú</button>
            <div class="compact-status" id="compact-status">
                <span class="compact-dot" id="dot-simwidget" title="SimWidget :8080"></span>
                <span class="compact-dot" id="dot-agent" title="Agent :8585"></span>
                <span class="compact-dot" id="dot-remote" title="Remote :8590"></span>
                <span class="header-cost" id="header-cost" onclick="event.stopPropagation(); toggleCostReport()" title="Today's cost">$0.00</span>
            </div>
            <button class="btn-services" id="btn-services" title="Services">‚öôÔ∏è</button>
            <button class="btn-refresh" id="btn-refresh" title="Reconnect">üîÑ</button>
            <div class="status" id="status">Disconnected</div>
        </div>
    </div>

    <!-- Admin Menu -->
    <div class="overlay" id="admin-overlay"></div>
    <div class="admin-menu" id="admin-menu">
        <div class="admin-header"><h2>Admin</h2><button class="btn-close" id="btn-close-admin">√ó</button></div>
        <div class="admin-content">
            <div class="section-label">SERVERS</div>
            <div class="server-controls" id="server-controls">
                <div class="server-row" data-server="master">
                    <span class="server-dot" id="dot-master"></span>
                    <span class="server-name">Master (O)</span>
                    <span class="server-port">:8500</span>
                    <button class="server-btn link" onclick="window.open('http://192.168.1.42:8500','_blank')">‚Üó</button>
                </div>
                <div class="server-row" data-server="simwidget">
                    <span class="server-dot" id="dot-simwidget"></span>
                    <span class="server-name">Main Server</span>
                    <span class="server-port">:8080</span>
                    <button class="server-btn start" onclick="startServer('simwidget')">‚ñ∂</button>
                    <button class="server-btn link" onclick="window.open('http://192.168.1.42:8080','_blank')">‚Üó</button>
                </div>
                <div class="server-row" data-server="agent">
                    <span class="server-dot" id="dot-agent"></span>
                    <span class="server-name">Agent (Kitt)</span>
                    <span class="server-port">:8585</span>
                    <button class="server-btn start" onclick="startServer('agent')">‚ñ∂</button>
                    <button class="server-btn link" onclick="window.open('http://192.168.1.42:8585','_blank')">‚Üó</button>
                </div>
                <div class="server-row" data-server="remote">
                    <span class="server-dot" id="dot-remote"></span>
                    <span class="server-name">Remote Support</span>
                    <span class="server-port">:8590</span>
                    <button class="server-btn start" onclick="startServer('remote')">‚ñ∂</button>
                    <button class="server-btn link" onclick="window.open('http://192.168.1.42:8590','_blank')">‚Üó</button>
                </div>
                <div class="server-row" data-server="relay">
                    <span class="server-dot" id="dot-relay"></span>
                    <span class="server-name">Relay Service</span>
                    <span class="server-port">:8600</span>
                    <button class="server-btn start" onclick="startServer('relay')">‚ñ∂</button>
                    <button class="server-btn link" onclick="window.open('http://192.168.1.42:8600','_blank')">‚Üó</button>
                </div>
                <div style="margin-top: 10px; display: flex; gap: 8px;">
                    <button class="admin-btn" onclick="startAllServers()" style="flex:1;">üöÄ Start All (sas)<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
                    <button class="admin-btn" onclick="checkAllServers()" style="flex:1;">üîç Check Status<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
                </div>
                <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
                    <button class="admin-btn" id="relay-toggle" onclick="toggleRelayMode()" style="flex:1;">üîÑ Relay Mode: <span id="relay-status">OFF</span><div class="component-indicators"><span class="indicator-free">üÜì</span></div></button>
                    <span id="relay-queue" style="font-size: 11px; color: #888;">Queue: 0</span>
                </div>
            </div>
            <div class="section-label">QUICK COMMANDS</div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="sendQuick('run tests')">üß™ Tests<div class="component-indicators"><span class="indicator-tokens">ü™ô</span><span class="indicator-kitt">ü§ñ</span></div></button>
                <button class="admin-btn" onclick="sendQuick('show errors')">‚ö†Ô∏è Errors<div class="component-indicators"><span class="indicator-tokens">ü™ô</span><span class="indicator-kitt">ü§ñ</span></div></button>
                <button class="admin-btn" onclick="sendQuick('sync to github')">üì§ Git Sync<div class="component-indicators"><span class="indicator-tokens">ü™ô</span><span class="indicator-kitt">ü§ñ</span></div></button>
            </div>
            <div class="section-label">WIDGETS</div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="sendQuick('list widgets')">üéõÔ∏è List All<div class="component-indicators"><span class="indicator-tokens">ü™ô</span><span class="indicator-kitt">ü§ñ</span></div></button>
                <button class="admin-btn" onclick="sendQuick('create widget')">‚ûï New Widget<div class="component-indicators"><span class="indicator-tokens">ü™ô</span><span class="indicator-kitt">ü§ñ</span></div></button>
            </div>
            <div class="section-label">LINKS</div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="window.open(`http://${baseHost}:8080`, '_blank')">üöÄ SimWidget UI<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
                <button class="admin-btn" onclick="showCostReport()">üí∞ API Costs<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
                <button class="admin-btn" onclick="showDevTracker()">üìà Dev Tracker<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
            </div>
            <div class="section-label">LOGS</div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="showLog('kitt')">ü§ñ Kitt Log<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
                <button class="admin-btn" onclick="showLog('errors')">‚ö†Ô∏è Errors<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
                <button class="admin-btn" onclick="showLog('usage')">üìä Usage<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
            </div>
            <div class="section-label">üõ†Ô∏è TROUBLESHOOTING</div>
            <div id="trouble-alerts" style="padding: 0 12px 8px 12px;"></div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="resetKitt()">üîÑ Reset Kitt<div class="component-indicators"><span class="indicator-free">üÜì</span></div></button>
                <button class="admin-btn" onclick="showQueuePanel()">üì¨ View Queue<div class="component-indicators"><span class="indicator-free">üÜì</span></div></button>
                <button class="admin-btn" onclick="window.open(`http://${baseHost}:8600`, '_blank')">üîó Relay UI<div class="component-indicators"><span class="indicator-free">üÜì</span></div></button>
            </div>
            <div class="section-label">üéÆ GAMING DEVICES</div>
            <div id="device-status" style="padding: 0 12px 8px 12px; font-size: 11px; color: #888;"></div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="disableGamingDevices()">üö´ Disable All<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
                <button class="admin-btn" onclick="enableGamingDevices()">‚úÖ Enable All<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
                <button class="admin-btn" onclick="showGamingDevices()">üìã List Devices<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
            </div>
            <div class="section-label">NOTES</div>
            <div class="notes-section">
                <textarea id="admin-notes" placeholder="Quick notes..." rows="6"></textarea>
                <button class="admin-btn notes-save" onclick="saveNotes()">üíæ Save Notes<div class="component-indicators"><span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span></div></button>
            </div>
            <div class="section-label">QUICK REFERENCE</div>
            <div class="quick-ref-section" id="quick-ref-section" style="padding: 0 12px; font-size: 11px; color: #888; line-height: 1.8;">
                <div class="quick-ref-loading">Loading...</div>
            </div>
            <div style="padding: 8px 12px;">
                <button class="admin-btn" onclick="showTodoInsight()" style="width: 100%;">üí° TODO Insights<div class="component-indicators"><span class="indicator-tokens">ü™ô</span><span class="indicator-kitt">ü§ñ</span></div></button>
            </div>
        </div>
    </div>

    <!-- Services Panel -->
    <div class="overlay" id="services-overlay"></div>
    <div class="services-panel" id="services-panel">
        <div class="services-header"><h2>SimWidget Services</h2><button class="btn-close" id="btn-close-services">√ó</button></div>
        <div class="services-content">
            <div class="service-mode-toggle">
                <span class="mode-label">Mode:</span>
                <button class="mode-btn" id="mode-dev" onclick="setServiceMode('dev')">üõ†Ô∏è Dev</button>
                <button class="mode-btn" id="mode-service" onclick="setServiceMode('service')">ü™ü Service</button>
                <span class="mode-status" id="mode-status"></span>
            </div>
            <div class="section-label">SERVICES</div>
            <div class="service-row" data-service="simwidget">
                <span class="status-dot" id="status-simwidget"></span>
                <div class="service-info" onclick="showLog('simwidget')"><div class="service-name">SimWidget</div><div class="service-mode-indicator" id="mode-indicator-simwidget"></div></div>
                <div class="service-port">:8080</div>
                <div class="service-controls">
                    <button class="btn-control btn-log" onclick="showLog('simwidget')" title="View Log">üìã</button>
                    <button class="btn-control btn-start" data-action="start" title="Start">‚ñ∂</button>
                    <button class="btn-control btn-restart" data-action="restart" title="Restart">üîÑ</button>
                    <button class="btn-control btn-stop" data-action="stop" title="Stop">‚ñ†</button>
                </div>
            </div>
            <div class="service-row" data-service="agent">
                <span class="status-dot" id="status-agent"></span>
                <div class="service-info" onclick="showLog('agent')"><div class="service-name">Agent</div><div class="service-mode-indicator" id="mode-indicator-agent"></div></div>
                <div class="service-port">:8585</div>
                <div class="service-controls">
                    <button class="btn-control btn-log" onclick="showLog('agent')" title="View Log">üìã</button>
                    <button class="btn-control btn-start" data-action="start" title="Start">‚ñ∂</button>
                    <button class="btn-control btn-restart" data-action="restart" title="Restart">üîÑ</button>
                    <button class="btn-control btn-stop" data-action="stop" title="Stop">‚ñ†</button>
                </div>
            </div>
            <div class="service-row" data-service="remote">
                <span class="status-dot" id="status-remote"></span>
                <div class="service-info" onclick="showLog('remote')"><div class="service-name">Remote</div><div class="service-mode-indicator" id="mode-indicator-remote"></div></div>
                <div class="service-port">:8590</div>
                <div class="service-controls">
                    <button class="btn-control btn-log" onclick="showLog('remote')" title="View Log">üìã</button>
                    <button class="btn-control btn-start" data-action="start" title="Start">‚ñ∂</button>
                    <button class="btn-control btn-restart" data-action="restart" title="Restart">üîÑ</button>
                    <button class="btn-control btn-stop" data-action="stop" title="Stop">‚ñ†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Viewer Modal -->
    <div class="log-modal" id="log-modal">
        <div class="log-header" id="log-drag-handle">
            <h3>üìú <select class="log-selector" id="log-selector">
                <option value="agent">Agent Log</option>
                <option value="errors">Agent Errors</option>
                <option value="chat">Chat History</option>
                <option value="simwidget">SimWidget Log</option>
                <option value="usage">Usage Log</option>
            </select></h3>
            <button class="log-header-btn" id="btn-close-log" title="Close">√ó</button>
        </div>
        <div class="log-content" id="log-content">Loading...</div>
        <div class="log-footer">
            <div class="log-footer-left">
                <button class="btn-refresh-log" onclick="refreshLog()">üîÑ Refresh</button>
                <button class="btn-copy-log" id="btn-copy-log" onclick="copyLog()">üìã Copy</button>
                <button class="btn-clear-log" onclick="clearLog()">üóëÔ∏è Clear</button>
            </div>
            <button class="btn-close-log-bottom" onclick="logModal.classList.remove('active')">‚úï Close</button>
        </div>
    </div>

    <!-- Cost Report Modal -->
    <div class="cost-modal" id="cost-modal">
        <div class="log-header"><h2>üí∞ API Usage & Costs</h2><button class="btn-close" id="btn-close-cost">√ó</button></div>
        <div class="cost-content" id="cost-content">
            <div class="cost-card">
                <h3>Today</h3>
                <div class="cost-row"><span class="cost-label">Requests</span><span class="cost-value" id="today-requests">-</span></div>
                <div class="cost-row"><span class="cost-label">Input Tokens</span><span class="cost-value" id="today-input">-</span></div>
                <div class="cost-row"><span class="cost-label">Output Tokens</span><span class="cost-value" id="today-output">-</span></div>
                <div class="cost-row"><span class="cost-label">Cost</span><span class="cost-value highlight" id="today-cost">$0.00</span></div>
            </div>
            <div class="cost-card">
                <h3>All Time</h3>
                <div class="cost-row"><span class="cost-label">Requests</span><span class="cost-value" id="total-requests">-</span></div>
                <div class="cost-row"><span class="cost-label">Input Tokens</span><span class="cost-value" id="total-input">-</span></div>
                <div class="cost-row"><span class="cost-label">Output Tokens</span><span class="cost-value" id="total-output">-</span></div>
                <div class="cost-row"><span class="cost-label">Total Cost</span><span class="cost-value highlight" id="total-cost">$0.00</span></div>
            </div>
            <div class="cost-card">
                <h3>üìä Projected Costs</h3>
                <div class="cost-row"><span class="cost-label">Daily Avg</span><span class="cost-value" id="proj-daily">$0.00</span></div>
                <div class="cost-row"><span class="cost-label">Weekly</span><span class="cost-value" id="proj-weekly">$0.00</span></div>
                <div class="cost-row"><span class="cost-label">Monthly</span><span class="cost-value highlight" id="proj-monthly">$0.00</span></div>
                <div class="cost-row"><span class="cost-label">Yearly</span><span class="cost-value" id="proj-yearly">$0.00</span></div>
            </div>
            <div class="cost-card cost-history">
                <h3>Last 7 Days</h3>
                <div id="cost-history"></div>
            </div>
            <div class="cost-card cost-history">
                <h3>Monthly Breakdown</h3>
                <div id="cost-months"></div>
            </div>
        </div>
    </div>

    <div class="quick-actions">
        <button class="quick-btn" onclick="sendQuick('server status')">Status</button>
        <button class="quick-btn" onclick="sendQuick('restart server')">Restart</button>
        <button class="quick-btn" onclick="sendQuick('run tests')">Tests</button>
        <button class="quick-btn" onclick="sendQuick('list widgets')">Widgets</button>
        <button class="quick-btn" onclick="sendQuick('sync to github')">Git Sync</button>
    </div>

    <div class="chat-container" id="chat"></div>

    <!-- Pending Task Bubble -->
    <div class="pending-bubble" id="pending-bubble">
        <div class="pending-text" id="pending-text" onclick="copyPendingText()" title="Click to copy"></div>
        <div class="pending-actions">
            <button class="pending-btn pending-send" id="pending-send-btn" onclick="sendPending()" disabled>Send (when ready)</button>
            <button class="pending-btn pending-todo" onclick="addTodo()">TODO:</button>
            <select class="priority-select" id="priority-select">
                <option value="mustdo">‚ö° MUSTDO</option>
                <option value="high">High</option>
                <option value="medium" selected>Medium</option>
                <option value="low">Low</option>
            </select>
            <button class="pending-btn pending-cancel" onclick="cancelPending()">‚úï</button>
        </div>
    </div>

    <!-- Attachment Preview -->
    <div class="attachment-preview" id="attachment-preview"></div>

    <div class="input-container">
        <input type="file" id="file-input" multiple hidden accept="image/*,.pdf,.txt,.js,.json,.md,.html,.css">
        <div class="input-wrapper">
            <button class="btn-attach" id="btn-attach" title="Attach file (Ctrl+U)">üìé</button>
            <input type="text" id="message-input" placeholder="Message Kitt... (paste images here)" autocomplete="off">
            <button class="btn-ntt" id="btn-ntt" title="Next Todo Task">NTT</button>
            <button class="btn btn-voice" id="btn-voice" title="Voice input">üé§</button>
        </div>
        <button class="btn btn-send" id="btn-send" title="Send">‚û§</button>
    </div>

    <script>
        const chat = document.getElementById('chat');
        const input = document.getElementById('message-input');
        const btnSend = document.getElementById('btn-send');
        const btnVoice = document.getElementById('btn-voice');
        const btnRefresh = document.getElementById('btn-refresh');
        const status = document.getElementById('status');
        const pendingBubble = document.getElementById('pending-bubble');
        const pendingText = document.getElementById('pending-text');
        const prioritySelect = document.getElementById('priority-select');

        let ws = null;
        let recognition = null;
        let isBusy = false;
        let pendingMessage = '';
        let currentLogService = null;
        let reconnectTimeout = null;
        let manualDisconnect = false;
        let attachments = []; // Attachment storage
        
        // ==================== ATTACHMENTS ====================
        const attachmentPreview = document.getElementById('attachment-preview');
        const fileInput = document.getElementById('file-input');
        const btnAttach = document.getElementById('btn-attach');
        const btnNtt = document.getElementById('btn-ntt');
        
        // Attach button click
        btnAttach.addEventListener('click', () => fileInput.click());
        
        // File input change
        fileInput.addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(file => addAttachment(file));
            fileInput.value = '';
        });
        
        // Clipboard paste (images)
        input.addEventListener('paste', (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;
            
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) addAttachment(file);
                }
            }
        });
        
        // Ctrl+U shortcut for attach
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                fileInput.click();
            }
        });
        
        function addAttachment(file) {
            const id = Date.now() + Math.random().toString(36).substr(2, 9);
            const isImage = file.type.startsWith('image/');
            
            const attachment = { id, file, name: file.name, type: file.type, isImage };
            attachments.push(attachment);
            
            const item = document.createElement('div');
            item.className = 'attachment-item';
            item.dataset.id = id;
            
            if (isImage) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    attachment.dataUrl = e.target.result;
                    item.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <span class="file-name">${file.name}</span>
                        <button class="btn-remove" onclick="removeAttachment('${id}')">√ó</button>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                const icons = { pdf: 'üìÑ', txt: 'üìù', js: 'üìú', json: 'üìã', md: 'üìë', html: 'üåê', css: 'üé®' };
                const ext = file.name.split('.').pop().toLowerCase();
                item.innerHTML = `
                    <span class="file-icon">${icons[ext] || 'üìÅ'}</span>
                    <span class="file-name">${file.name}</span>
                    <button class="btn-remove" onclick="removeAttachment('${id}')">√ó</button>
                `;
            }
            
            attachmentPreview.appendChild(item);
            attachmentPreview.classList.add('active');
        }
        
        function removeAttachment(id) {
            attachments = attachments.filter(a => a.id !== id);
            const item = attachmentPreview.querySelector(`[data-id="${id}"]`);
            if (item) item.remove();
            if (attachments.length === 0) attachmentPreview.classList.remove('active');
        }
        
        function clearAttachments() {
            attachments = [];
            attachmentPreview.innerHTML = '';
            attachmentPreview.classList.remove('active');
        }
        
        // NTT (Next Todo Task) button
        btnNtt.addEventListener('click', async () => {
            try {
                const res = await fetch(`http://${location.hostname}:8585/api/todos`);
                const data = await res.json();
                const lists = data.lists || {};
                const todos = Object.values(lists).flat().filter(t => !t.completed);
                
                // Find highest priority incomplete task
                const priorityOrder = ['mustdo', 'high', 'medium', 'low', 'thought'];
                let nextTask = null;
                for (const priority of priorityOrder) {
                    nextTask = todos.find(t => t.priority === priority);
                    if (nextTask) break;
                }
                
                if (nextTask) {
                    input.value = nextTask.text;
                    input.focus();
                    addSystemMessage(`üìã Loaded: ${nextTask.text}`);
                } else {
                    addSystemMessage('‚úÖ No pending tasks!');
                }
            } catch (err) {
                addSystemMessage(`‚ùå Failed to load todos: ${err.message}`);
            }
        });
        
        function updateKittStatus() {
            const statusEl = document.getElementById('kitt-status');
            if (isBusy) {
                statusEl.textContent = 'üí≠';
                statusEl.classList.add('busy');
                statusEl.title = 'Kitt is thinking...';
            } else {
                statusEl.textContent = '‚ú®';
                statusEl.classList.remove('busy');
                statusEl.title = 'Kitt is ready';
            }
        }

        const services = {
            simwidget: { port: 8080, status: 'checking' },
            agent: { port: 8585, status: 'checking' },
            remote: { port: 8590, status: 'checking' }
        };

        // ==================== MENUS ====================
        const adminMenu = document.getElementById('admin-menu');
        const adminOverlay = document.getElementById('admin-overlay');
        const servicesPanel = document.getElementById('services-panel');
        const servicesOverlay = document.getElementById('services-overlay');
        const logModal = document.getElementById('log-modal');

        document.getElementById('btn-menu').addEventListener('click', () => togglePanel('admin'));
        document.getElementById('btn-close-admin').addEventListener('click', () => togglePanel('admin'));
        document.getElementById('admin-overlay').addEventListener('click', () => togglePanel('admin'));
        
        document.getElementById('btn-services').addEventListener('click', () => togglePanel('services'));
        document.getElementById('compact-status').addEventListener('click', () => togglePanel('services'));
        document.getElementById('btn-close-services').addEventListener('click', () => togglePanel('services'));
        document.getElementById('services-overlay').addEventListener('click', () => togglePanel('services'));
        
        document.getElementById('btn-close-log').addEventListener('click', () => logModal.classList.remove('active'));
        document.getElementById('log-selector').addEventListener('change', () => refreshLog());

        // Log modal drag functionality
        (function setupLogDrag() {
            const modal = document.getElementById('log-modal');
            const handle = document.getElementById('log-drag-handle');
            let isDragging = false;
            let startX, startY, startLeft, startTop;

            // Load saved position/size
            const saved = localStorage.getItem('log-modal-state');
            if (saved) {
                const state = JSON.parse(saved);
                if (state.left) modal.style.left = state.left;
                if (state.top) modal.style.top = state.top;
                if (state.width) modal.style.width = state.width;
                if (state.height) modal.style.height = state.height;
                if (state.left || state.top) modal.style.transform = 'none';
            }

            function saveState() {
                const rect = modal.getBoundingClientRect();
                localStorage.setItem('log-modal-state', JSON.stringify({
                    left: modal.style.left,
                    top: modal.style.top,
                    width: modal.style.width,
                    height: modal.style.height
                }));
            }

            handle.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'BUTTON') return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                const rect = modal.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                modal.style.transform = 'none';
                modal.style.left = startLeft + 'px';
                modal.style.top = startTop + 'px';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                modal.style.left = (startLeft + dx) + 'px';
                modal.style.top = (startTop + dy) + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) saveState();
                isDragging = false;
            });

            // Save on resize
            new ResizeObserver(() => saveState()).observe(modal);
        })();

        const costModal = document.getElementById('cost-modal');
        document.getElementById('btn-close-cost').addEventListener('click', () => costModal.classList.remove('active'));

        function togglePanel(panel) {
            if (panel === 'admin') {
                adminMenu.classList.toggle('active');
                adminOverlay.classList.toggle('active');
            } else {
                servicesPanel.classList.toggle('active');
                servicesOverlay.classList.toggle('active');
            }
        }

        function closeAllPanels() {
            adminMenu.classList.remove('active');
            adminOverlay.classList.remove('active');
            servicesPanel.classList.remove('active');
            servicesOverlay.classList.remove('active');
        }

        // ==================== LOG VIEWER ====================
        function toggleLog(service) {
            if (logModal.classList.contains('active')) {
                logModal.classList.remove('active');
            } else {
                showLog(service);
            }
        }
        
        async function showLog(service) {
            currentLogService = service;
            document.getElementById('log-selector').value = service;
            logModal.classList.add('active');
            await refreshLog();
        }

        async function refreshLog() {
            const logContent = document.getElementById('log-content');
            const service = document.getElementById('log-selector').value;
            currentLogService = service;
            logContent.textContent = 'Loading...';
            
            // Kitt log uses special endpoint and formatting
            if (service === 'kitt') {
                try {
                    const response = await fetch(`http://${baseHost}:8585/api/logs/kitt`);
                    const data = await response.json();
                    logContent.innerHTML = formatKittLog(data.entries || []);
                } catch (err) {
                    logContent.textContent = `Error: ${err.message}`;
                }
                return;
            }
            
            // Route to correct server based on log type
            let endpoint;
            if (service === 'agent' || service === 'errors' || service === 'chat' || service === 'usage') {
                endpoint = `http://${location.hostname}:8585/api/logs/${service}`;
            } else {
                endpoint = `http://${baseHost}:8080/api/logs/${service}`;
            }
            
            try {
                const response = await fetch(endpoint, { timeout: 3000 });
                if (response.ok) {
                    const data = await response.json();
                    logContent.innerHTML = formatLog(data.log || 'No log data', service);
                } else {
                    logContent.textContent = 'Failed to fetch log';
                }
            } catch (err) {
                logContent.textContent = `Error: ${err.message}\n\nService may not be running or log endpoint not available.`;
            }
        }
        
        function formatKittLog(entries) {
            if (!entries || entries.length === 0) {
                return '<div style="color:#888;text-align:center;padding:20px;">No Kitt communications yet</div>';
            }
            
            let html = '<div style="display:flex;flex-direction:column;gap:6px;">';
            let lastDate = '';
            
            const icons = {
                'user': 'üì±',
                'user-relay': 'üì±‚Üí',
                'kitt': 'ü§ñ',
                'claude-relay': 'üñ•Ô∏è‚Üí'
            };
            
            const colors = {
                'user': { bg: '#1a3a5a', border: '#4a9eff' },
                'user-relay': { bg: '#1a3a5a', border: '#4a9eff' },
                'kitt': { bg: '#2a3a2e', border: '#10b981' },
                'claude-relay': { bg: '#3a1a5a', border: '#a855f7' }
            };
            
            entries.forEach(e => {
                // Date separator
                if (e.date !== lastDate) {
                    html += `<div style="text-align:center;color:#666;font-size:10px;padding:6px 0;border-bottom:1px solid #333;">${e.date}</div>`;
                    lastDate = e.date;
                }
                
                const c = colors[e.from] || { bg: '#2a2a3e', border: '#666' };
                const icon = icons[e.from] || 'üí¨';
                const borderColor = e.isError ? '#ef4444' : c.border;
                const label = e.from.replace('-relay', ' (relay)');
                
                html += `
                    <div style="background:${c.bg};border-left:3px solid ${borderColor};padding:8px 10px;border-radius:4px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;">
                            <span style="font-size:11px;color:#aaa;">${icon} ${label}</span>
                            <span style="color:#555;font-size:10px;">${e.time}</span>
                        </div>
                        <div style="color:${e.isError ? '#ff8888' : '#ddd'};font-size:12px;line-height:1.4;word-break:break-word;">${e.message}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function formatLog(log, service) {
            // If this is chat history, format it nicely
            if (service === 'chat' || (typeof service === 'undefined' && log.includes('User:') && log.includes('Assistant:'))) {
                return formatChatHistory(log);
            }
            
            // For other logs, apply basic highlighting
            return log
                .replace(/error/gi, '<span class="error">error</span>')
                .replace(/warn/gi, '<span class="warn">warn</span>')
                .replace(/info/gi, '<span class="info">info</span>')
                .replace(/debug/gi, '<span class="debug">debug</span>');
        }

        function formatChatHistory(log) {
            const lines = log.split('\n');
            let formatted = '';
            let currentMessage = '';
            let messageType = '';
            
            for (let line of lines) {
                const trimmedLine = line.trim();
                
                if (trimmedLine.startsWith('User:') || trimmedLine.startsWith('Human:')) {
                    // Finish previous message
                    if (currentMessage && messageType) {
                        formatted += formatChatMessage(currentMessage, messageType);
                    }
                    // Start new user message
                    messageType = 'user';
                    currentMessage = trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim();
                } else if (trimmedLine.startsWith('Assistant:') || trimmedLine.startsWith('Kitt:')) {
                    // Finish previous message
                    if (currentMessage && messageType) {
                        formatted += formatChatMessage(currentMessage, messageType);
                    }
                    // Start new assistant message
                    messageType = 'assistant';
                    currentMessage = trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim();
                } else if (trimmedLine.startsWith('[') && trimmedLine.includes(']')) {
                    // System/timestamp line
                    if (currentMessage && messageType) {
                        formatted += formatChatMessage(currentMessage, messageType);
                        currentMessage = '';
                    }
                    formatted += '<div class="chat-timestamp">' + escapeHtml(trimmedLine) + '</div>\n';
                    messageType = '';
                } else if (trimmedLine && messageType) {
                    // Continue current message
                    currentMessage += '\n' + trimmedLine;
                } else if (trimmedLine && !messageType) {
                    // Standalone line (error, system message, etc.)
                    const lowerLine = trimmedLine.toLowerCase();
                    if (lowerLine.includes('error')) {
                        formatted += '<div class="chat-error">' + escapeHtml(trimmedLine) + '</div>\n';
                    } else if (lowerLine.includes('warn')) {
                        formatted += '<div class="chat-warning">' + escapeHtml(trimmedLine) + '</div>\n';
                    } else {
                        formatted += '<div class="chat-system">' + escapeHtml(trimmedLine) + '</div>\n';
                    }
                }
            }
            
            // Don't forget the last message
            if (currentMessage && messageType) {
                formatted += formatChatMessage(currentMessage, messageType);
            }
            
            return formatted || '<div class="chat-empty">No chat history available</div>';
        }

        function formatChatMessage(content, type) {
            const escapedContent = escapeHtml(content.trim());
            const className = type === 'user' ? 'chat-user' : 'chat-assistant';
            const icon = type === 'user' ? '??' : '??';
            
            return '<div class="' + className + '">' +
                   '<div class="chat-icon">' + icon + '</div>' +
                   '<div class="chat-content">' + escapedContent.replace(/\n/g, '<br>') + '</div>' +
                   '</div>\n';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function clearLog() {
            if (!currentLogService) return;
            if (!confirm(`Clear ${currentLogService} log permanently?`)) return;
            
            // Determine which endpoint to use
            let endpoint;
            if (currentLogService === 'agent' || currentLogService === 'errors' || currentLogService === 'chat' || currentLogService === 'usage') {
                endpoint = `http://${location.hostname}:8585/api/logs/${currentLogService}`;
            } else {
                endpoint = `http://${location.hostname}:8080/api/logs/${currentLogService}`;
            }
            
            try {
                const res = await fetch(endpoint, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('log-content').textContent = 'Log cleared';
                } else {
                    document.getElementById('log-content').textContent = 'Error: ' + (data.error || 'Unknown error');
                }
            } catch (err) {
                document.getElementById('log-content').textContent = 'Error: ' + err.message;
            }
        }

        async function copyLog() {
            const logContent = document.getElementById('log-content');
            const btn = document.getElementById('btn-copy-log');
            const text = logContent.innerText;
            
            try {
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // Fallback for non-HTTPS or older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
                btn.classList.add('copied');
                btn.textContent = '‚úì Copied';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.textContent = 'üìã Copy';
                }, 2000);
            } catch (err) {
                console.error('Copy failed:', err);
                btn.textContent = '‚ùå Failed';
                setTimeout(() => btn.textContent = 'üìã Copy', 2000);
            }
        }

        // ==================== COST REPORT ====================
        function toggleCostReport() {
            if (costModal.classList.contains('active')) {
                costModal.classList.remove('active');
            } else {
                showCostReport();
            }
        }
        
        async function showCostReport() {
            closeAllPanels();
            costModal.classList.add('active');
            
            try {
                const response = await fetch(`http://${baseHost}:8585/api/usage`);
                const data = await response.json();
                
                // Today
                document.getElementById('today-requests').textContent = data.today.requests.toLocaleString();
                document.getElementById('today-input').textContent = data.today.inputTokens.toLocaleString();
                document.getElementById('today-output').textContent = data.today.outputTokens.toLocaleString();
                document.getElementById('today-cost').textContent = '$' + data.today.cost.toFixed(4);
                
                // Total
                document.getElementById('total-requests').textContent = data.total.requests.toLocaleString();
                document.getElementById('total-input').textContent = data.total.inputTokens.toLocaleString();
                document.getElementById('total-output').textContent = data.total.outputTokens.toLocaleString();
                document.getElementById('total-cost').textContent = '$' + data.total.cost.toFixed(4);
                
                // Projections
                if (data.projections) {
                    document.getElementById('proj-daily').textContent = '$' + data.projections.daily.toFixed(4);
                    document.getElementById('proj-weekly').textContent = '$' + data.projections.weekly.toFixed(2);
                    document.getElementById('proj-monthly').textContent = '$' + data.projections.monthly.toFixed(2);
                    document.getElementById('proj-yearly').textContent = '$' + data.projections.yearly.toFixed(2);
                }
                
                // History (last 7 days)
                const historyDiv = document.getElementById('cost-history');
                if (data.history.length === 0) {
                    historyDiv.innerHTML = '<div style="color:#666">No history yet</div>';
                } else {
                    historyDiv.innerHTML = data.history.map(day => `
                        <div class="cost-history-row">
                            <span>${day.date}</span>
                            <span>${day.requests} req</span>
                            <span>$${day.cost.toFixed(4)}</span>
                        </div>
                    `).join('');
                }
                
                // Monthly breakdown
                const monthsDiv = document.getElementById('cost-months');
                if (data.months && data.months.length > 0) {
                    monthsDiv.innerHTML = data.months.map(m => `
                        <div class="cost-history-row">
                            <span>${m.month}</span>
                            <span>${m.requests} req</span>
                            <span>$${m.cost.toFixed(2)}</span>
                        </div>
                    `).join('');
                } else {
                    monthsDiv.innerHTML = '<div style="color:#666">No monthly data yet</div>';
                }
            } catch (err) {
                document.getElementById('cost-content').innerHTML = `<div style="color:#ff6666">Error loading usage: ${err.message}</div>`;
            }
        }

        // ==================== DEV TRACKER ====================
        async function showDevTracker() {
            closeAllPanels();
            const modal = document.createElement('div');
            modal.className = 'dev-tracker-modal';
            modal.innerHTML = `
                <div class="dev-tracker-content">
                    <div class="dev-tracker-header">
                        <h2>üìà Dev Tracker</h2>
                        <button class="btn-close" onclick="this.closest('.dev-tracker-modal').remove()">√ó</button>
                    </div>
                    <div class="dev-tracker-body" id="dev-tracker-body">Loading...</div>
                </div>
            `;
            document.body.appendChild(modal);
            
            try {
                const res = await fetch(`http://${baseHost}:8585/api/dev-tracker`);
                const data = await res.json();
                const days = Object.keys(data.days || {}).sort().reverse();
                
                let html = '<div class="dev-tracker-summary">';
                
                // Overall stats
                let totalTasks = 0, totalFeatures = 0, totalBugfixes = 0, totalDuration = 0;
                days.forEach(d => {
                    const s = data.days[d].summary || {};
                    totalTasks += s.totalTasks || 0;
                    totalFeatures += s.features || 0;
                    totalBugfixes += s.bugfixes || 0;
                    totalDuration += s.totalDuration || 0;
                });
                
                html += `
                    <div class="dev-stat"><span class="dev-stat-value">${totalTasks}</span><span class="dev-stat-label">Total Tasks</span></div>
                    <div class="dev-stat"><span class="dev-stat-value">${totalFeatures}</span><span class="dev-stat-label">Features</span></div>
                    <div class="dev-stat"><span class="dev-stat-value">${totalBugfixes}</span><span class="dev-stat-label">Bug Fixes</span></div>
                    <div class="dev-stat"><span class="dev-stat-value">${Math.round(totalDuration/60)}h</span><span class="dev-stat-label">Dev Time</span></div>
                </div>`;
                
                // Daily breakdown
                html += '<div class="dev-days">';
                days.slice(0, 7).forEach(day => {
                    const d = data.days[day];
                    const s = d.summary || {};
                    html += `
                        <div class="dev-day">
                            <div class="dev-day-header">
                                <span class="dev-day-date">${day}</span>
                                <span class="dev-day-count">${s.totalTasks || 0} tasks</span>
                            </div>
                            <div class="dev-day-tasks">
                    `;
                    (d.tasks || []).forEach(t => {
                        const catIcon = {feature:'‚ú®', bugfix:'üêõ', refactor:'‚ôªÔ∏è', docs:'üìù'}[t.category] || 'üìå';
                        const autoTag = t.autoLogged ? '<span class="auto-tag">auto</span>' : '';
                        html += `<div class="dev-task"><span class="dev-task-cat">${catIcon}</span><span class="dev-task-title">${t.title}${autoTag}</span><span class="dev-task-time">${t.duration}m</span></div>`;
                    });
                    html += '</div></div>';
                });
                html += '</div>';
                
                document.getElementById('dev-tracker-body').innerHTML = html;
            } catch (err) {
                document.getElementById('dev-tracker-body').innerHTML = `<div style="color:#ff6666">Error: ${err.message}</div>`;
            }
        }

        // ==================== SERVICES ====================
        const baseHost = location.hostname; // Use actual host, not localhost
        
        async function checkService(name) {
            const service = services[name];
            updateServiceStatus(name, 'checking');
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const response = await fetch(`http://${baseHost}:${service.port}/api/status`, { 
                    signal: controller.signal,
                    mode: 'cors'
                });
                clearTimeout(timeoutId);
                service.status = response.ok ? 'online' : 'offline';
            } catch (err) { 
                console.log(`Service ${name} check failed:`, err.message);
                service.status = 'offline'; 
            }
            updateServiceStatus(name, service.status);
        }

        function updateServiceStatus(name, status) {
            const dot = document.getElementById(`status-${name}`);
            if (dot) dot.className = 'status-dot ' + status;
            const compactDot = document.getElementById(`dot-${name}`);
            if (compactDot) compactDot.className = 'compact-dot ' + status;
        }

        async function checkAllServices() {
            for (const name of Object.keys(services)) await checkService(name);
        }

        document.querySelectorAll('.service-row').forEach(row => {
            const service = row.dataset.service;
            row.querySelectorAll('.btn-start, .btn-stop, .btn-restart').forEach(btn => {
                btn.addEventListener('click', (e) => controlService(service, btn.dataset.action, e.target));
            });
        });

        async function controlService(service, action, btn) {
            const originalContent = btn ? btn.innerHTML : '';
            try {
                // Show loading state
                const row = document.querySelector(`.service-row[data-service="${service}"]`);
                const statusDot = document.getElementById(`status-${service}`);
                if (statusDot) statusDot.className = 'status-dot starting';
                if (btn) {
                    btn.classList.add('loading');
                    btn.innerHTML = '‚è≥';
                }
                
                await fetch(`http://${baseHost}:8585/api/services/${service}/${action}?mode=${currentServiceMode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                // Show success
                if (btn) {
                    btn.classList.remove('loading');
                    btn.classList.add('success');
                    btn.innerHTML = '‚úì';
                    setTimeout(() => {
                        btn.classList.remove('success');
                        btn.innerHTML = originalContent;
                    }, 1500);
                }
                
                // Wait longer for restart
                const delay = action === 'restart' ? 3000 : 2000;
                setTimeout(() => checkAllServicesForMode(), delay);
            } catch (err) {
                console.error('Service control failed:', err);
                if (btn) {
                    btn.classList.remove('loading');
                    btn.classList.add('error');
                    btn.innerHTML = '‚úó';
                    setTimeout(() => {
                        btn.classList.remove('error');
                        btn.innerHTML = originalContent;
                    }, 1500);
                }
            }
        }

        // Service Mode Management
        let currentServiceMode = 'dev';
        
        async function loadServiceMode() {
            try {
                const res = await fetch(`http://${baseHost}:8585/api/services`);
                const data = await res.json();
                currentServiceMode = data.mode || 'dev';
                updateServiceModeUI();
                updateModeIndicators();
                checkAllServicesForMode();
            } catch (err) {
                console.error('Failed to load service mode:', err);
            }
        }
        
        function updateServiceModeUI() {
            document.getElementById('mode-dev').classList.toggle('active', currentServiceMode === 'dev');
            document.getElementById('mode-service').classList.toggle('active', currentServiceMode === 'service');
            document.getElementById('mode-status').textContent = currentServiceMode === 'dev' 
                ? 'Node processes' 
                : 'Windows Services';
        }
        
        function updateModeIndicators() {
            ['simwidget', 'agent', 'remote'].forEach(service => {
                const indicator = document.getElementById(`mode-indicator-${service}`);
                if (indicator) {
                    indicator.textContent = currentServiceMode === 'dev' ? '(node)' : '(service)';
                    indicator.className = 'service-mode-indicator ' + currentServiceMode;
                }
            });
        }
        
        async function checkAllServicesForMode() {
            try {
                const res = await fetch(`http://${baseHost}:8585/api/services/status?mode=${currentServiceMode}`);
                const data = await res.json();
                
                // Update status dots based on response
                ['simwidget', 'agent', 'remote'].forEach(service => {
                    const status = data.services && data.services[service] ? 'online' : 'offline';
                    updateServiceStatus(service, status);
                });
            } catch (err) {
                console.error('Failed to check services:', err);
                // Fallback to port check
                checkAllServices();
            }
        }
        
        async function setServiceMode(mode) {
            try {
                const res = await fetch(`http://${baseHost}:8585/api/services/mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                if (res.ok) {
                    currentServiceMode = mode;
                    updateServiceModeUI();
                    updateModeIndicators();
                    addSystemMessage(`Service mode set to ${mode === 'dev' ? 'Dev (Node processes)' : 'Service (Windows Services)'}`);
                    // Re-check services for new mode
                    checkAllServicesForMode();
                }
            } catch (err) {
                console.error('Failed to set service mode:', err);
            }
        }
        
        // Initialize service mode on load
        loadServiceMode();

        checkAllServices();
        setInterval(checkAllServices, 10000);
        
        // Load and update header cost
        let lastKnownCost = null;
        
        async function updateHeaderCost() {
            try {
                const response = await fetch(`http://${baseHost}:8585/api/usage`);
                const data = await response.json();
                const newCost = data.today.cost;
                const costEl = document.getElementById('header-cost');
                
                // Check if cost changed
                if (lastKnownCost !== null && newCost > lastKnownCost) {
                    const delta = newCost - lastKnownCost;
                    
                    // Remove any existing delta
                    const existingDelta = costEl.querySelector('.cost-delta');
                    if (existingDelta) existingDelta.remove();
                    
                    // Update text first
                    costEl.childNodes.forEach(n => { if (n.nodeType === 3) n.remove(); });
                    costEl.insertBefore(document.createTextNode('$' + newCost.toFixed(4)), costEl.firstChild);
                    
                    // Show delta notification
                    const deltaEl = document.createElement('span');
                    deltaEl.className = 'cost-delta';
                    deltaEl.textContent = '+$' + delta.toFixed(4);
                    costEl.appendChild(deltaEl);
                    
                    // Pulse animation
                    costEl.classList.add('cost-changed');
                    
                    // Cleanup after animation
                    setTimeout(() => {
                        costEl.classList.remove('cost-changed');
                        if (deltaEl.parentNode) deltaEl.remove();
                    }, 2000);
                } else {
                    costEl.textContent = '$' + newCost.toFixed(4);
                }
                
                lastKnownCost = newCost;
            } catch (err) {
                console.error('Failed to load cost:', err);
            }
        }
        updateHeaderCost();
        setInterval(updateHeaderCost, 30000); // Update every 30s

        // ==================== NOTES ====================
        async function loadNotes() {
            try {
                const response = await fetch(`http://${baseHost}:8585/api/notes`);
                const data = await response.json();
                document.getElementById('admin-notes').value = data.notes || '';
            } catch (err) {
                console.error('Failed to load notes:', err);
            }
        }
        
        async function saveNotes() {
            const notes = document.getElementById('admin-notes').value;
            try {
                await fetch(`http://${baseHost}:8585/api/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                // Flash save button green
                const btn = document.querySelector('.notes-save');
                btn.textContent = '‚úì Saved';
                btn.style.background = '#22c55e';
                btn.style.color = '#000';
                setTimeout(() => {
                    btn.textContent = 'üíæ Save Notes';
                    btn.style.background = '';
                    btn.style.color = '';
                }, 1500);
            } catch (err) {
                console.error('Failed to save notes:', err);
            }
        }
        
        loadNotes();

        // ==================== PENDING TASK ====================
        const pendingSendBtn = document.getElementById('pending-send-btn');
        
        function showPendingBubble(text) {
            pendingMessage = text;
            pendingText.textContent = text;
            pendingBubble.classList.add('active');
            updatePendingSendBtn();
        }

        function hidePendingBubble() {
            pendingBubble.classList.remove('active');
            pendingMessage = '';
        }
        
        function updatePendingSendBtn() {
            pendingSendBtn.disabled = isBusy;
            pendingSendBtn.textContent = isBusy ? 'Send (when ready)' : 'Send Now';
        }
        
        async function copyPendingText() {
            try {
                await navigator.clipboard.writeText(pendingMessage);
                const original = pendingText.textContent;
                pendingText.textContent = '‚úì Copied!';
                setTimeout(() => pendingText.textContent = original, 1000);
            } catch (err) {
                console.error('Copy failed:', err);
            }
        }

        function sendPending() {
            if (pendingMessage && !isBusy) {
                addMessage('user', pendingMessage);
                ws.send(JSON.stringify({ type: 'chat', content: pendingMessage }));
                hidePendingBubble();
            }
        }

        function addTodo() {
            const priority = prioritySelect.value;
            const todoText = `Add to TODO (${priority}): ${pendingMessage}`;
            addMessage('system', `üìù Added to TODO [${priority.toUpperCase()}]: ${pendingMessage}`);
            // Could also send to server to persist
            ws.send(JSON.stringify({ type: 'todo', content: pendingMessage, priority }));
            hidePendingBubble();
        }

        function cancelPending() {
            hidePendingBubble();
        }

        // ==================== CHAT ====================
        function connect() {
            // Clear any pending reconnect
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                manualDisconnect = true;
                ws.close();
            }
            
            btnRefresh.classList.add('spinning');
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/chat`);

            ws.onopen = () => {
                status.textContent = 'Connected';
                status.className = 'status connected';
                btnRefresh.classList.remove('spinning');
                manualDisconnect = false;
                
                // Only show message once per session (persists across hot reloads)
                if (!sessionStorage.getItem('kittConnected')) {
                    sessionStorage.setItem('kittConnected', 'true');
                    addMessage('system', '‚úì Connected to "Kitt"', { fadeAfter: 10000 });
                }
                
                // Keep-alive ping every 25s to prevent mobile browsers from dropping connection
                if (window.keepAliveInterval) clearInterval(window.keepAliveInterval);
                window.keepAliveInterval = setInterval(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 25000);
            };

            ws.onclose = () => {
                status.textContent = 'Disconnected';
                status.className = 'status';
                btnRefresh.classList.remove('spinning');
                isBusy = false;
                updateKittStatus();
                
                // Clear keep-alive
                if (window.keepAliveInterval) {
                    clearInterval(window.keepAliveInterval);
                    window.keepAliveInterval = null;
                }
                
                // Only auto-reconnect if not manually disconnected
                if (!manualDisconnect) {
                    reconnectTimeout = setTimeout(connect, 3000);
                }
                manualDisconnect = false;
            };

            ws.onerror = () => btnRefresh.classList.remove('spinning');

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'thinking') {
                    showThinking();
                    isBusy = true;
                    updateKittStatus();
                    updatePendingSendBtn();
                    status.textContent = 'Thinking...';
                    status.className = 'status busy';
                } else if (msg.type === 'response') {
                    hideThinking();
                    addMessage('assistant', msg.content);
                    clearTroubleAlerts(); // Clear any error alerts on success
                    isBusy = false;
                    updateKittStatus();
                    updatePendingSendBtn();
                    updateHeaderCost(); // Update cost after each response
                    status.textContent = 'Connected';
                    status.className = 'status connected';
                } else if (msg.type === 'error') {
                    hideThinking();
                    addMessage('error', 'Error: ' + msg.content);
                    handleKittError(msg.content); // Show troubleshooting options
                    isBusy = false;
                    updateKittStatus();
                    updatePendingSendBtn();
                    status.textContent = 'Connected';
                    status.className = 'status connected';
                } else if (msg.type === 'busy_state') {
                    // Broadcast from server - sync busy state across all clients
                    isBusy = msg.busy;
                    updateKittStatus();
                    updatePendingSendBtn();
                    if (msg.busy) {
                        showThinking();
                        status.textContent = 'Busy...';
                        status.className = 'status busy';
                    } else {
                        hideThinking();
                        status.textContent = 'Connected';
                        status.className = 'status connected';
                    }
                } else if (msg.type === 'status') {
                    // Progress/status update while processing
                    updateThinkingStatus(msg.content);
                    status.textContent = msg.content || 'Working...';
                }
            };
        }

        btnRefresh.addEventListener('click', () => { addMessage('system', 'Reconnecting...'); connect(); });

        function addMessage(role, content, options = {}) {
            // Create wrapper for actions
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${role}`;
            
            // Create message bubble
            const div = document.createElement('div');
            div.className = `message ${role}`;
            content = content.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre>$2</pre>');
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
            div.innerHTML = content;
            
            // Create action buttons (for user/assistant messages only)
            if (role === 'user' || role === 'assistant') {
                const actions = document.createElement('div');
                actions.className = 'message-actions';
                actions.innerHTML = `
                    <button class="msg-action-btn" onclick="copyMessage(this)" title="Copy">üìã</button>
                    <button class="msg-action-btn" onclick="dismissMessage(this)" title="Dismiss">‚úó</button>
                `;
                wrapper.appendChild(actions);
            }
            
            wrapper.appendChild(div);
            chat.appendChild(wrapper);
            chat.scrollTop = chat.scrollHeight;
            
            // Auto-fade after specified time
            if (options.fadeAfter) {
                setTimeout(() => {
                    wrapper.style.transition = 'opacity 1s ease';
                    wrapper.style.opacity = '0';
                    setTimeout(() => wrapper.remove(), 1000);
                }, options.fadeAfter);
            }
        }
        
        function copyMessage(btn) {
            const wrapper = btn.closest('.message-wrapper');
            const message = wrapper.querySelector('.message');
            const text = message.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                btn.classList.add('copied');
                btn.textContent = '‚úì';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.textContent = 'üìã';
                }, 1500);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }
        
        function dismissMessage(btn) {
            const wrapper = btn.closest('.message-wrapper');
            wrapper.classList.toggle('dismissed');
        }
        
        function addSystemMessage(content) {
            addMessage('system', content, { fadeAfter: 5000 });
        }

        let thinkingEl = null;
        let thinkingTimer = null;
        let thinkingStartTime = null;
        
        function showThinking() {
            hideThinking();
            thinkingStartTime = Date.now();
            
            thinkingEl = document.createElement('div');
            thinkingEl.className = 'message thinking';
            thinkingEl.innerHTML = `
                <div class="thinking-content">
                    <span class="thinking-text">Thinking...</span>
                    <span class="thinking-status" id="thinking-status"></span>
                </div>
                <span class="thinking-timer" id="thinking-timer">0s</span>
            `;
            chat.appendChild(thinkingEl);
            chat.scrollTop = chat.scrollHeight;
            
            // Start timer
            thinkingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - thinkingStartTime) / 1000);
                const timerEl = document.getElementById('thinking-timer');
                if (timerEl) {
                    const mins = Math.floor(elapsed / 60);
                    const secs = elapsed % 60;
                    timerEl.textContent = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
                }
            }, 1000);
        }
        
        function updateThinkingStatus(status) {
            const statusEl = document.getElementById('thinking-status');
            if (statusEl) {
                statusEl.textContent = status;
            }
        }
        
        function hideThinking() { 
            if (thinkingTimer) { clearInterval(thinkingTimer); thinkingTimer = null; }
            if (thinkingEl) { thinkingEl.remove(); thinkingEl = null; } 
            thinkingStartTime = null;
        }

        function send() {
            const text = input.value.trim();
            if ((!text && attachments.length === 0) || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            if (isBusy) {
                showPendingBubble(text);
                input.value = '';
                return;
            }
            
            // Build message with attachments
            let displayText = text;
            if (attachments.length > 0) {
                displayText += `\nüìé ${attachments.length} attachment(s): ${attachments.map(a => a.name).join(', ')}`;
            }
            
            addMessage('user', displayText);
            
            // Send with attachment data
            const payload = { type: 'chat', content: text };
            if (attachments.length > 0) {
                payload.attachments = attachments.map(a => ({
                    name: a.name,
                    type: a.type,
                    dataUrl: a.dataUrl || null
                }));
            }
            
            ws.send(JSON.stringify(payload));
            input.value = '';
            clearAttachments();
        }

        // Dev machine detection - bypass Kitt for common commands
        const isDevMachine = ['localhost', '127.0.0.1', '192.168.1.42'].includes(location.hostname);
        
        // Update indicators for dev machine (show free/local instead of tokens/kitt)
        if (isDevMachine) {
            document.querySelectorAll('.admin-btn').forEach(btn => {
                const onclick = btn.getAttribute('onclick') || '';
                if (onclick.includes('sendQuick')) {
                    const indicators = btn.querySelector('.component-indicators');
                    if (indicators) {
                        indicators.innerHTML = '<span class="indicator-free">üÜì</span><span class="indicator-local">üíª</span>';
                    }
                }
            });
            console.log('üñ•Ô∏è Dev machine detected - using local commands (no token cost)');
        }
        
        // Local command handlers (no token cost)
        const localCommands = {
            'server status': async () => {
                const results = [];
                const checks = [
                    { name: 'SimWidget', port: 8080, endpoint: '/api/status' },
                    { name: 'Agent', port: 8585, endpoint: '/api/health' },
                    { name: 'Remote', port: 8590, endpoint: '/api/health' },
                    { name: 'Master', port: 8500, endpoint: '/api/health' },
                    { name: 'Relay', port: 8600, endpoint: '/api/health' }
                ];
                for (const svc of checks) {
                    try {
                        const res = await fetch(`http://${baseHost}:${svc.port}${svc.endpoint}`, { timeout: 2000 });
                        results.push(`${svc.name}: ${res.ok ? '‚úÖ Running' : '‚ùå Down'} (:${svc.port})`);
                    } catch { results.push(`${svc.name}: ‚ùå Offline (:${svc.port})`); }
                }
                return `**Service Status**\n${results.join('\n')}`;
            },
            'restart server': async () => {
                try {
                    await fetch(`http://${baseHost}:8585/api/simwidget/restart`, { method: 'POST' });
                    return '‚úÖ SimWidget server restart triggered';
                } catch (e) { return `‚ùå Restart failed: ${e.message}`; }
            },
            'show errors': async () => {
                try {
                    const res = await fetch(`http://${baseHost}:8585/api/logs/errors`);
                    const data = await res.json();
                    return data.log || 'No errors found';
                } catch (e) { return `‚ùå Failed to fetch errors: ${e.message}`; }
            },
            'list processes': async () => {
                try {
                    const res = await fetch(`http://${baseHost}:8585/api/processes`);
                    const data = await res.json();
                    if (data.processes) {
                        return `**Running Processes**\n${data.processes.slice(0, 10).map(p => `${p.name}: ${p.pid}`).join('\n')}`;
                    }
                    return 'Process list unavailable';
                } catch (e) { return `‚ùå Failed: ${e.message}`; }
            },
            'disk usage': async () => {
                try {
                    const res = await fetch(`http://${baseHost}:8585/api/disk`);
                    const data = await res.json();
                    return data.usage || 'Disk info unavailable';
                } catch (e) { return `‚ùå Failed: ${e.message}`; }
            }
        };
        
        async function executeLocal(cmd, btn) {
            if (localCommands[cmd]) {
                if (btn) setButtonState(btn, 'loading', '‚è≥');
                addMessage('user', cmd);
                addMessage('system', '‚ö° Executing locally (no tokens)...');
                try {
                    const result = await localCommands[cmd]();
                    addMessage('assistant', result);
                    if (btn) setButtonState(btn, 'success', '‚úì', 1500);
                } catch (e) {
                    addMessage('error', `Local execution failed: ${e.message}`);
                    if (btn) setButtonState(btn, 'error', '‚úó', 1500);
                }
                return true;
            }
            return false;
        }
        
        function sendQuick(text) {
            const btn = event?.target?.closest('.admin-btn, .quick-btn');
            closeAllPanels();
            if (isBusy) {
                showPendingBubble(text);
                return;
            }
            // Try local execution first on dev machine
            if (isDevMachine && localCommands[text]) {
                executeLocal(text, btn);
                return;
            }
            // For Kitt commands, show loading then let response handling show result
            if (btn) setButtonState(btn, 'loading', '‚è≥');
            input.value = text;
            send();
            // Reset button after send (Kitt response will show in chat)
            if (btn) setTimeout(() => setButtonState(btn, 'success', '‚úì', 1000), 500);
        }
        
        btnSend.addEventListener('click', send);
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') send(); });

        // Voice
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'en-US';
            recognition.onstart = () => btnVoice.classList.add('listening');
            recognition.onend = () => btnVoice.classList.remove('listening');
            recognition.onresult = (e) => { input.value = e.results[0][0].transcript; send(); };
            btnVoice.addEventListener('click', () => btnVoice.classList.contains('listening') ? recognition.stop() : recognition.start());
        } else { btnVoice.style.display = 'none'; }

        connect();
    </script>
    <script src="todo-module.js"></script>
    <script src="component-tester.js"></script>
    <script src="hot-update/hot-client.js"></script>
    <script>
        // Initialize TODO module
        TodoModule.init(null, {
            assistantName: 'Kitt',
            inputSelector: '#message-input'
        });
        
        // Server control configuration
        const serverConfig = {
            master: { port: 8500, name: 'Master (O)', canStart: false },
            simwidget: { port: 8080, name: 'Main Server', canStart: true, healthEndpoint: '/api/status' },
            agent: { port: 8585, name: 'Agent (Kitt)', canStart: true },
            remote: { port: 8590, name: 'Remote Support', canStart: true },
            relay: { port: 8600, name: 'Relay Service', canStart: true }
        };
        
        // Relay mode functions
        async function checkRelayStatus() {
            try {
                const res = await fetch(`http://${baseHost}:8585/api/relay`);
                const data = await res.json();
                document.getElementById('relay-status').textContent = data.enabled ? 'ON' : 'OFF';
                document.getElementById('relay-toggle').style.background = data.enabled ? '#22c55e' : '#333';
                
                // Check queue
                const queueRes = await fetch(`http://${baseHost}:8600/api/health`);
                if (queueRes.ok) {
                    const queueData = await queueRes.json();
                    document.getElementById('relay-queue').textContent = `Queue: ${queueData.queue.pending}`;
                }
            } catch (e) {
                document.getElementById('relay-status').textContent = 'ERR';
            }
        }
        
        async function toggleRelayMode() {
            const btn = document.getElementById('relay-toggle');
            try {
                const current = await fetch(`http://${baseHost}:8585/api/relay`).then(r => r.json());
                const newState = !current.enabled;
                
                await fetch(`http://${baseHost}:8585/api/relay`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: newState })
                });
                
                document.getElementById('relay-status').textContent = newState ? 'ON' : 'OFF';
                btn.style.background = newState ? '#22c55e' : '#333';
                
                addMessage('system', `Relay mode ${newState ? 'ENABLED' : 'DISABLED'}. ${newState ? 'Messages will be routed to Claude Desktop.' : 'Messages will use direct API.'}`);
            } catch (e) {
                addMessage('system', 'Failed to toggle relay mode: ' + e.message);
            }
        }
        
        // Check relay status on load
        setTimeout(checkRelayStatus, 2000);
        setInterval(checkRelayStatus, 10000);
        
        // ============================================
        // TROUBLESHOOTING FUNCTIONS
        // ============================================
        
        let lastError = null;
        
        function showTroubleAlert(type, message, actions = []) {
            const alertsDiv = document.getElementById('trouble-alerts');
            if (!alertsDiv) return;
            
            const colors = {
                error: { bg: '#442222', border: '#ff6666', text: '#ff8888' },
                warning: { bg: '#443322', border: '#ffaa44', text: '#ffcc88' },
                info: { bg: '#223344', border: '#4a9eff', text: '#88ccff' }
            };
            const c = colors[type] || colors.info;
            
            let actionsHtml = actions.map(a => 
                `<button onclick="${a.action}" style="background:${c.border};color:#000;border:none;padding:4px 8px;border-radius:4px;margin-right:4px;cursor:pointer;font-size:11px;">${a.label}</button>`
            ).join('');
            
            alertsDiv.innerHTML = `
                <div style="background:${c.bg};border:1px solid ${c.border};border-radius:6px;padding:10px;margin-bottom:8px;">
                    <div style="color:${c.text};font-size:12px;margin-bottom:${actions.length ? '8px' : '0'};">${message}</div>
                    ${actionsHtml}
                </div>
            `;
        }
        
        function clearTroubleAlerts() {
            const alertsDiv = document.getElementById('trouble-alerts');
            if (alertsDiv) alertsDiv.innerHTML = '';
        }
        
        async function resetKitt() {
            try {
                await fetch(`http://${baseHost}:8585/api/kitt/reset`, { method: 'POST' });
                hideThinking();
                isBusy = false;
                updateKittStatus();
                addMessage('system', '‚úÖ Kitt state reset');
                clearTroubleAlerts();
            } catch (e) {
                addMessage('error', 'Failed to reset Kitt: ' + e.message);
            }
        }
        
        async function showQueuePanel() {
            try {
                const res = await fetch(`http://${baseHost}:8600/api/queue`);
                const data = await res.json();
                
                let html = `<h3 style="margin:0 0 12px 0;color:#4a9eff;">Message Queue (${data.total})</h3>`;
                
                if (data.messages.length === 0) {
                    html += '<p style="color:#888;">No messages in queue</p>';
                } else {
                    data.messages.forEach(m => {
                        const statusColor = m.status === 'pending' ? '#ffd700' : m.status === 'processing' ? '#4a9eff' : '#22c55e';
                        html += `
                            <div style="background:#2a2a3e;padding:10px;border-radius:6px;margin-bottom:8px;border-left:3px solid ${statusColor};">
                                <div style="font-size:11px;color:#888;margin-bottom:4px;">${m.status.toUpperCase()} - ${m.id}</div>
                                <div style="font-size:13px;color:#eee;margin-bottom:8px;">${m.preview}</div>
                                ${m.status === 'pending' ? `
                                    <input type="text" id="resp-${m.id}" placeholder="Type response..." style="width:100%;background:#1a1a2e;border:1px solid #333;color:#eee;padding:6px;border-radius:4px;margin-bottom:6px;box-sizing:border-box;">
                                    <button onclick="sendQueueResponse('${m.id}')" style="background:#4a9eff;color:#000;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;">Send Response</button>
                                ` : ''}
                            </div>
                        `;
                    });
                }
                
                html += `<button onclick="clearCompletedQueue()" style="background:#333;color:#ccc;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;margin-top:8px;">üóëÔ∏è Clear Completed</button>`;
                
                showModal('Queue', html);
            } catch (e) {
                addMessage('error', 'Failed to load queue: ' + e.message);
            }
        }
        
        async function sendQueueResponse(messageId) {
            const input = document.getElementById(`resp-${messageId}`);
            if (!input || !input.value.trim()) return;
            
            try {
                await fetch(`http://${baseHost}:8600/api/queue/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messageId, response: input.value.trim() })
                });
                addMessage('system', '‚úÖ Response sent to queue');
                showQueuePanel(); // Refresh
            } catch (e) {
                addMessage('error', 'Failed to send response: ' + e.message);
            }
        }
        
        async function clearCompletedQueue() {
            try {
                await fetch(`http://${baseHost}:8600/api/queue`, { method: 'DELETE' });
                showQueuePanel(); // Refresh
            } catch (e) {
                addMessage('error', 'Failed to clear queue: ' + e.message);
            }
        }
        
        function showModal(title, content) {
            // Remove existing modal
            const existing = document.getElementById('trouble-modal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'trouble-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
            modal.innerHTML = `
                <div style="background:#1a1a2e;border:1px solid #333;border-radius:12px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;padding:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <h2 style="margin:0;color:#fff;font-size:16px;">${title}</h2>
                        <button onclick="document.getElementById('trouble-modal').remove()" style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;">&times;</button>
                    </div>
                    <div>${content}</div>
                </div>
            `;
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
            document.body.appendChild(modal);
        }
        
        // Detect errors and show troubleshooting alerts
        function handleKittError(errorMsg) {
            lastError = errorMsg;
            
            if (errorMsg.includes('credit balance') || errorMsg.includes('API')) {
                showTroubleAlert('error', 'üí≥ API credits exhausted! Enable Relay Mode to use Claude Desktop instead.', [
                    { label: 'üîÑ Enable Relay', action: 'toggleRelayMode()' },
                    { label: 'üì¨ View Queue', action: 'showQueuePanel()' }
                ]);
            } else if (errorMsg.includes('Timeout') || errorMsg.includes('not responding')) {
                showTroubleAlert('warning', '‚è±Ô∏è Claude Desktop not responding. Check if Claude Desktop is open with this chat.', [
                    { label: 'üîÑ Reset Kitt', action: 'resetKitt()' },
                    { label: 'üì¨ View Queue', action: 'showQueuePanel()' }
                ]);
            } else if (errorMsg.includes('Relay') || errorMsg.includes('8600')) {
                showTroubleAlert('error', 'üîå Relay service not running. Start it or disable relay mode.', [
                    { label: '‚ñ∂Ô∏è Start Relay', action: 'startServer("relay")' },
                    { label: 'üîÑ Disable Relay', action: 'toggleRelayMode()' }
                ]);
            } else {
                showTroubleAlert('error', `‚ùå ${errorMsg}`, [
                    { label: 'üîÑ Reset Kitt', action: 'resetKitt()' }
                ]);
            }
        }
        
        // Check for issues periodically
        async function checkForIssues() {
            try {
                // Check if Kitt is stuck
                const kittRes = await fetch(`http://${baseHost}:8585/api/kitt/status`);
                const kittStatus = await kittRes.json();
                
                if (kittStatus.busy && kittStatus.since) {
                    const busyTime = Date.now() - new Date(kittStatus.since).getTime();
                    if (busyTime > 120000) { // Stuck for > 2 minutes
                        showTroubleAlert('warning', `‚è≥ Kitt has been busy for ${Math.floor(busyTime/60000)}+ minutes`, [
                            { label: 'üîÑ Reset Kitt', action: 'resetKitt()' },
                            { label: 'üì¨ View Queue', action: 'showQueuePanel()' }
                        ]);
                    }
                }
                
                // Check queue for pending messages
                const queueRes = await fetch(`http://${baseHost}:8600/api/health`);
                const queueStatus = await queueRes.json();
                if (queueStatus.queue.pending > 0) {
                    const queueEl = document.getElementById('relay-queue');
                    if (queueEl) queueEl.innerHTML = `<span style="color:#ffd700;">üì¨ ${queueStatus.queue.pending} pending</span>`;
                }
            } catch (e) {
                // Silently fail - services might be down
            }
        }
        
        // Run issue check every 30 seconds
        setInterval(checkForIssues, 30000);
        setTimeout(checkForIssues, 5000);
        
        // ============================================
        // GAMING DEVICES FUNCTIONS
        // ============================================
        
        async function disableGamingDevices() {
            const statusEl = document.getElementById('device-status');
            statusEl.innerHTML = '<span style="color:#eab308;">‚è≥ Disabling devices...</span>';
            try {
                const res = await fetch(`http://${baseHost}:8585/api/devices/gaming/disable`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    statusEl.innerHTML = `<span style="color:#22c55e;">‚úÖ ${data.message}</span>`;
                    addMessage('system', `üéÆ ${data.message}`);
                } else {
                    statusEl.innerHTML = `<span style="color:#ef4444;">‚ùå ${data.error}</span>`;
                }
            } catch (e) {
                statusEl.innerHTML = `<span style="color:#ef4444;">‚ùå ${e.message}</span>`;
            }
        }
        
        async function enableGamingDevices() {
            const statusEl = document.getElementById('device-status');
            statusEl.innerHTML = '<span style="color:#eab308;">‚è≥ Enabling devices...</span>';
            try {
                const res = await fetch(`http://${baseHost}:8585/api/devices/gaming/enable`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    statusEl.innerHTML = `<span style="color:#22c55e;">‚úÖ ${data.message}</span>`;
                    addMessage('system', `üéÆ ${data.message}`);
                } else {
                    statusEl.innerHTML = `<span style="color:#ef4444;">‚ùå ${data.error}</span>`;
                }
            } catch (e) {
                statusEl.innerHTML = `<span style="color:#ef4444;">‚ùå ${e.message}</span>`;
            }
        }
        
        async function showGamingDevices() {
            try {
                const res = await fetch(`http://${baseHost}:8585/api/devices/gaming`);
                const data = await res.json();
                
                let html = '<h3 style="margin:0 0 12px 0;color:#4a9eff;">Gaming Devices</h3>';
                
                if (!data.devices || data.devices.length === 0) {
                    html += '<p style="color:#888;">No gaming devices found</p>';
                } else {
                    data.devices.forEach(d => {
                        const statusColor = d.Status === 'OK' ? '#22c55e' : '#ef4444';
                        const statusIcon = d.Status === 'OK' ? '‚úÖ' : 'üö´';
                        html += `
                            <div style="background:#2a2a3e;padding:10px;border-radius:6px;margin-bottom:8px;border-left:3px solid ${statusColor};">
                                <div style="font-size:13px;color:#eee;">${statusIcon} ${d.FriendlyName}</div>
                                <div style="font-size:11px;color:#888;margin-top:4px;">${d.Status} ‚Ä¢ ${d.Class}</div>
                            </div>
                        `;
                    });
                }
                
                showModal('Gaming Devices', html);
                
                // Update status line
                const enabled = data.devices.filter(d => d.Status === 'OK').length;
                const disabled = data.devices.filter(d => d.Status !== 'OK').length;
                document.getElementById('device-status').innerHTML = `${enabled} enabled, ${disabled} disabled`;
            } catch (e) {
                addMessage('error', 'Failed to list devices: ' + e.message);
            }
        }
        
        // Check device status on load
        setTimeout(async () => {
            try {
                const res = await fetch(`http://${baseHost}:8585/api/devices/gaming`);
                const data = await res.json();
                if (data.devices) {
                    const enabled = data.devices.filter(d => d.Status === 'OK').length;
                    const disabled = data.devices.filter(d => d.Status !== 'OK').length;
                    document.getElementById('device-status').innerHTML = `${enabled} enabled, ${disabled} disabled`;
                }
            } catch (e) {}
        }, 3000);
        
        // Check single server status
        async function checkServer(serverId) {
            const dot = document.getElementById(`dot-${serverId}`);
            const config = serverConfig[serverId];
            if (!dot || !config) return false;
            
            dot.className = 'server-dot checking';
            try {
                const endpoint = config.healthEndpoint || '/api/health';
                const res = await fetch(`http://${baseHost}:${config.port}${endpoint}`, { 
                    method: 'GET',
                    signal: AbortSignal.timeout(2000)
                });
                dot.className = res.ok ? 'server-dot running' : 'server-dot stopped';
                return res.ok;
            } catch {
                dot.className = 'server-dot stopped';
                return false;
            }
        }
        
        // Check all servers
        async function checkAllServers() {
            const btn = event?.target;
            if (btn) setButtonState(btn, 'loading', 'üîç');
            
            const results = [];
            for (const [id, config] of Object.entries(serverConfig)) {
                const running = await checkServer(id);
                results.push(`${config.name} :${config.port} - ${running ? '‚úÖ' : '‚ùå'}`);
            }
            
            if (btn) setButtonState(btn, 'success', '‚úì', 1500);
            addMessage('system', `**Server Status**\n${results.join('\n')}`);
        }
        
        // Button state helper
        function setButtonState(btn, state, text, resetMs = 0) {
            if (!btn) return;
            const original = btn.innerHTML;
            btn.classList.remove('loading', 'success', 'error');
            btn.classList.add(state);
            if (text) btn.innerHTML = text;
            
            if (resetMs > 0) {
                setTimeout(() => {
                    btn.classList.remove('loading', 'success', 'error');
                    btn.innerHTML = original;
                }, resetMs);
            }
        }
        
        // Start single server via Master (O) API
        async function startServer(serverId) {
            const config = serverConfig[serverId];
            const row = document.querySelector(`[data-server="${serverId}"]`);
            const btn = row?.querySelector('.server-btn.start');
            const dot = document.getElementById(`dot-${serverId}`);
            
            // Set loading state
            if (btn) setButtonState(btn, 'loading', '‚è≥');
            if (dot) dot.className = 'server-dot starting';
            addMessage('system', `‚ñ∂ Starting ${config.name}...`);
            
            try {
                const res = await fetch(`http://${baseHost}:8500/api/services/${serverId}/start`, { method: 'POST' });
                if (res.ok) {
                    if (btn) setButtonState(btn, 'success', '‚úì', 2000);
                    addMessage('system', `‚úÖ ${config.name} start requested`);
                    setTimeout(() => checkServer(serverId), 3000);
                } else {
                    if (btn) setButtonState(btn, 'error', '‚úó', 2000);
                    if (dot) dot.className = 'server-dot stopped';
                    addMessage('error', `‚ùå Failed to start ${config.name}`);
                }
            } catch (e) {
                if (btn) setButtonState(btn, 'error', '‚úó', 2000);
                if (dot) dot.className = 'server-dot stopped';
                addMessage('error', `‚ùå Master (O) unavailable. Start manually or launch Master first.`);
            }
        }
        
        // Start all servers (sas command)
        async function startAllServers() {
            const btn = event?.target?.closest('.admin-btn');
            if (btn) setButtonState(btn, 'loading', '‚è≥ Starting...');
            
            addMessage('system', 'üöÄ Starting all servers (sas)...');
            closeAllPanels();
            
            for (const [id, config] of Object.entries(serverConfig)) {
                const dot = document.getElementById(`dot-${id}`);
                if (dot) dot.className = 'server-dot starting';
            }
            
            try {
                const res = await fetch(`http://${baseHost}:8500/api/start-all`, { method: 'POST' });
                if (res.ok) {
                    if (btn) setButtonState(btn, 'success', '‚úì Started', 2000);
                    addMessage('system', '‚úÖ All servers start requested via Master (O)');
                    setTimeout(checkAllServers, 4000);
                } else {
                    if (btn) setButtonState(btn, 'error', '‚úó Failed', 2000);
                    addMessage('error', '‚ùå Start all failed');
                }
            } catch (e) {
                if (btn) setButtonState(btn, 'error', '‚úó Error', 2000);
                addMessage('error', '‚ùå Master (O) not running. Start Master first at :8500');
            }
        }
        
        // Check servers on page load
        setTimeout(() => {
            for (const id of Object.keys(serverConfig)) {
                checkServer(id);
            }
        }, 1000);
        
        // Load Quick Reference dynamically
        async function loadQuickReference() {
            const container = document.getElementById('quick-ref-section');
            if (!container) return;
            
            try {
                const res = await fetch(`http://${location.hostname}:8585/api/quick-reference`);
                const data = await res.json();
                
                if (data.categories) {
                    let html = '';
                    for (const [catId, cat] of Object.entries(data.categories)) {
                        html += `<div style="margin-bottom: 8px;"><strong style="color:#4a9eff;font-size:10px;">${cat.label}</strong></div>`;
                        for (const [abbrev, meaning] of Object.entries(cat.items)) {
                            html += `<div><b>${abbrev}</b> = ${meaning}</div>`;
                        }
                    }
                    container.innerHTML = html;
                }
            } catch (err) {
                container.innerHTML = '<div style="color:#ff6666;">Failed to load</div>';
            }
        }
        
        // Show TODO insight modal
        async function showTodoInsight() {
            const task = prompt('Enter task to get Kitt insights on:');
            if (!task) return;
            
            try {
                addSystemMessage('üí° Getting Kitt insights...');
                const res = await fetch(`http://${location.hostname}:8585/api/todo-insight`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task })
                });
                const data = await res.json();
                if (data.insight) {
                    addMessage('assistant', `**üí° Kitt's Insights on: "${task}"**\n\n${data.insight}`);
                }
            } catch (err) {
                addMessage('error', 'Failed to get insight: ' + err.message);
            }
            closeAllPanels();
        }
        
        // Load on page ready
        loadQuickReference();
    </script>
</body>
</html>



