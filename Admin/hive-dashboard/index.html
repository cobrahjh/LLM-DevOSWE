<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hive Command Center</title>
    <link id="favicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23666'/></svg>">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .header h1 {
            font-size: 28px;
            background: linear-gradient(90deg, #ff6b35, #ff9f1c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .header .time {
            color: #888;
            font-size: 14px;
            font-family: monospace;
        }
        .btn {
            background: linear-gradient(135deg, #ff6b35, #ff9f1c);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255,107,53,0.3); }
        .btn:active { transform: translateY(0); }
        .btn.secondary { background: #2a2a3e; }
        .btn.secondary:hover { background: #3a3a4e; box-shadow: none; }
        .btn.small { padding: 4px 10px; font-size: 11px; }

        /* Tooltips */
        [title] {
            position: relative;
        }
        .btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #0f0f1a;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
            margin-bottom: 5px;
            border: 1px solid #333;
            max-width: 250px;
            white-space: normal;
            text-align: center;
        }

        /* Grid Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 20px;
        }

        /* Cards */
        .card {
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid #2a2a3e;
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-header h2 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
        }
        .card-header .badge {
            background: #2a2a3e;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            color: #aaa;
        }

        /* Briefing Card */
        .briefing-card { grid-column: span 2; }
        .briefing-content {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        .briefing-stat {
            text-align: center;
            padding: 10px 8px;
            background: #0f0f1a;
            border-radius: 8px;
        }
        .briefing-stat .value {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }
        .briefing-stat .label {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
            text-transform: uppercase;
        }
        .briefing-stat.good .value { color: #00ff88; }
        .briefing-stat.warn .value { color: #ffaa00; }
        .briefing-stat.bad .value { color: #ff4444; }
        .briefing-summary {
            margin-top: 10px;
            padding: 12px;
            background: #0f0f1a;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            color: #ccc;
            max-height: 140px;
            overflow-y: auto;
        }

        /* Services Grid */
        .services-card { grid-column: span 1; }
        .service-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .service-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #0f0f1a;
            border-radius: 6px;
            border-left: 3px solid #333;
            cursor: pointer;
            transition: all 0.2s;
        }
        .service-item:hover {
            background: #1a1a2e;
            transform: translateX(3px);
        }
        .service-item.online { border-left-color: #00ff88; }
        .service-item.offline { border-left-color: #ff4444; }
        .service-item.error { border-left-color: #ffaa00; }
        .service-name { font-size: 13px; font-weight: 500; }
        .service-port { font-size: 11px; color: #666; font-family: monospace; }
        .service-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            background: #1a1a2e;
        }
        .service-item.online .service-status { color: #00ff88; }
        .service-item.offline .service-status { color: #ff4444; }
        .service-open {
            font-size: 10px;
            color: #666;
            margin-left: 8px;
        }
        .service-item:hover .service-open { color: #ff6b35; }

        .restart-btn {
            background: none;
            border: 1px solid #444;
            color: #888;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s;
            padding: 0;
        }
        .restart-btn.show { opacity: 0.8; }
        .service-item:hover .restart-btn { opacity: 1; }
        .restart-btn:hover { color: #ff6b35; border-color: #ff6b35; }
        .restart-btn.spinning { animation: spin 1s linear infinite; opacity: 1; color: #00d9ff; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Intel Feed */
        .intel-card { grid-column: span 2; }
        .intel-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .intel-tab {
            padding: 8px 16px;
            background: #0f0f1a;
            border: none;
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .intel-tab.active {
            background: linear-gradient(135deg, #ff6b35, #ff9f1c);
            color: #fff;
        }
        .intel-tab:hover:not(.active) { background: #1a1a2e; color: #fff; }
        .intel-content { max-height: 300px; overflow-y: auto; }
        .intel-item {
            padding: 12px;
            background: #0f0f1a;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }
        .intel-item:hover { background: #1a1a2e; }
        .intel-item .title { font-size: 13px; color: #fff; margin-bottom: 5px; }
        .intel-item .title a { color: inherit; text-decoration: none; }
        .intel-item .title a:hover { color: #ff6b35; }
        .intel-item .meta { font-size: 11px; color: #666; display: flex; gap: 15px; }
        .intel-item .tag {
            background: #2a2a3e;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            color: #00d9ff;
        }
        .intel-item .tag.ai { background: #1a3a2e; color: #00ff88; }
        .intel-item .tag.release { background: #3a2a1e; color: #ff9f1c; }

        /* Health Card */
        .health-card { grid-column: span 1; }
        .health-trend {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .trend-indicator { font-size: 32px; }
        .trend-text { font-size: 14px; }
        .trend-text .status { font-weight: 600; }
        .trend-text .status.improving { color: #00ff88; }
        .trend-text .status.stable { color: #ffaa00; }
        .trend-text .status.degrading { color: #ff4444; }
        .health-chart {
            height: 120px;
            background: #0f0f1a;
            border-radius: 8px;
            display: flex;
            align-items: flex-end;
            padding: 10px;
            gap: 2px;
        }
        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #ff6b35, #ff9f1c);
            border-radius: 2px 2px 0 0;
            min-height: 4px;
            transition: height 0.3s;
        }
        .chart-bar.low { background: linear-gradient(to top, #ff4444, #ff6666); }

        /* Collapsible Sections */
        .collapsible-card { grid-column: span 1; }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 0;
            border-bottom: 1px solid #2a2a3e;
            margin-bottom: 10px;
        }
        .collapsible-header:hover { color: #ff6b35; }
        .collapsible-header h3 {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .collapsible-header .count {
            background: #2a2a3e;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }
        .collapsible-toggle {
            font-size: 12px;
            color: #666;
            transition: transform 0.3s;
        }
        .collapsible-toggle.collapsed { transform: rotate(-90deg); }
        .collapsible-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.collapsed {
            max-height: 0;
        }
        .collapsible-list {
            max-height: 200px;
            overflow-y: auto;
        }

        /* Anomaly Items */
        .anomaly-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: #0f0f1a;
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid #ff4444;
            cursor: pointer;
            transition: all 0.2s;
        }
        .anomaly-item:hover {
            background: #1a1a2e;
            transform: translateX(3px);
        }
        .anomaly-item.medium { border-left-color: #ffaa00; }
        .anomaly-icon { font-size: 18px; }
        .anomaly-info { flex: 1; }
        .anomaly-services { font-size: 13px; color: #fff; }
        .anomaly-time { font-size: 11px; color: #666; }
        .anomaly-drill { font-size: 10px; color: #666; }
        .anomaly-item:hover .anomaly-drill { color: #ff6b35; }

        /* Model Items */
        .model-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            background: #0f0f1a;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
        }
        .model-name { color: #fff; font-family: monospace; }
        .model-size { color: #666; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .modal-header h2 { color: #ff6b35; font-size: 18px; }
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }
        .modal-close:hover { color: #fff; }
        .modal-body { font-size: 14px; line-height: 1.6; }
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #2a2a3e;
        }
        .detail-label { color: #888; }
        .detail-value { color: #fff; font-family: monospace; }
        .detail-value.online { color: #00ff88; }
        .detail-value.offline { color: #ff4444; }

        /* Bottom Section - Full Width */
        .bottom-section {
            grid-column: span 3;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        /* MCP Server Items */
        .mcp-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: #0f0f1a;
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid #333;
            font-size: 12px;
        }
        .mcp-item.online { border-left-color: #00d9ff; }
        .mcp-item.stopped { border-left-color: #666; }
        .mcp-item.error { border-left-color: #ff4444; }
        .mcp-name { color: #fff; font-weight: 500; }
        .mcp-tools { color: #666; font-size: 10px; }
        .mcp-status-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            background: #2a2a3e;
        }
        .mcp-item.online .mcp-status-badge { color: #00d9ff; }
        .mcp-item.stopped .mcp-status-badge { color: #666; }

        /* Alert Items */
        .alert-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: #0f0f1a;
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 3px solid #ff4444;
            font-size: 12px;
        }
        .alert-item.info { border-left-color: #00d9ff; }
        .alert-item.warning { border-left-color: #ffaa00; }
        .alert-item.error { border-left-color: #ff4444; }
        .alert-item.critical { border-left-color: #ff0066; }
        .alert-icon { font-size: 14px; }
        .alert-info { flex: 1; }
        .alert-title { color: #fff; font-size: 12px; }
        .alert-time { color: #666; font-size: 10px; }
        .alert-ack { font-size: 10px; color: #666; cursor: pointer; padding: 2px 6px; border-radius: 4px; background: #2a2a3e; border: none; }
        .alert-ack:hover { color: #00ff88; background: #1a3a2e; }

        /* Loading & Scrollbar */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top-color: #ff6b35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f0f1a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* Responsive */
        @media (max-width: 1400px) {
            .bottom-section { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 1200px) {
            .dashboard { grid-template-columns: 1fr 1fr; }
            .briefing-card, .intel-card { grid-column: span 2; }
            .bottom-section { grid-column: span 2; grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .briefing-card, .intel-card, .bottom-section { grid-column: span 1; }
            .bottom-section { grid-template-columns: 1fr; }
            .briefing-content { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Hive Command Center</h1>
        <div class="header-actions">
            <span class="time" id="currentTime"></span>
            <span id="lastRefresh" style="color:#666;font-size:11px;margin-right:8px;"></span>
            <a href="/admin.html" class="btn secondary" style="text-decoration:none;margin-right:6px;" title="Admin Console - Services, LLM, Devices, Voice">Admin</a>
            <a href="http://localhost:8585" target="_blank" class="btn secondary" style="text-decoration:none;margin-right:6px;" title="KittBox Command Center">KittBox</a>
            <button class="btn secondary" onclick="refreshAll()" title="Refresh all dashboard data (Shortcut: R)">Refresh</button>
            <button class="btn" style="background:#ff4444" onclick="restartAllOffline()" title="Restart all offline services via Master-O">Restart Offline</button>
            <button class="btn" onclick="forceIntelRefresh()" title="Force fetch fresh intel from all sources (HN, GitHub, Models)">Force Intel</button>
            <button class="btn secondary" onclick="exportStatus()" title="Copy system status to clipboard">Export</button>
            <button class="btn secondary" onclick="openCmdPalette()" title="Quick command palette (Ctrl+K)" style="font-size:11px;padding:6px 10px;">Ctrl+K</button>
            <button class="btn secondary" onclick="openSettings()" title="Dashboard settings" style="font-size:14px;padding:5px 10px;">&#9881;</button>
        </div>
    </div>

    <!-- System Resource Bar -->
    <div id="systemBar" style="display:flex;gap:20px;align-items:center;padding:8px 16px;background:rgba(15,15,26,0.8);border:1px solid #2a2a3e;border-radius:8px;margin-bottom:16px;font-size:11px;color:#888;">
        <span style="color:#666;">SYSTEM</span>
        <span>CPU: <span id="sysCpu" style="color:#fff;">--</span>%</span>
        <div style="flex:0 0 60px;height:6px;background:#1a1a2e;border-radius:3px;overflow:hidden;"><div id="sysCpuBar" style="height:100%;width:0%;background:#ff6b35;border-radius:3px;transition:width 0.5s;"></div></div>
        <span>RAM: <span id="sysRam" style="color:#fff;">--</span>%</span>
        <div style="flex:0 0 60px;height:6px;background:#1a1a2e;border-radius:3px;overflow:hidden;"><div id="sysRamBar" style="height:100%;width:0%;background:#00d9ff;border-radius:3px;transition:width 0.5s;"></div></div>
        <span>Host: <span id="sysHost" style="color:#aaa;">--</span></span>
        <span>Uptime: <span id="sysUptime" style="color:#aaa;">--</span></span>
        <span style="margin-left:auto;color:#555;">Node <span id="sysNode">--</span></span>
    </div>

    <div class="dashboard">
        <!-- Briefing Card -->
        <div class="card briefing-card">
            <div class="card-header">
                <h2>Daily Briefing</h2>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="btn small secondary" onclick="regenerateBriefing(this)" title="Force-regenerate briefing from Oracle (fetches fresh data)">Regenerate</button>
                    <span class="badge" id="briefingDate">Loading...</span>
                </div>
            </div>
            <div class="briefing-content" id="briefingStats">
                <div class="loading">Loading briefing</div>
            </div>
            <div class="briefing-summary" id="briefingSummary"></div>
        </div>

        <!-- Services Card -->
        <div class="card services-card">
            <div class="card-header">
                <h2>Services</h2>
                <span class="badge" id="servicesCount">0/0</span>
            </div>
            <input type="text" id="serviceFilter" placeholder="Filter services..." oninput="filterServices()"
                style="width:100%;background:#0f0f1a;border:1px solid #333;border-radius:6px;padding:6px 10px;color:#e0e0e0;font-size:12px;margin-bottom:10px;outline:none;">
            <div class="service-list" id="servicesList" style="max-height:600px;overflow-y:auto;">
                <div class="loading">Loading</div>
            </div>
        </div>

        <!-- Intel Feed Card -->
        <div class="card intel-card">
            <div class="card-header">
                <h2>Intel Feed</h2>
                <span class="badge" id="intelUpdated">--</span>
            </div>
            <div class="intel-tabs">
                <button class="intel-tab active" data-tab="news">HN News</button>
                <button class="intel-tab" data-tab="github">GitHub</button>
                <button class="intel-tab" data-tab="discoveries">Discoveries</button>
                <button class="intel-tab" data-tab="websearch">Web Search</button>
            </div>
            <div class="intel-content" id="intelContent">
                <div class="loading">Loading intel</div>
            </div>
        </div>

        <!-- Health Card -->
        <div class="card health-card">
            <div class="card-header">
                <h2>Health Trends</h2>
                <span class="badge" id="healthSamples">0 samples</span>
            </div>
            <div class="health-trend" id="healthTrend">
                <span class="trend-indicator">ðŸ“Š</span>
                <div class="trend-text">
                    <div>Trend: <span class="status">--</span></div>
                    <div style="color:#666;font-size:12px">Avg: <span id="healthAvg">--</span> services</div>
                </div>
            </div>
            <div class="health-chart" id="healthChart"></div>
            <div id="incidentTimeline" style="margin-top:12px;"></div>
        </div>

        <!-- Claude Performance Card -->
        <div class="card claude-perf-card">
            <div class="card-header">
                <h2>Claude Code</h2>
                <button class="btn small secondary" onclick="loadClaudePerf(true)" title="Refresh from MarginLab">Refresh</button>
            </div>
            <div id="claudePerfContent" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div class="loading">Loading</div>
            </div>
        </div>

        <!-- Weather Card -->
        <div class="card weather-card">
            <div class="card-header">
                <h2>Aviation Weather</h2>
                <select id="weatherAirport" onchange="loadWeather()" style="background:#0f0f1a;border:1px solid #333;border-radius:6px;padding:4px 8px;color:#e0e0e0;font-size:11px;">
                    <option value="EGLL">EGLL - Heathrow</option>
                    <option value="KJFK">KJFK - New York</option>
                    <option value="KLAX">KLAX - Los Angeles</option>
                    <option value="LFPG">LFPG - Paris CDG</option>
                    <option value="EDDF">EDDF - Frankfurt</option>
                    <option value="OMDB">OMDB - Dubai</option>
                </select>
            </div>
            <div id="weatherContent" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                <div class="loading">Loading weather</div>
            </div>
        </div>

        <!-- Topology Card -->
        <div class="card topology-card" style="grid-column: span 3;">
            <div class="card-header">
                <h2>Service Topology</h2>
                <button class="btn small secondary" onclick="loadTopology()" title="Refresh topology diagram">Refresh</button>
            </div>
            <div id="topologyDiagram" style="display:flex;justify-content:center;align-items:center;min-height:200px;background:#0a0a0f;border-radius:8px;padding:10px;overflow:auto;">
                <div class="loading">Loading topology</div>
            </div>
        </div>

        <!-- Bottom Section with Collapsibles -->
        <div class="bottom-section">
            <!-- Anomalies -->
            <div class="card collapsible-card">
                <div class="collapsible-header" onclick="toggleSection('anomalies')">
                    <h3>
                        <span>Anomalies</span>
                        <span class="count" id="anomalyCount">0</span>
                    </h3>
                    <span class="collapsible-toggle" id="anomalies-toggle">â–¼</span>
                </div>
                <div class="collapsible-content" id="anomalies-content">
                    <div class="collapsible-list" id="anomalyList">
                        <div style="color:#00ff88;text-align:center;padding:20px;">All systems nominal</div>
                    </div>
                </div>
            </div>

            <!-- Models -->
            <div class="card collapsible-card">
                <div class="collapsible-header" onclick="toggleSection('models')">
                    <h3>
                        <span>Available Models</span>
                        <span class="count" id="modelCount">0</span>
                    </h3>
                    <span class="collapsible-toggle" id="models-toggle">â–¼</span>
                </div>
                <div class="collapsible-content" id="models-content">
                    <div class="collapsible-list" id="modelList">
                        <div class="loading">Loading</div>
                    </div>
                </div>
            </div>

            <!-- MCP Servers -->
            <div class="card collapsible-card">
                <div class="collapsible-header" onclick="toggleSection('mcp')">
                    <h3>
                        <span>MCP Servers</span>
                        <span class="count" id="mcpCount">0</span>
                    </h3>
                    <span class="collapsible-toggle" id="mcp-toggle">â–¼</span>
                </div>
                <div class="collapsible-content" id="mcp-content">
                    <div class="collapsible-list" id="mcpList">
                        <div class="loading">Loading</div>
                    </div>
                </div>
            </div>

            <!-- Curated Intel -->
            <div class="card collapsible-card" style="grid-column: span 2;">
                <div class="collapsible-header" onclick="toggleSection('intel-curated')">
                    <h3>
                        <span>Daily Intel Report</span>
                        <span class="count" id="intelCuratedCount">0</span>
                    </h3>
                    <span class="collapsible-toggle" id="intel-curated-toggle">â–¼</span>
                </div>
                <div class="collapsible-content" id="intel-curated-content">
                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
                        <select id="intelFilter" onchange="loadCuratedIntel()" style="background:#1a1a2e;color:#e0e0e0;border:1px solid #333;border-radius:4px;padding:4px 8px;font-size:11px;">
                            <option value="pending">Pending Review</option>
                            <option value="recommended">Recommended</option>
                            <option value="approved">Approved</option>
                            <option value="all">All</option>
                        </select>
                        <button class="btn small secondary" onclick="collectIntel()" title="Fetch fresh intel from all sources">Collect New</button>
                        <span id="intelLastFetch" style="color:#666;font-size:10px;margin-left:auto;"></span>
                    </div>
                    <div id="intelCuratedList" style="max-height:400px;overflow-y:auto;">
                        <div class="loading">Loading intel</div>
                    </div>
                </div>
            </div>

            <!-- Recent Alerts -->
            <div class="card collapsible-card">
                <div class="collapsible-header" onclick="toggleSection('alerts')">
                    <h3>
                        <span>Alerts</span>
                        <span class="count" id="alertCount">0</span>
                    </h3>
                    <span class="collapsible-toggle" id="alerts-toggle">â–¼</span>
                </div>
                <div class="collapsible-content" id="alerts-content">
                    <div style="display:flex;gap:6px;align-items:center;margin-bottom:8px;flex-wrap:wrap;">
                        <select id="alertSeverityFilter" onchange="loadAlerts()" style="background:#1a1a2e;color:#e0e0e0;border:1px solid #333;border-radius:4px;padding:3px 6px;font-size:10px;">
                            <option value="all">All</option>
                            <option value="critical">Critical</option>
                            <option value="error">Error</option>
                            <option value="warning">Warning</option>
                            <option value="info">Info</option>
                        </select>
                        <button class="btn small secondary" onclick="ackAllAlerts()" style="font-size:10px;padding:3px 8px;">Clear All</button>
                    </div>
                    <div class="collapsible-list" id="alertList">
                        <div style="color:#00ff88;text-align:center;padding:20px;">No alerts</div>
                    </div>
                </div>
            </div>

            <!-- Service Logs -->
            <div class="card collapsible-card" style="grid-column: 1 / -1;">
                <div class="collapsible-header" onclick="toggleSection('logs')">
                    <h3>
                        <span>Service Logs</span>
                        <span class="count" id="logsCount">0</span>
                    </h3>
                    <span class="collapsible-toggle" id="logs-toggle">â–¼</span>
                </div>
                <div class="collapsible-content" id="logs-content" style="display:none;">
                    <div style="padding:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <select id="logSource" onchange="loadLogs()" style="background:#1a1a2e;color:#e0e0e0;border:1px solid #333;border-radius:4px;padding:4px 8px;font-size:12px;">
                            <option value="orchestrator">Master-O (Orchestrator)</option>
                            <option value="alerts">Alert History (Relay)</option>
                            <option value="services">Service Status Snapshot</option>
                        </select>
                        <button class="btn secondary" onclick="loadLogs()" style="padding:4px 10px;font-size:11px;">Refresh</button>
                        <label style="color:#888;font-size:11px;display:flex;align-items:center;gap:4px;">
                            <input type="checkbox" id="logAutoScroll" checked> Auto-scroll
                        </label>
                        <span style="color:#666;font-size:10px;margin-left:auto;" id="logTimestamp"></span>
                    </div>
                    <pre id="logContent" style="background:#0a0a14;color:#ccc;font-family:'Consolas','Courier New',monospace;font-size:11px;line-height:1.5;padding:12px;margin:0;max-height:400px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;border-top:1px solid #222;">Loading logs...</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Command Palette -->
    <div class="modal-overlay" id="cmdPalette" style="align-items:flex-start;padding-top:15vh;">
        <div class="modal" style="max-width:500px;padding:0;overflow:visible;">
            <input type="text" id="cmdInput" placeholder="Type a command... (restart, logs, refresh, export, open)"
                style="width:100%;background:#1a1a2e;border:none;border-bottom:1px solid #333;border-radius:12px 12px 0 0;padding:16px 20px;color:#fff;font-size:15px;outline:none;"
                oninput="filterCommands()" onkeydown="handleCmdKey(event)">
            <div id="cmdResults" style="max-height:350px;overflow-y:auto;padding:8px;"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width:420px;">
            <div class="modal-header">
                <h2>Dashboard Settings</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body" style="padding:20px;">
                <div style="display:flex;flex-direction:column;gap:16px;">
                    <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
                        <div>
                            <div style="color:#fff;font-size:13px;">Auto-restart offline services</div>
                            <div style="color:#666;font-size:11px;">Restart after 3 consecutive failed checks</div>
                        </div>
                        <input type="checkbox" id="setAutoRestart" onchange="toggleSetting('autoRestart', this.checked)" style="width:18px;height:18px;accent-color:#ff6b35;">
                    </label>
                    <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
                        <div>
                            <div style="color:#fff;font-size:13px;">Alert sound</div>
                            <div style="color:#666;font-size:11px;">Audio ping on new critical/error alerts</div>
                        </div>
                        <input type="checkbox" id="setAlertSound" onchange="toggleSetting('alertSound', this.checked)" style="width:18px;height:18px;accent-color:#ff6b35;">
                    </label>
                    <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
                        <div>
                            <div style="color:#fff;font-size:13px;">Desktop notifications</div>
                            <div style="color:#666;font-size:11px;">Browser notifications for state changes</div>
                        </div>
                        <input type="checkbox" id="setNotifications" onchange="toggleSetting('desktopNotifications', this.checked)" style="width:18px;height:18px;accent-color:#ff6b35;">
                    </label>
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="color:#fff;font-size:13px;">Refresh interval</div>
                            <div style="color:#666;font-size:11px;">Seconds between auto-refresh</div>
                        </div>
                        <select id="setRefreshInterval" onchange="changeRefreshInterval(this.value)" style="background:#1a1a2e;color:#e0e0e0;border:1px solid #333;border-radius:4px;padding:4px 8px;font-size:12px;">
                            <option value="15">15s</option>
                            <option value="30">30s</option>
                            <option value="60">60s</option>
                            <option value="120">2m</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:20px;padding-top:14px;border-top:1px solid #2a2a3e;text-align:center;">
                    <button class="btn small secondary" onclick="resetSettings()" style="font-size:11px;">Reset to Defaults</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Anomaly Detail Modal -->
    <div class="modal-overlay" id="anomalyModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Anomaly Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="anomalyModalBody">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Service Detail Modal -->
    <div class="modal-overlay" id="serviceModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="serviceModalTitle">Service Details</h2>
                <button class="modal-close" onclick="closeServiceModal()">&times;</button>
            </div>
            <div class="modal-body" id="serviceModalBody">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Dynamic host detection for remote access
        const HOST = location.hostname || 'localhost';
        const API_BASE = `http://${HOST}:3002`;

        // Utility services not managed by the Orchestrator
        const UTILITY_SERVICES = [
            { name: 'Master-O', port: 8500, endpoint: '/api/health', path: '/', desc: 'Service Watchdog', hive: false },
            { name: 'Ollama', port: 11434, endpoint: '/api/tags', path: '/', desc: 'Local LLM (qwen)', hive: false },
            { name: 'LM-Studio', port: 1234, endpoint: '/v1/models', path: '/', desc: 'Local LLM (Nova)', hive: false },
            { name: 'PMS50', port: 8830, endpoint: '/api/health', path: '/', desc: 'GTN750 Avionics', hive: false }
        ];

        // Services list â€” populated from Orchestrator on first load
        let SERVICES = [...UTILITY_SERVICES];

        async function populateServicesFromOrchestrator() {
            try {
                const res = await fetchWithTimeout('http://${HOST}:8500/api/services', 3000);
                const registry = await res.json();
                const hiveServices = Object.entries(registry)
                    .filter(([id, svc]) => svc.port && svc.healthEndpoint)
                    .map(([id, svc]) => ({
                        name: svc.name,
                        port: svc.port,
                        endpoint: svc.healthEndpoint,
                        path: '/',
                        desc: svc.name,
                        hive: true,
                        orchestratorId: id
                    }));
                SERVICES = [...hiveServices, ...UTILITY_SERVICES];
                // Auto-populate SERVICE_KEY_MAP from orchestrator IDs
                hiveServices.forEach(s => { SERVICE_KEY_MAP[s.name] = s.orchestratorId; });
                console.log('[Dashboard] Loaded ' + hiveServices.length + ' services from Orchestrator');
            } catch (e) {
                console.log('[Dashboard] Orchestrator unavailable, using fallback list');
                SERVICES = [
                    { name: 'Oracle', port: 3002, endpoint: '/api/health', path: '/', desc: 'LLM backend', hive: true },
                    { name: 'SimWidget', port: 8080, endpoint: '/api/status', path: '/', desc: 'MSFS Server', hive: true },
                    { name: 'Relay', port: 8600, endpoint: '/api/health', path: '/', desc: 'Message queue', hive: true },
                    { name: 'KittBox', port: 8585, endpoint: '/api/health', path: '/', desc: 'Command Center', hive: true },
                    { name: 'Hive-Mind', port: 8701, endpoint: '/api/health', path: '/', desc: 'Activity Monitor', hive: true },
                    { name: 'Dashboard', port: 8899, endpoint: '/api/health', path: '/', desc: 'This dashboard', hive: true },
                    ...UTILITY_SERVICES
                ];
            }
        }

        let intelData = {};
        let healthData = {};
        let currentTab = 'news';
        let collapsedSections = { logs: true };

        // Update time
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Fetch with timeout
        async function fetchWithTimeout(url, timeout = 5000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const res = await fetch(url, { signal: controller.signal });
                clearTimeout(id);
                return res;
            } catch (e) {
                clearTimeout(id);
                throw e;
            }
        }

        // Toggle collapsible section
        function toggleSection(section) {
            const content = document.getElementById(`${section}-content`);
            const toggle = document.getElementById(`${section}-toggle`);

            if (collapsedSections[section]) {
                content.classList.remove('collapsed');
                content.style.display = '';
                toggle.classList.remove('collapsed');
                collapsedSections[section] = false;
                if (section === 'logs') loadLogs();
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                collapsedSections[section] = true;
            }
        }

        // Load Briefing (server auto-regenerates if stale >1h)
        async function loadBriefing() {
            try {
                const res = await fetchWithTimeout(`${API_BASE}/api/intel/briefing`);
                const data = await res.json();
                if (data.date) {
                    document.getElementById('briefingDate').textContent =
                        new Date(data.date).toLocaleString();
                }

                const h = data.highlights || {};
                // Calculate uptime % from sparkline data
                let uptimePct = '--';
                if (Object.keys(serviceSparklineData).length > 0) {
                    let totalChecks = 0, onlineChecks = 0;
                    Object.values(serviceSparklineData).forEach(arr => {
                        arr.forEach(v => { totalChecks++; if (v === 1) onlineChecks++; });
                    });
                    if (totalChecks > 0) uptimePct = Math.round(onlineChecks / totalChecks * 100) + '%';
                }
                document.getElementById('briefingStats').innerHTML = `
                    <div class="briefing-stat ${getHealthClass(h.hive)}">
                        <div class="value">${h.hive || '--'}</div>
                        <div class="label">Hive Status</div>
                    </div>
                    <div class="briefing-stat ${uptimePct !== '--' && parseInt(uptimePct) >= 95 ? 'good' : uptimePct !== '--' && parseInt(uptimePct) >= 80 ? 'warn' : ''}">
                        <div class="value">${uptimePct}</div>
                        <div class="label">Uptime</div>
                    </div>
                    <div class="briefing-stat">
                        <div class="value">${h.models || '--'}</div>
                        <div class="label">Models</div>
                    </div>
                    <div class="briefing-stat">
                        <div class="value">${h.github || '--'}</div>
                        <div class="label">GitHub</div>
                    </div>
                    <div class="briefing-stat ${h.anomalies > 10 ? 'warn' : ''}">
                        <div class="value">${h.anomalies || 0}</div>
                        <div class="label">Anomalies</div>
                    </div>
                `;

                // Format the summary nicely
                const summary = data.summary || 'No summary available';
                const lines = summary.split('\n').filter(l => l.trim());
                document.getElementById('briefingSummary').innerHTML = lines.map(line => {
                    // Highlight key parts
                    let formatted = line
                        .replace(/^(Hive Status:)/i, '<strong style="color:#00d9ff">$1</strong>')
                        .replace(/^(Health Trend:)/i, '<strong style="color:#00ff88">$1</strong>')
                        .replace(/^(Recent Issues:)/i, '<strong style="color:#ffaa00">$1</strong>')
                        .replace(/^(Models Available:)/i, '<strong style="color:#ff6b35">$1</strong>')
                        .replace(/^(New Releases:)/i, '<strong style="color:#ff9f1c">$1</strong>')
                        .replace(/^(Repos Tracked:)/i, '<strong style="color:#888">$1</strong>')
                        .replace(/^(AI News:)/i, '<strong style="color:#00d9ff">$1</strong>')
                        .replace(/improving/gi, '<span style="color:#00ff88">improving</span>')
                        .replace(/degrading/gi, '<span style="color:#ff4444">degrading</span>')
                        .replace(/stable/gi, '<span style="color:#ffaa00">stable</span>')
                        .replace(/online/gi, '<span style="color:#00ff88">online</span>')
                        .replace(/offline/gi, '<span style="color:#ff4444">offline</span>')
                        .replace(/v[\d.]+/g, '<code style="background:#2a2a3e;padding:2px 6px;border-radius:4px;font-size:11px;">$&</code>');
                    return '<div style="margin-bottom:8px;">' + formatted + '</div>';
                }).join('');
            } catch (e) {
                document.getElementById('briefingStats').innerHTML =
                    '<div style="color:#ff4444">Failed to load briefing</div>';
            }
        }

        function getHealthClass(hive) {
            if (!hive) return '';
            const match = hive.match(/(\d+)\/(\d+)/);
            if (match) {
                const ratio = parseInt(match[1]) / parseInt(match[2]);
                if (ratio >= 0.9) return 'good';
                if (ratio >= 0.7) return 'warn';
                return 'bad';
            }
            return '';
        }

        // Load Services - with clickable items
        // Map service names to Orchestrator keys for restart API
        let SERVICE_KEY_MAP = {
            'Oracle': 'oracle',
            'SimWidget': 'simwidget',
            'KittBox': 'agent',
            'Remote Support': 'remote',
            'Relay': 'relay',
            'Claude Bridge': 'bridge',
            'Hive-Mind': 'hivemind',
            'Terminal Hub': 'terminalhub',
            'Hive-Brain': 'hivebraindiscovery',
            'Agents': 'hivebrain',
            'Master-Mind': 'mastermind',
            'Hive-Oracle': 'hiveoracle',
            'Hive-Mesh': 'hivemesh',
            'MCP-Bridge': 'mcpbridge',
            'Dashboard': 'dashboard'
        };

        function formatUptime(val) {
            if (!val) return '';
            let secs = typeof val === 'string' ? parseInt(val) : val;
            if (isNaN(secs) || secs <= 0) return '';
            if (secs < 60) return secs + 's';
            if (secs < 3600) return Math.floor(secs / 60) + 'm';
            if (secs < 86400) return Math.floor(secs / 3600) + 'h ' + Math.floor((secs % 3600) / 60) + 'm';
            return Math.floor(secs / 86400) + 'd ' + Math.floor((secs % 86400) / 3600) + 'h';
        }

        function latencyColor(ms) {
            if (ms === null || ms === undefined) return '#666';
            if (ms < 100) return '#00ff88';
            if (ms < 500) return '#ffaa00';
            return '#ff4444';
        }

        function renderSparkline(name) {
            const data = serviceSparklineData[name];
            if (!data || data.length < 2) return '';
            const w = 40, h = 12;
            const bars = data.slice(-20).map((v, i) => {
                const x = i * (w / 20);
                return '<rect x="' + x + '" y="' + (v ? 0 : h/3) + '" width="' + (w/20 - 0.5) + '" height="' + (v ? h : h*2/3) + '" fill="' + (v ? '#00ff8844' : '#ff444466') + '"/>';
            }).join('');
            return '<svg width="' + w + '" height="' + h + '" style="vertical-align:middle;" title="Recent health">' + bars + '</svg>';
        }

        function renderServiceItem(s) {
            const restartBtn = SERVICE_KEY_MAP[s.name]
                ? '<button class="restart-btn' + (s.status !== 'online' ? ' show' : '') + '" onclick="event.stopPropagation();restartServiceQuick(\'' + s.name + '\',this)" title="Restart ' + s.name + '">&#x21bb;</button>'
                : '';
            const uptimeStr = formatUptime(s.uptime);
            const uptimeHtml = uptimeStr ? '<span style="color:#666;font-size:10px;" title="Uptime">' + uptimeStr + '</span>' : '';
            const latencyHtml = s.latency != null ? '<span style="color:' + latencyColor(s.latency) + ';font-size:10px;font-family:monospace;" title="Response time">' + s.latency + 'ms</span>' : '';
            const sparkHtml = renderSparkline(s.name);
            return '<div class="service-item ' + s.status + '" onclick="openServiceDetail(\'' + s.name + '\', ' + s.port + ', \'' + s.status + '\', \'' + s.desc + '\')">' +
                '<div><div class="service-name">' + s.name + '</div><div class="service-port">:' + s.port + ' - ' + s.desc + '</div></div>' +
                '<div style="display:flex;align-items:center;gap:6px;">' + sparkHtml + latencyHtml + uptimeHtml + restartBtn + '<div class="service-status">' + s.status + '</div><div class="service-open">&rarr;</div></div></div>';
        }

        async function restartServiceQuick(name, btn) {
            const svcKey = SERVICE_KEY_MAP[name];
            if (!svcKey) return;
            if (btn) { btn.classList.add('spinning'); btn.disabled = true; }
            try {
                const res = await fetch('http://${HOST}:8500/api/services/' + svcKey + '/restart', { method: 'POST' });
                if (res.ok) {
                    if (btn) btn.style.color = '#00ff88';
                    setTimeout(() => { loadServices(); }, 4000);
                } else {
                    if (btn) btn.style.color = '#ff4444';
                }
            } catch (e) {
                if (btn) btn.style.color = '#ff4444';
            }
            if (btn) setTimeout(() => { btn.classList.remove('spinning'); btn.disabled = false; btn.style.color = ''; }, 3000);
        }

        let lastServiceResults = [];
        let previousServiceStates = {};
        let serviceSparklineData = {}; // { name: [1,1,0,1,...] } â€” last 60 checks
        let serviceLatencyHistory = {}; // { name: [ms, ms, ...] } â€” last 60 latency samples
        let offlineStreakCount = {}; // { name: consecutiveOfflineCount }

        // Dashboard settings with localStorage persistence
        const SETTINGS_KEY = 'hiveDashSettings';
        let dashSettings = Object.assign({
            autoRestart: false,
            refreshInterval: 30,
            alertSound: false,
            desktopNotifications: true,
            compactMode: false
        }, JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}'));
        function saveSettings() { localStorage.setItem(SETTINGS_KEY, JSON.stringify(dashSettings)); }

        async function loadServices() {
            const results = await Promise.all(SERVICES.map(async (svc) => {
                const t0 = Date.now();
                try {
                    const url = `http://${HOST}:` + svc.port + svc.endpoint;
                    const res = await fetchWithTimeout(url, 5000);
                    const latency = Date.now() - t0;
                    // Some endpoints return non-200 but are still "alive"
                    if (res.ok || res.status === 404 || res.status === 401) {
                        let uptime = null;
                        try {
                            const data = await res.clone().json();
                            uptime = data.uptime || data.uptimeSeconds || null;
                        } catch (e) {}
                        return { ...svc, status: 'online', uptime, latency };
                    }
                    return { ...svc, status: 'error', uptime: null, latency };
                } catch (e) {
                    console.log(svc.name + ' check failed:', e.message);
                    return { ...svc, status: 'offline', uptime: null, latency: null };
                }
            }));

            // Desktop notifications for state changes
            notifyStateChanges(results);

            // Track sparkline + latency history (last 60 checks per service)
            results.forEach(s => {
                if (!serviceSparklineData[s.name]) serviceSparklineData[s.name] = [];
                serviceSparklineData[s.name].push(s.status === 'online' ? 1 : 0);
                if (serviceSparklineData[s.name].length > 60) serviceSparklineData[s.name].shift();

                if (!serviceLatencyHistory[s.name]) serviceLatencyHistory[s.name] = [];
                serviceLatencyHistory[s.name].push(s.latency || 0);
                if (serviceLatencyHistory[s.name].length > 60) serviceLatencyHistory[s.name].shift();
            });

            // Auto-restart on extended downtime (3+ consecutive checks)
            if (dashSettings.autoRestart) {
                results.forEach(s => {
                    if (s.status === 'offline') {
                        offlineStreakCount[s.name] = (offlineStreakCount[s.name] || 0) + 1;
                        if (offlineStreakCount[s.name] === 3 && SERVICE_KEY_MAP[s.name]) {
                            console.log('[AutoRestart] ' + s.name + ' offline for 3 checks, restarting...');
                            fetch('http://${HOST}:8500/api/services/' + SERVICE_KEY_MAP[s.name] + '/restart', { method: 'POST' }).catch(() => {});
                            if (Notification.permission === 'granted') {
                                new Notification('Hive: Auto-restarting ' + s.name, { body: 'Offline for 3+ checks', tag: 'hive-autorestart-' + s.name });
                            }
                            offlineStreakCount[s.name] = -10; // cooldown: won't trigger again for 10 more checks
                        }
                    } else {
                        offlineStreakCount[s.name] = 0;
                    }
                });
            }

            const online = results.filter(s => s.status === 'online').length;
            document.getElementById('servicesCount').textContent = `${online}/${results.length}`;
            lastServiceResults = results;
            renderFilteredServices();

            // Update page title and favicon based on health
            updateTitleAndFavicon(online, results.length);
        }

        function renderFilteredServices() {
            const filter = (document.getElementById('serviceFilter')?.value || '').toLowerCase();
            const results = filter
                ? lastServiceResults.filter(s => s.name.toLowerCase().includes(filter) || s.desc.toLowerCase().includes(filter) || String(s.port).includes(filter))
                : lastServiceResults;

            // Group into categories
            const categories = {
                'Infrastructure': ['Oracle', 'Relay Service', 'Hive Dashboard', 'Master-O', 'Terminal Hub'],
                'AI / LLM': ['Master-Mind', 'Hive Oracle (LLM)', 'Hive Brain Admin', 'Hive-Brain Discovery', 'MCP-Bridge', 'Ollama', 'LM-Studio'],
                'Network': ['Hive-Mind Monitor', 'Hive-Mesh', 'Claude Bridge', 'Remote Support'],
                'Applications': ['SimWidget Main Server', 'Agent (Kitt)', 'PMS50']
            };
            const categorized = new Set();
            let servicesHtml = '';

            for (const [cat, names] of Object.entries(categories)) {
                const group = results.filter(s => names.includes(s.name));
                if (group.length === 0) continue;
                group.forEach(s => categorized.add(s.name));
                const groupOnline = group.filter(s => s.status === 'online').length;
                const color = groupOnline === group.length ? '#00ff88' : groupOnline > 0 ? '#ffaa00' : '#ff4444';
                servicesHtml += '<div class="svc-group-header" onclick="toggleServiceGroup(this)" style="color:#888;font-size:10px;text-transform:uppercase;margin:8px 0 4px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none;">';
                servicesHtml += '<span>' + cat + '</span>';
                servicesHtml += '<span style="color:' + color + ';font-size:9px;">' + groupOnline + '/' + group.length + ' â–¼</span>';
                servicesHtml += '</div>';
                servicesHtml += '<div class="svc-group">';
                servicesHtml += group.map(s => renderServiceItem(s)).join('');
                servicesHtml += '</div>';
            }

            // Uncategorized
            const uncategorized = results.filter(s => !categorized.has(s.name));
            if (uncategorized.length > 0) {
                servicesHtml += '<div style="color:#888;font-size:10px;text-transform:uppercase;margin:8px 0 4px;">Other</div>';
                servicesHtml += uncategorized.map(s => renderServiceItem(s)).join('');
            }

            document.getElementById('servicesList').innerHTML = servicesHtml || '<div style="color:#666;text-align:center;padding:20px;">No matches</div>';
        }

        function filterServices() { renderFilteredServices(); }

        function toggleServiceGroup(header) {
            const group = header.nextElementSibling;
            if (group.style.display === 'none') {
                group.style.display = '';
                header.querySelector('span:last-child').textContent = header.querySelector('span:last-child').textContent.replace('â–¶', 'â–¼');
            } else {
                group.style.display = 'none';
                header.querySelector('span:last-child').textContent = header.querySelector('span:last-child').textContent.replace('â–¼', 'â–¶');
            }
        }

        function updateTitleAndFavicon(online, total) {
            const ratio = total > 0 ? online / total : 0;
            document.title = '(' + online + '/' + total + ') Hive Command Center';
            const color = ratio >= 0.9 ? '%2300ff88' : ratio >= 0.7 ? '%23ffaa00' : '%23ff4444';
            document.getElementById('favicon').href =
                "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='" + color + "'/><text x='50' y='68' text-anchor='middle' font-size='40' fill='white' font-family='sans-serif'>" + online + "</text></svg>";
        }

        // Open service in new tab
        function openService(name, port) {
            window.open(`http://${HOST}:${port}`, '_blank');
        }

        // Open service detail modal
        function openServiceDetail(name, port, status, desc) {
            document.getElementById('serviceModalTitle').textContent = `${name} Details`;
            document.getElementById('serviceModalBody').innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Service</span>
                    <span class="detail-value">${name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Port</span>
                    <span class="detail-value">${port}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status</span>
                    <span class="detail-value ${status}">${status.toUpperCase()}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Description</span>
                    <span class="detail-value">${desc}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">URL</span>
                    <span class="detail-value">
                        <a href="http://${HOST}:${port}" target="_blank" style="color:#ff6b35">
                            http://${HOST}:${port}
                        </a>
                    </span>
                </div>

                <div style="margin-top:15px;">
                    ${renderLatencyChart(name)}
                </div>
                <div id="investigateResults" style="margin-top:15px;"></div>

                <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn" onclick="investigateService('${name}', ${port})" title="Run diagnostics on this service">ðŸ” Investigate</button>
                    <button class="btn secondary" onclick="openService('${name}', ${port})" title="Open ${name} web interface in new browser tab">Open in Browser</button>
                    ${SERVICE_KEY_MAP[name] ? `<button class="btn" style="background:${status === 'offline' ? '#ff4444' : '#ff6b35'}" onclick="restartService('${name}')" title="Restart ${name} via Master-O">ðŸ”„ Restart</button>` : ''}
                    <button class="btn secondary" onclick="closeServiceModal()" title="Close this dialog (Esc)">Close</button>
                </div>
            `;
            document.getElementById('serviceModal').classList.add('active');
        }

        // Investigate service health
        async function investigateService(name, port) {
            const resultsEl = document.getElementById('investigateResults');
            resultsEl.innerHTML = '<div class="loading">Investigating...</div>';

            const findings = [];
            const svc = SERVICES.find(s => s.name === name);

            try {
                // 1. Check basic connectivity
                findings.push({ label: 'Connectivity Test', status: 'checking' });

                const startTime = Date.now();
                const res = await fetchWithTimeout(`http://${HOST}:` + port + (svc?.endpoint || '/'), 5000);
                const responseTime = Date.now() - startTime;

                if (res.ok) {
                    findings[0] = { label: 'Connectivity', status: 'pass', detail: 'Responding in ' + responseTime + 'ms' };

                    // 2. Try to get more info from the response
                    try {
                        const data = await res.json();
                        if (data.status) findings.push({ label: 'Health Status', status: 'pass', detail: data.status });
                        if (data.uptime) findings.push({ label: 'Uptime', status: 'info', detail: data.uptime });
                        if (data.version) findings.push({ label: 'Version', status: 'info', detail: data.version });
                        if (data.models?.length) findings.push({ label: 'Models Loaded', status: 'info', detail: data.models.length + ' models' });
                        if (data.backend) findings.push({ label: 'Backend', status: 'info', detail: data.backend });
                    } catch (e) {
                        // Response wasn't JSON, that's ok
                        findings.push({ label: 'Response', status: 'pass', detail: 'Service responding (non-JSON)' });
                    }

                    // 3. Check response time
                    if (responseTime > 2000) {
                        findings.push({ label: 'Performance', status: 'warn', detail: 'Slow response (' + responseTime + 'ms)' });
                    } else {
                        findings.push({ label: 'Performance', status: 'pass', detail: 'Good (' + responseTime + 'ms)' });
                    }
                } else {
                    findings[0] = { label: 'Connectivity', status: 'fail', detail: 'HTTP ' + res.status };
                }
            } catch (e) {
                findings[0] = { label: 'Connectivity', status: 'fail', detail: e.message || 'Connection failed' };

                // Try to determine why
                findings.push({ label: 'Diagnosis', status: 'info', detail: 'Service may be stopped, crashed, or port blocked' });

                // Suggest actions
                findings.push({ label: 'Suggested Action', status: 'action', detail: 'Try restarting via Master-O or check Windows Services' });
            }

            // 4. Check Master-O for service info
            try {
                const masterRes = await fetchWithTimeout('http://${HOST}:8500/api/status', 2000);
                if (masterRes.ok) {
                    const masterData = await masterRes.json();
                    const svcKey = name.toLowerCase().replace('-', '');
                    const svcInfo = masterData.services?.[svcKey];
                    if (svcInfo) {
                        findings.push({ label: 'Master-O Status', status: svcInfo.healthy ? 'pass' : 'warn', detail: svcInfo.healthy ? 'Healthy' : 'Unhealthy' });
                        if (svcInfo.restartCount > 0) {
                            findings.push({ label: 'Restart Count', status: 'warn', detail: svcInfo.restartCount + ' restarts' });
                        }
                    }
                }
            } catch (e) {
                // Master-O not available
            }

            // Check if there are issues that need fixing
            const hasIssues = findings.some(f => f.status === 'fail' || f.status === 'warn');
            let taskCreated = false;
            let taskId = null;

            // If issues found, create a fix task in Relay
            if (hasIssues) {
                try {
                    const issueList = findings
                        .filter(f => f.status === 'fail' || f.status === 'warn')
                        .map(f => f.label + ': ' + f.detail)
                        .join('; ');

                    const taskPayload = {
                        content: 'Fix ' + name + ' service issues: ' + issueList,
                        source: 'hive-dashboard',
                        priority: findings.some(f => f.status === 'fail') ? 'high' : 'medium',
                        metadata: {
                            service: name,
                            port: port,
                            findings: findings,
                            autoGenerated: true,
                            timestamp: new Date().toISOString()
                        }
                    };

                    const taskRes = await fetch('http://${HOST}:8600/api/messages', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(taskPayload)
                    });

                    if (taskRes.ok) {
                        const taskData = await taskRes.json();
                        taskCreated = true;
                        taskId = taskData.id;
                    }
                } catch (e) {
                    console.log('Could not create fix task:', e);
                }
            }

            // Render findings
            let findingsHtml = '<div style="background:#0f0f1a;border-radius:8px;padding:15px;margin-top:10px;">';
            findingsHtml += '<div style="color:#888;font-size:11px;text-transform:uppercase;margin-bottom:10px;">Investigation Results</div>';
            findings.forEach(function(f) {
                const color = f.status === 'pass' ? '#00ff88' : f.status === 'fail' ? '#ff4444' : f.status === 'warn' ? '#ffaa00' : '#aaa';
                const icon = f.status === 'pass' ? 'âœ“' : f.status === 'fail' ? 'âœ—' : f.status === 'warn' ? 'âš ' : 'â„¹';
                findingsHtml += '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #2a2a3e;">';
                findingsHtml += '<span style="color:#888;">' + f.label + '</span>';
                findingsHtml += '<span style="color:' + color + ';">' + icon + ' ' + f.detail + '</span>';
                findingsHtml += '</div>';
            });
            findingsHtml += '</div>';

            // Show task creation status
            if (taskCreated) {
                findingsHtml += '<div style="background:#1a2a3e;border:1px solid #00d9ff;border-radius:8px;padding:12px;margin-top:10px;">';
                findingsHtml += '<div style="color:#00d9ff;font-weight:500;">ðŸ“‹ Fix Task Created</div>';
                findingsHtml += '<div style="color:#aaa;font-size:12px;margin-top:5px;">Task ID: ' + taskId + '</div>';
                findingsHtml += '<div style="color:#888;font-size:11px;margin-top:3px;">Claude Code will pick this up and attempt to fix the issues.</div>';
                findingsHtml += '</div>';
            } else if (hasIssues) {
                findingsHtml += '<div style="background:#3a2a1a;border:1px solid #ffaa00;border-radius:8px;padding:12px;margin-top:10px;">';
                findingsHtml += '<div style="color:#ffaa00;font-weight:500;">âš  Could not create fix task</div>';
                findingsHtml += '<div style="color:#888;font-size:11px;margin-top:3px;">Relay service may be offline. Try restarting manually.</div>';
                findingsHtml += '</div>';
            }

            resultsEl.innerHTML = findingsHtml;
        }

        // Restart service via Master-O
        async function restartService(name) {
            const resultsEl = document.getElementById('investigateResults');
            resultsEl.innerHTML = '<div class="loading">Requesting restart...</div>';

            try {
                const svcKey = SERVICE_KEY_MAP[name] || name.toLowerCase();

                const res = await fetch('http://${HOST}:8500/api/services/' + svcKey + '/restart', { method: 'POST' });

                if (res.ok) {
                    resultsEl.innerHTML = '<div style="background:#1a3a2e;border:1px solid #00ff88;border-radius:8px;padding:15px;margin-top:10px;">' +
                        '<div style="color:#00ff88;font-weight:500;">âœ“ Restart Requested</div>' +
                        '<div style="color:#aaa;font-size:12px;margin-top:5px;">Master-O is restarting ' + name + '. Please wait a few seconds and refresh.</div>' +
                        '</div>';

                    // Refresh services after delay
                    setTimeout(loadServices, 5000);
                } else {
                    throw new Error('HTTP ' + res.status);
                }
            } catch (e) {
                resultsEl.innerHTML = '<div style="background:#3a1a1a;border:1px solid #ff4444;border-radius:8px;padding:15px;margin-top:10px;">' +
                    '<div style="color:#ff4444;font-weight:500;">âœ— Restart Failed</div>' +
                    '<div style="color:#aaa;font-size:12px;margin-top:5px;">Error: ' + e.message + '. Try restarting manually via Windows Services (NSSM).</div>' +
                    '</div>';
            }
        }

        function closeServiceModal() {
            document.getElementById('serviceModal').classList.remove('active');
        }

        // Load Intel
        async function loadIntel() {
            try {
                const res = await fetchWithTimeout(`${API_BASE}/api/intel`);
                intelData = await res.json();

                document.getElementById('intelUpdated').textContent =
                    intelData.lastUpdated ? new Date(intelData.lastUpdated).toLocaleTimeString() : '--';

                renderIntelTab(currentTab);
            } catch (e) {
                document.getElementById('intelContent').innerHTML =
                    '<div style="color:#ff4444">Failed to load intel</div>';
            }
        }

        function renderIntelTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.intel-tab').forEach(t =>
                t.classList.toggle('active', t.dataset.tab === tab));

            const content = document.getElementById('intelContent');

            if (tab === 'news') {
                const items = intelData.feeds?.hackerNews?.topStories || [];
                content.innerHTML = items.length ? items.map(item => `
                    <div class="intel-item">
                        <div class="title">
                            <a href="${item.url}" target="_blank">${item.title}</a>
                            ${item.isAIRelated ? '<span class="tag ai">AI</span>' : ''}
                        </div>
                        <div class="meta">
                            <span>Score: ${item.score}</span>
                            <span>${timeAgo(item.time)}</span>
                        </div>
                    </div>
                `).join('') : '<div style="color:#666;padding:20px;text-align:center">No news</div>';
            }
            else if (tab === 'github') {
                const releases = intelData.github?.recentReleases || [];
                const repos = intelData.github?.repos || [];
                content.innerHTML = `
                    ${releases.length ? '<div style="color:#888;font-size:11px;margin-bottom:10px">NEW RELEASES</div>' : ''}
                    ${releases.map(r => `
                        <div class="intel-item">
                            <div class="title">
                                <a href="${r.url}" target="_blank">${r.repo}</a>
                                <span class="tag release">${r.tag}</span>
                            </div>
                            <div class="meta">
                                <span>Previous: ${r.previous || 'N/A'}</span>
                                <span>${timeAgo(r.discovered)}</span>
                            </div>
                        </div>
                    `).join('')}
                    <div style="color:#888;font-size:11px;margin:15px 0 10px">TRACKED REPOS (${repos.length})</div>
                    ${repos.map(r => `
                        <div class="intel-item">
                            <div class="title">
                                <a href="https://github.com/${r.repo}" target="_blank">${r.repo}</a>
                                <span class="tag">${r.tag}</span>
                            </div>
                        </div>
                    `).join('')}
                `;
            }
            else if (tab === 'discoveries') {
                const discoveries = intelData.models?.recentDiscoveries || [];
                content.innerHTML = discoveries.length ? discoveries.slice(0, 5).map(d => `
                    <div style="color:#ff6b35;font-size:12px;margin:10px 0 8px;font-weight:500">
                        ${new Date(d.date).toLocaleDateString()} - ${d.models.length} new model(s)
                    </div>
                    ${d.models.map(m => `
                        <div class="intel-item">
                            <div class="title">${m.name}</div>
                            <div class="meta">
                                <span>Size: ${m.size}</span>
                                <span>Digest: ${m.digest || 'N/A'}</span>
                            </div>
                        </div>
                    `).join('')}
                `).join('') : '<div style="color:#666;padding:20px;text-align:center">No recent model discoveries</div>';
            }
            else if (tab === 'websearch') {
                content.innerHTML = `
                    <div style="display:flex;gap:8px;margin-bottom:15px;">
                        <input type="text" id="searchQuery" placeholder="Search the web via Brave..."
                            style="flex:1;background:#0f0f1a;border:1px solid #333;border-radius:6px;padding:8px 12px;color:#fff;font-size:13px;outline:none;"
                            onkeydown="if(event.key==='Enter')runWebSearch()">
                        <button class="btn small" onclick="runWebSearch()">Search</button>
                    </div>
                    <div id="searchResults" style="color:#666;text-align:center;padding:20px;">Enter a query to search</div>
                `;
            }
        }

        // Tab clicks
        document.querySelectorAll('.intel-tab').forEach(tab => {
            tab.addEventListener('click', () => renderIntelTab(tab.dataset.tab));
        });

        // Load Health
        async function loadHealth() {
            try {
                const res = await fetchWithTimeout(`${API_BASE}/api/intel/health`);
                healthData = await res.json();

                document.getElementById('healthSamples').textContent =
                    `${healthData.historySize || 0} samples`;

                const trend = healthData.trends || {};
                const trendEl = document.getElementById('healthTrend');
                const statusEl = trendEl.querySelector('.status');
                statusEl.textContent = trend.trend || 'unknown';
                statusEl.className = `status ${trend.trend || ''}`;
                document.getElementById('healthAvg').textContent = trend.lastHourAvg || '--';

                // Trend indicator
                const indicator = trendEl.querySelector('.trend-indicator');
                if (trend.trend === 'improving') indicator.textContent = 'ðŸ“ˆ';
                else if (trend.trend === 'degrading') indicator.textContent = 'ðŸ“‰';
                else indicator.textContent = 'ðŸ“Š';

                // Chart â€” real history data
                const chart = document.getElementById('healthChart');
                const history = healthData.history || [];
                if (history.length > 0) {
                    const maxTotal = Math.max(...history.map(h => h.total), 1);
                    chart.innerHTML = history.map(h => {
                        const pct = Math.round(h.on / maxTotal * 100);
                        const ts = new Date(h.t).toLocaleTimeString();
                        return '<div class="chart-bar ' + (pct < 60 ? 'low' : '') + '" style="height:' + Math.max(4, pct) + '%" title="' + h.on + '/' + h.total + ' at ' + ts + '"></div>';
                    }).join('');
                } else {
                    chart.innerHTML = '<div style="color:#666;font-size:11px;text-align:center;width:100%;padding:40px 0;">No history data yet</div>';
                }

                // Incident timeline
                renderIncidentTimeline(history);

                // Anomalies - deduplicate by services key
                const anomalies = healthData.anomalies || [];
                const deduped = [];
                const seen = new Map();
                anomalies.slice().reverse().forEach((a, i) => {
                    const key = a.services.sort().join(',');
                    if (seen.has(key)) {
                        seen.get(key).count++;
                    } else {
                        const entry = { ...a, count: 1, origIndex: anomalies.length - 1 - i };
                        deduped.push(entry);
                        seen.set(key, entry);
                    }
                });
                document.getElementById('anomalyCount').textContent = anomalies.length;
                document.getElementById('anomalyList').innerHTML = deduped.length ?
                    deduped.slice(0, 15).map(a => `
                        <div class="anomaly-item ${a.severity}" onclick="showAnomalyDetail(${a.origIndex})">
                            <span class="anomaly-icon">${a.severity === 'high' ? 'ðŸ”´' : 'ðŸŸ¡'}</span>
                            <div class="anomaly-info">
                                <div class="anomaly-services">${a.services.join(', ')} offline</div>
                                <div class="anomaly-time">${timeAgo(a.timestamp)}${a.count > 1 ? ` (Ã—${a.count})` : ''}</div>
                            </div>
                            <div class="anomaly-drill">Details â†’</div>
                        </div>
                    `).join('') :
                    '<div style="color:#00ff88;text-align:center;padding:20px;">All systems nominal</div>';
            } catch (e) {
                console.error('Health load error:', e);
            }
        }

        // Show anomaly detail modal
        function showAnomalyDetail(index) {
            const anomalies = healthData.anomalies || [];
            const a = anomalies[index];
            if (!a) return;

            document.getElementById('anomalyModalBody').innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Timestamp</span>
                    <span class="detail-value">${new Date(a.timestamp).toLocaleString()}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Type</span>
                    <span class="detail-value">${a.type.replace(/_/g, ' ').toUpperCase()}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Severity</span>
                    <span class="detail-value ${a.severity === 'high' ? 'offline' : ''}" style="color:${a.severity === 'high' ? '#ff4444' : '#ffaa00'}">
                        ${a.severity.toUpperCase()}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Affected Services</span>
                    <span class="detail-value">${a.services.length}</span>
                </div>

                <div style="margin-top:20px;">
                    <h3 style="color:#888;font-size:12px;margin-bottom:10px;text-transform:uppercase;">Affected Services</h3>
                    ${a.services.map(s => {
                        const svc = SERVICES.find(sv => sv.name === s);
                        return `
                            <div style="background:#0f0f1a;padding:10px;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                                <div>
                                    <div style="color:#fff;font-weight:500;">${s}</div>
                                    <div style="color:#666;font-size:11px;">Port: ${svc?.port || 'Unknown'}</div>
                                </div>
                                ${svc ? `<button class="btn small" onclick="openService('${s}', ${svc.port})">Check</button>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>

                <div style="margin-top:20px;">
                    <h3 style="color:#888;font-size:12px;margin-bottom:10px;text-transform:uppercase;">Possible Causes</h3>
                    <ul style="color:#ccc;font-size:13px;margin-left:20px;line-height:1.8;">
                        <li>Service crashed or was stopped</li>
                        <li>Port conflict with another application</li>
                        <li>Resource exhaustion (memory/CPU)</li>
                        <li>Network connectivity issue</li>
                        <li>Dependency service unavailable</li>
                    </ul>
                </div>

                <div style="margin-top:20px;display:flex;gap:10px;">
                    <button class="btn secondary" onclick="closeModal()">Close</button>
                </div>
            `;
            document.getElementById('anomalyModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('anomalyModal').classList.remove('active');
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Load Models
        async function loadModels() {
            try {
                const res = await fetchWithTimeout(`${API_BASE}/api/intel/models`);
                const data = await res.json();

                const models = data.known || [];
                document.getElementById('modelCount').textContent = models.length;
                document.getElementById('modelList').innerHTML = models.map(m => `
                    <div class="model-item">
                        <span class="model-name">${m.name}</span>
                        <span class="model-size">${m.size}</span>
                    </div>
                `).join('') || '<div style="color:#666;text-align:center;padding:20px;">No models</div>';
            } catch (e) {
                document.getElementById('modelList').innerHTML =
                    '<div style="color:#ff4444">Failed to load</div>';
            }
        }

        // Load MCP Servers
        async function loadMCP() {
            try {
                const res = await fetchWithTimeout('http://${HOST}:8860/api/status', 5000);
                const data = await res.json();
                const servers = data.servers || [];

                const online = servers.filter(s => s.status === 'online').length;
                document.getElementById('mcpCount').textContent = `${online}/${servers.length}`;

                document.getElementById('mcpList').innerHTML = servers.map(s => `
                    <div class="mcp-item ${s.status}">
                        <div>
                            <div class="mcp-name">${s.name}</div>
                            <div class="mcp-tools">${s.description} (${s.toolCount} tools)</div>
                        </div>
                        <span class="mcp-status-badge">${s.status}</span>
                    </div>
                `).join('') || '<div style="color:#666;text-align:center;padding:20px;">No MCP servers</div>';
            } catch (e) {
                document.getElementById('mcpCount').textContent = 'offline';
                document.getElementById('mcpList').innerHTML =
                    '<div style="color:#666;text-align:center;padding:20px;">MCP Bridge :8860 offline</div>';
            }
        }

        // Load Alerts
        let lastAlertIds = new Set();
        async function loadAlerts() {
            try {
                const res = await fetchWithTimeout('http://${HOST}:8600/api/alerts?limit=30&unacked=true', 5000);
                const data = await res.json();
                let alerts = data.alerts || [];

                // Apply severity filter
                const sevFilter = document.getElementById('alertSeverityFilter')?.value || 'all';
                if (sevFilter !== 'all') {
                    alerts = alerts.filter(a => a.severity === sevFilter);
                }

                document.getElementById('alertCount').textContent = alerts.length;

                // Audio ping for new critical/error alerts
                if (dashSettings.alertSound) {
                    const newCritical = alerts.filter(a => (a.severity === 'critical' || a.severity === 'error') && !lastAlertIds.has(a.id));
                    if (newCritical.length > 0 && lastAlertIds.size > 0) {
                        try {
                            const ctx = new (window.AudioContext || window.webkitAudioContext)();
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();
                            osc.connect(gain); gain.connect(ctx.destination);
                            osc.frequency.value = 880; gain.gain.value = 0.15;
                            osc.start(); osc.stop(ctx.currentTime + 0.15);
                        } catch (e) {}
                    }
                }
                lastAlertIds = new Set(alerts.map(a => a.id));

                if (alerts.length === 0) {
                    document.getElementById('alertList').innerHTML =
                        '<div style="color:#00ff88;text-align:center;padding:20px;">No active alerts</div>';
                    return;
                }

                const icons = { critical: 'ðŸš¨', error: 'ðŸ”´', warning: 'ðŸŸ¡', info: 'ðŸ”µ' };
                document.getElementById('alertList').innerHTML = alerts.map(a => `
                    <div class="alert-item ${a.severity}">
                        <span class="alert-icon">${icons[a.severity] || 'âšª'}</span>
                        <div class="alert-info">
                            <div class="alert-title">${a.title}</div>
                            <div class="alert-time">${a.service ? a.service + ' - ' : ''}${timeAgo(a.created_at)}</div>
                        </div>
                        <button class="alert-ack" onclick="ackAlert(${a.id})" title="Acknowledge">ACK</button>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('alertList').innerHTML =
                    '<div style="color:#666;text-align:center;padding:20px;">Alert system unavailable</div>';
            }
        }

        async function ackAlert(id) {
            try {
                await fetch(`http://${HOST}:8600/api/alerts/${id}/ack`, { method: 'POST' });
                loadAlerts();
            } catch (e) { /* ignore */ }
        }

        async function ackAllAlerts() {
            try {
                const res = await fetchWithTimeout('http://${HOST}:8600/api/alerts?limit=50&unacked=true', 5000);
                const data = await res.json();
                const alerts = data.alerts || [];
                await Promise.all(alerts.map(a =>
                    fetch('http://${HOST}:8600/api/alerts/' + a.id + '/ack', { method: 'POST' }).catch(() => {})
                ));
                loadAlerts();
            } catch (e) {}
        }
        function openAllUIs() {
            const uis = [
                { port: 8899, name: 'Dashboard' },
                { port: 8585, name: 'KittBox' },
                { port: 8875, name: 'VoiceAccess' },
                { port: 8770, name: 'Personas' },
                { port: 8860, name: 'MCP Bridge' },
                { port: 8800, name: 'Hive Voice' }
            ];
            uis.forEach((ui, i) => setTimeout(() => window.open(`http://${HOST}:` + ui.port, '_blank'), i * 300));
        }

        // Service Logs
        async function loadLogs() {
            const logEl = document.getElementById('logContent');
            const source = document.getElementById('logSource').value;
            try {
                let lines = [];

                if (source === 'orchestrator') {
                    const res = await fetchWithTimeout('http://${HOST}:8500/api/log?lines=200', 5000);
                    const data = await res.json();
                    lines = (data.log || 'No log data').split('\n');
                } else if (source === 'alerts') {
                    const res = await fetchWithTimeout('http://${HOST}:8600/api/alerts?limit=100', 5000);
                    const data = await res.json();
                    const alerts = data.alerts || [];
                    lines = alerts.map(function(a) {
                        const ts = new Date(a.created_at).toLocaleString();
                        const sev = (a.severity || 'info').toUpperCase().padEnd(8);
                        const svc = (a.service || 'system').padEnd(15);
                        return '[' + ts + '] [' + sev + '] ' + svc + ' ' + a.title + (a.acknowledged ? ' [ACK]' : '');
                    });
                    if (lines.length === 0) lines = ['No alerts in the last 24h'];
                } else if (source === 'services') {
                    const res = await fetchWithTimeout('http://${HOST}:8500/api/status', 5000);
                    const data = await res.json();
                    lines = ['=== Service Status Snapshot â€” ' + new Date().toLocaleString() + ' ===', ''];
                    Object.entries(data.services || {}).forEach(function(entry) {
                        var id = entry[0], svc = entry[1];
                        var status = svc.healthy ? 'ONLINE ' : 'OFFLINE';
                        var restarts = svc.restartCount ? ' (restarts: ' + svc.restartCount + ')' : '';
                        lines.push('[' + status + '] ' + (svc.name || id).padEnd(22) + ':' + (svc.port || '?') + restarts);
                    });
                }

                document.getElementById('logsCount').textContent = lines.length;
                document.getElementById('logTimestamp').textContent = 'Updated ' + new Date().toLocaleTimeString();

                // Colorize log lines
                logEl.innerHTML = lines.map(function(line) {
                    if (/\[ERROR\]|error|FAIL|crashed|OFFLINE|CRITICAL/i.test(line)) return '<span style="color:#ff4444;">' + escapeHtml(line) + '</span>';
                    if (/\[WARN\]|warn|UNREACHABLE|WARNING/i.test(line)) return '<span style="color:#ffaa00;">' + escapeHtml(line) + '</span>';
                    if (/online|started|healthy|RECOVERED|INFO|ACK/i.test(line)) return '<span style="color:#00ff88;">' + escapeHtml(line) + '</span>';
                    if (/restart/i.test(line)) return '<span style="color:#00d9ff;">' + escapeHtml(line) + '</span>';
                    if (/^===/.test(line)) return '<span style="color:#ff6b35;font-weight:bold;">' + escapeHtml(line) + '</span>';
                    return escapeHtml(line);
                }).join('\n');

                if (document.getElementById('logAutoScroll').checked) {
                    logEl.scrollTop = logEl.scrollHeight;
                }
            } catch (e) {
                logEl.textContent = 'Failed to load logs: ' + e.message;
                document.getElementById('logsCount').textContent = '!';
            }
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // Utility
        function timeAgo(dateStr) {
            if (!dateStr) return '';
            const diff = Date.now() - new Date(dateStr).getTime();
            const mins = Math.floor(diff / 60000);
            if (mins < 60) return `${mins}m ago`;
            const hours = Math.floor(mins / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.floor(hours / 24)}d ago`;
        }

        // Actions
        let lastRefreshTime = null;
        function refreshAll() {
            lastRefreshTime = Date.now();
            loadBriefing();
            loadServices();
            loadIntel();
            loadHealth();
            loadModels();
            loadMCP();
            loadAlerts();
            loadSystem();
        }

        // Update "last refreshed" indicator every second
        setInterval(() => {
            if (!lastRefreshTime) return;
            const secs = Math.floor((Date.now() - lastRefreshTime) / 1000);
            document.getElementById('lastRefresh').textContent = secs < 5 ? 'Just updated' : `Updated ${secs}s ago`;
        }, 1000);

        async function restartAllOffline() {
            try {
                const res = await fetchWithTimeout('http://${HOST}:8500/api/status', 5000);
                const data = await res.json();
                const offline = Object.entries(data.services).filter(([k, v]) => !v.healthy && v.port);
                if (offline.length === 0) { alert('All services are healthy!'); return; }
                const names = offline.map(([k, v]) => v.name).join(', ');
                if (!confirm('Restart ' + offline.length + ' offline services?\n\n' + names)) return;
                let restarted = 0;
                for (const [id] of offline) {
                    try {
                        await fetch('http://${HOST}:8500/api/services/' + id + '/restart', { method: 'POST' });
                        restarted++;
                    } catch (e) {}
                }
                alert('Restarted ' + restarted + '/' + offline.length + ' services. Refreshing in 5s...');
                setTimeout(refreshAll, 5000);
            } catch (e) {
                alert('Master-O unreachable: ' + e.message);
            }
        }

        async function forceIntelRefresh() {
            try {
                await fetch(`${API_BASE}/api/intel/refresh`, { method: 'POST' });
                setTimeout(refreshAll, 2000);
            } catch (e) {
                alert('Failed to refresh intel');
            }
        }

        async function runWebSearch() {
            const query = document.getElementById('searchQuery')?.value;
            if (!query) return;
            const resultsEl = document.getElementById('searchResults');
            resultsEl.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const res = await fetchWithTimeout(`http://${HOST}:8860/api/quick/search?q=${encodeURIComponent(query)}&count=10`, 15000);
                const data = await res.json();

                if (data.error) {
                    resultsEl.innerHTML = `<div style="color:#ff4444">${data.error}${data.hint ? '<br><span style="color:#888;font-size:11px;">' + data.hint + '</span>' : ''}</div>`;
                    return;
                }

                const results = data.result?.content?.[0]?.text ? JSON.parse(data.result.content[0].text) : data.result;
                const items = results?.web?.results || results?.results || [];

                if (items.length === 0) {
                    resultsEl.innerHTML = '<div style="color:#666;padding:20px;text-align:center">No results found</div>';
                    return;
                }

                resultsEl.innerHTML = items.map(item => `
                    <div class="intel-item">
                        <div class="title">
                            <a href="${item.url}" target="_blank">${item.title}</a>
                        </div>
                        <div style="color:#aaa;font-size:12px;margin:4px 0;">${item.description || ''}</div>
                        <div class="meta">
                            <span style="color:#00d9ff;">${new URL(item.url).hostname}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                resultsEl.innerHTML = `<div style="color:#ff4444">Search failed: ${e.message}<br><span style="color:#888;font-size:11px;">Ensure MCP Bridge :8860 is running with BRAVE_API_KEY</span></div>`;
            }
        }

        async function regenerateBriefing(btn) {
            if (btn) { btn.textContent = 'Generating...'; btn.disabled = true; }
            try {
                document.getElementById('briefingSummary').innerHTML = '<div class="loading">Regenerating briefing...</div>';
                const res = await fetchWithTimeout(API_BASE + '/api/intel/briefing?force=true', 15000);
                const data = await res.json();
                if (data.date) {
                    document.getElementById('briefingDate').textContent = new Date(data.date).toLocaleString();
                }
                // Reload the full briefing display
                await loadBriefing();
            } catch (e) {
                document.getElementById('briefingSummary').innerHTML = '<div style="color:#ff4444">Failed to regenerate briefing: ' + e.message + '</div>';
            }
            if (btn) { btn.textContent = 'Regenerate'; btn.disabled = false; }
        }

        // Load system resources from dashboard server
        async function loadSystem() {
            try {
                const res = await fetchWithTimeout('http://${HOST}:8899/api/system', 3000);
                const d = await res.json();
                document.getElementById('sysCpu').textContent = d.cpu.usage;
                document.getElementById('sysCpuBar').style.width = d.cpu.usage + '%';
                document.getElementById('sysCpuBar').style.background = d.cpu.usage > 80 ? '#ff4444' : d.cpu.usage > 50 ? '#ffaa00' : '#ff6b35';
                document.getElementById('sysRam').textContent = d.memory.percent;
                document.getElementById('sysRamBar').style.width = d.memory.percent + '%';
                document.getElementById('sysRamBar').style.background = d.memory.percent > 85 ? '#ff4444' : d.memory.percent > 60 ? '#ffaa00' : '#00d9ff';
                document.getElementById('sysHost').textContent = d.os.hostname;
                document.getElementById('sysUptime').textContent = formatUptime(d.os.uptime);
                document.getElementById('sysNode').textContent = d.node.version;
            } catch (e) {
                document.getElementById('sysCpu').textContent = '?';
                document.getElementById('sysRam').textContent = '?';
            }
        }

        // Load Curated Intel
        async function loadCuratedIntel() {
            const container = document.getElementById('intelCuratedList');
            const filter = document.getElementById('intelFilter')?.value || 'pending';
            try {
                const res = await fetchWithTimeout('http://${HOST}:3002/api/intel/curated?filter=' + filter, 10000);
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('intelCuratedCount').textContent = data.stats?.pending || 0;
                    document.getElementById('intelLastFetch').textContent = data.lastFetch ?
                        'Last: ' + new Date(data.lastFetch).toLocaleString() : '';

                    if (!data.items || data.items.length === 0) {
                        container.innerHTML = '<div style="color:#666;text-align:center;padding:30px;">No intel items. Click "Collect New" to fetch.</div>';
                        return;
                    }

                    container.innerHTML = data.items.map(item => {
                        const thumb = item.recommend ? 'ðŸ‘' : 'ðŸ‘Ž';
                        const thumbColor = item.recommend ? '#00ff88' : '#ff6b35';
                        const statusBadge = item.status === 'approved' ? '<span style="background:#00ff8833;color:#00ff88;padding:2px 6px;border-radius:4px;font-size:9px;margin-left:6px;">APPROVED</span>' :
                                           item.status === 'rejected' ? '<span style="background:#ff444433;color:#ff4444;padding:2px 6px;border-radius:4px;font-size:9px;margin-left:6px;">REJECTED</span>' : '';
                        return `
                            <div style="background:#0f0f1a;border-radius:8px;padding:12px;margin-bottom:8px;border-left:3px solid ${thumbColor};">
                                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
                                    <div style="flex:1;min-width:0;">
                                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                            <span style="font-size:18px;">${thumb}</span>
                                            <span style="color:#888;font-size:10px;background:#1a1a2e;padding:2px 6px;border-radius:4px;">${item.sourceIcon || 'ðŸ“°'} ${item.source}</span>
                                            <span style="color:#666;font-size:10px;">${item.relevance}/100</span>
                                            ${statusBadge}
                                        </div>
                                        <a href="${item.url}" target="_blank" style="color:#fff;font-weight:500;font-size:13px;text-decoration:none;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${item.title}">
                                            ${item.title}
                                        </a>
                                        <div style="color:#aaa;font-size:11px;margin-top:4px;">${item.summary || ''}</div>
                                        <div style="color:#ff9f1c;font-size:11px;margin-top:6px;font-style:italic;">ðŸ’­ ${item.thoughts || 'No analysis'}</div>
                                    </div>
                                    ${item.status === 'pending' ? `
                                    <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0;">
                                        <button onclick="approveIntel('${item.id}')" style="background:#00ff8822;color:#00ff88;border:1px solid #00ff88;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;">âœ“ Use</button>
                                        <button onclick="rejectIntel('${item.id}')" style="background:#ff444422;color:#ff4444;border:1px solid #ff4444;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:11px;">âœ— Skip</button>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div style="color:#ff4444;">Failed to load intel</div>';
                }
            } catch (e) {
                container.innerHTML = '<div style="color:#666;">Intel service offline</div>';
            }
        }

        async function collectIntel() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Collecting...';
            try {
                const res = await fetch('http://${HOST}:3002/api/intel/curated/collect', { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    btn.textContent = `Done (${data.itemCount})`;
                    setTimeout(() => { btn.textContent = 'Collect New'; btn.disabled = false; }, 2000);
                    loadCuratedIntel();
                } else {
                    btn.textContent = 'Failed';
                    setTimeout(() => { btn.textContent = 'Collect New'; btn.disabled = false; }, 2000);
                }
            } catch (e) {
                btn.textContent = 'Error';
                setTimeout(() => { btn.textContent = 'Collect New'; btn.disabled = false; }, 2000);
            }
        }

        async function approveIntel(id) {
            try {
                const res = await fetch('http://${HOST}:3002/api/intel/curated/' + id + '/approve', { method: 'POST' });
                if (res.ok) loadCuratedIntel();
            } catch (e) {
                console.error('Approve failed:', e);
            }
        }

        async function rejectIntel(id) {
            try {
                const res = await fetch('http://${HOST}:3002/api/intel/curated/' + id + '/reject', { method: 'POST' });
                if (res.ok) loadCuratedIntel();
            } catch (e) {
                console.error('Reject failed:', e);
            }
        }

        // Load Claude Code performance data
        async function loadClaudePerf(refresh = false) {
            const container = document.getElementById('claudePerfContent');
            try {
                const url = 'http://${HOST}:3002/api/intel/claude-performance' + (refresh ? '?refresh=true' : '');
                const res = await fetchWithTimeout(url, refresh ? 30000 : 5000);
                if (res.ok) {
                    const d = await res.json();
                    const current = refresh ? d.metrics : d.current;
                    const passRate = current?.daily || current?.weekly || '--';
                    const baseline = current?.baseline || 58;
                    const delta = passRate !== '--' ? (passRate - baseline).toFixed(0) : '--';
                    const deltaColor = delta > 0 ? '#00ff88' : delta < -5 ? '#ff4444' : delta < 0 ? '#ffaa00' : '#888';
                    const statusColor = passRate >= 55 ? '#00ff88' : passRate >= 50 ? '#ffaa00' : '#ff4444';

                    container.innerHTML = `
                        <div style="background:#0f0f1a;padding:12px;border-radius:8px;text-align:center;">
                            <div style="font-size:11px;color:#666;text-transform:uppercase;margin-bottom:4px;">Pass Rate</div>
                            <div style="font-size:28px;font-weight:700;color:${statusColor}">${passRate}%</div>
                            <div style="font-size:11px;color:${deltaColor};margin-top:4px;">${delta > 0 ? '+' : ''}${delta}% vs baseline</div>
                        </div>
                        <div style="background:#0f0f1a;padding:12px;border-radius:8px;">
                            <div style="font-size:11px;color:#666;margin-bottom:8px;">SWE-Bench Pro</div>
                            <div style="font-size:12px;color:#aaa;line-height:1.6;">
                                <div>7-day: <span style="color:#fff">${current?.weekly || '--'}%</span></div>
                                <div>30-day: <span style="color:#fff">${current?.monthly || '--'}%</span></div>
                                <div>Baseline: <span style="color:#888">${baseline}%</span></div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="color:#666;grid-column:span 2;text-align:center;padding:20px;">Performance data unavailable</div>';
                }
            } catch (e) {
                container.innerHTML = '<div style="color:#666;grid-column:span 2;text-align:center;padding:20px;">Tracker offline</div>';
            }
        }

        // Load weather data
        async function loadWeather() {
            const container = document.getElementById('weatherContent');
            const icao = document.getElementById('weatherAirport')?.value || 'EGLL';
            try {
                const res = await fetchWithTimeout('http://${HOST}:3002/api/weather/aviation/' + icao, 8000);
                if (res.ok) {
                    const w = await res.json();
                    const catColor = w.category === 'VFR' ? '#00ff88' : w.category === 'MVFR' ? '#ffaa00' : '#ff4444';
                    container.innerHTML = `
                        <div style="background:#0f0f1a;padding:12px;border-radius:8px;">
                            <div style="font-size:11px;color:#666;text-transform:uppercase;margin-bottom:4px;">Category</div>
                            <div style="font-size:20px;font-weight:700;color:${catColor}">${w.category}</div>
                            <div style="font-size:11px;color:#888;margin-top:4px;">${w.conditions}</div>
                        </div>
                        <div style="background:#0f0f1a;padding:12px;border-radius:8px;">
                            <div style="font-size:11px;color:#666;text-transform:uppercase;margin-bottom:4px;">Temperature</div>
                            <div style="font-size:20px;font-weight:700;color:#fff">${w.temperature.celsius}Â°C</div>
                            <div style="font-size:11px;color:#888;margin-top:4px;">${w.temperature.fahrenheit}Â°F</div>
                        </div>
                        <div style="background:#0f0f1a;padding:12px;border-radius:8px;">
                            <div style="font-size:11px;color:#666;text-transform:uppercase;margin-bottom:4px;">Wind</div>
                            <div style="font-size:20px;font-weight:700;color:#00d9ff">${w.wind.speed_kts} kts</div>
                            <div style="font-size:11px;color:#888;margin-top:4px;">${w.wind.direction}Â° ${w.wind.assessment}</div>
                        </div>
                        <div style="background:#0f0f1a;padding:12px;border-radius:8px;">
                            <div style="font-size:11px;color:#666;text-transform:uppercase;margin-bottom:4px;">Visibility</div>
                            <div style="font-size:20px;font-weight:700;color:#fff">${w.visibility.statute_miles} SM</div>
                            <div style="font-size:11px;color:#888;margin-top:4px;">${Math.round(w.visibility.meters/1000)} km</div>
                        </div>
                        <div style="background:#0f0f1a;padding:12px;border-radius:8px;">
                            <div style="font-size:11px;color:#666;text-transform:uppercase;margin-bottom:4px;">Pressure</div>
                            <div style="font-size:20px;font-weight:700;color:#fff">${w.pressure.inhg}</div>
                            <div style="font-size:11px;color:#888;margin-top:4px;">${w.pressure.hpa} hPa</div>
                        </div>
                        <div style="background:#0f0f1a;padding:12px;border-radius:8px;">
                            <div style="font-size:11px;color:#666;text-transform:uppercase;margin-bottom:4px;">Cloud Cover</div>
                            <div style="font-size:20px;font-weight:700;color:#fff">${w.cloud_cover}%</div>
                            <div style="font-size:11px;color:#888;margin-top:4px;">Humidity ${w.humidity}%</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="color:#ff4444;grid-column:span 3;">Weather unavailable</div>';
                }
            } catch (e) {
                container.innerHTML = '<div style="color:#666;grid-column:span 3;">Weather service offline</div>';
            }
        }

        // Load topology diagram
        async function loadTopology() {
            const container = document.getElementById('topologyDiagram');
            try {
                const res = await fetchWithTimeout('http://${HOST}:8899/api/topology', 10000);
                if (res.ok) {
                    const svg = await res.text();
                    // Apply dark theme CSS variables
                    const themed = svg.replace('style="--bg:#FFFFFF;--fg:#27272A', 'style="--bg:#0a0a0f;--fg:#e0e0e0');
                    container.innerHTML = themed;
                    // Make SVG responsive
                    const svgEl = container.querySelector('svg');
                    if (svgEl) {
                        svgEl.style.maxWidth = '100%';
                        svgEl.style.height = 'auto';
                    }
                } else {
                    container.innerHTML = '<div style="color:#ff4444;">Failed to load topology</div>';
                }
            } catch (e) {
                container.innerHTML = '<div style="color:#666;">Topology unavailable</div>';
            }
        }

        // Desktop notifications for service state changes
        function notifyStateChanges(results) {
            if (!dashSettings.desktopNotifications || Notification.permission !== 'granted') return;
            const wentOffline = [];
            const cameOnline = [];
            results.forEach(function(s) {
                const prev = previousServiceStates[s.name];
                if (prev && prev !== s.status) {
                    if (s.status === 'offline') wentOffline.push(s.name);
                    else if (prev === 'offline' && s.status === 'online') cameOnline.push(s.name);
                }
                previousServiceStates[s.name] = s.status;
            });
            if (wentOffline.length > 0) {
                new Notification('Hive: Services DOWN', { body: wentOffline.join(', '), icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%23ff4444"/></svg>', tag: 'hive-down' });
            }
            if (cameOnline.length > 0) {
                new Notification('Hive: Services RECOVERED', { body: cameOnline.join(', '), icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%2300ff88"/></svg>', tag: 'hive-up' });
            }
        }

        // Latency chart for service detail modal
        function renderLatencyChart(name) {
            const data = serviceLatencyHistory[name];
            const sparkData = serviceSparklineData[name];
            if (!data || data.length < 2) return '<div style="background:#0f0f1a;border-radius:8px;padding:15px;"><div style="color:#888;font-size:11px;text-transform:uppercase;margin-bottom:8px;">Response Time History</div><div style="color:#666;font-size:12px;">Collecting data... (available after 2+ checks)</div></div>';
            const maxMs = Math.max(...data, 1);
            const w = 480, h = 60;
            const barW = w / data.length;
            let bars = data.map((ms, i) => {
                const online = sparkData && sparkData[i] !== undefined ? sparkData[i] : 1;
                const barH = online ? Math.max(2, ms / maxMs * h) : h;
                const color = !online ? '#ff4444' : ms < 100 ? '#00ff88' : ms < 500 ? '#ffaa00' : '#ff4444';
                return '<rect x="' + (i * barW) + '" y="' + (h - barH) + '" width="' + Math.max(barW - 1, 1) + '" height="' + barH + '" fill="' + color + '" opacity="0.7"/>';
            }).join('');
            const avg = Math.round(data.filter(d => d > 0).reduce((a, b) => a + b, 0) / data.filter(d => d > 0).length) || 0;
            const maxVal = Math.max(...data.filter(d => d > 0));
            const uptimePct = sparkData ? Math.round(sparkData.filter(v => v === 1).length / sparkData.length * 100) : '--';
            return '<div style="background:#0f0f1a;border-radius:8px;padding:15px;">' +
                '<div style="display:flex;justify-content:space-between;margin-bottom:8px;">' +
                '<span style="color:#888;font-size:11px;text-transform:uppercase;">Response Time History</span>' +
                '<span style="color:#666;font-size:10px;">Avg: <span style="color:#fff;">' + avg + 'ms</span> | Max: <span style="color:#ffaa00;">' + maxVal + 'ms</span> | Uptime: <span style="color:#00ff88;">' + uptimePct + '%</span></span>' +
                '</div>' +
                '<svg width="100%" height="' + h + '" viewBox="0 0 ' + w + ' ' + h + '" preserveAspectRatio="none">' + bars + '</svg>' +
                '</div>';
        }

        // Incident Timeline â€” visualize service drops from health history
        function renderIncidentTimeline(history) {
            const el = document.getElementById('incidentTimeline');
            if (!history || history.length < 2) { el.innerHTML = ''; return; }

            // Find drop events (online count decreased between consecutive samples)
            const events = [];
            for (let i = 1; i < history.length; i++) {
                const prev = history[i - 1], curr = history[i];
                if (curr.on < prev.on) {
                    events.push({ t: curr.t, dropped: prev.on - curr.on, from: prev.on, to: curr.on, total: curr.total });
                } else if (curr.on > prev.on && prev.on < prev.total * 0.8) {
                    events.push({ t: curr.t, recovered: curr.on - prev.on, from: prev.on, to: curr.on, total: curr.total });
                }
            }
            if (events.length === 0) {
                el.innerHTML = '<div style="color:#00ff88;font-size:10px;text-align:center;padding:4px;">No incidents in history window</div>';
                return;
            }

            const recent = events.slice(-8);
            el.innerHTML = '<div style="color:#888;font-size:9px;text-transform:uppercase;margin-bottom:6px;">Incidents</div>' +
                recent.map(e => {
                    const time = new Date(e.t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    if (e.dropped) {
                        return '<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px;"><span style="color:#ff4444;">â–¼</span><span style="color:#ff4444;">' + time + '</span><span style="color:#888;">' + e.from + 'â†’' + e.to + '/' + e.total + ' (-' + e.dropped + ')</span></div>';
                    }
                    return '<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px;"><span style="color:#00ff88;">â–²</span><span style="color:#00ff88;">' + time + '</span><span style="color:#888;">' + e.from + 'â†’' + e.to + '/' + e.total + ' (+' + e.recovered + ')</span></div>';
                }).join('');
        }

        // Export status to clipboard
        function exportStatus() {
            const online = lastServiceResults.filter(s => s.status === 'online');
            const offline = lastServiceResults.filter(s => s.status !== 'online');
            const lines = [
                'HIVE STATUS â€” ' + new Date().toLocaleString(),
                'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
                'Services: ' + online.length + '/' + lastServiceResults.length + ' online',
                '',
                'ONLINE (' + online.length + '):',
                ...online.map(s => '  âœ“ ' + s.name + ' :' + s.port + (s.latency ? ' (' + s.latency + 'ms)' : '')),
            ];
            if (offline.length > 0) {
                lines.push('', 'OFFLINE (' + offline.length + '):');
                offline.forEach(s => lines.push('  âœ— ' + s.name + ' :' + s.port));
            }
            const cpu = document.getElementById('sysCpu').textContent;
            const ram = document.getElementById('sysRam').textContent;
            const host = document.getElementById('sysHost').textContent;
            lines.push('', 'System: CPU ' + cpu + '% | RAM ' + ram + '% | Host: ' + host);
            const text = lines.join('\n');
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('[onclick="exportStatus()"]');
                if (btn) { const orig = btn.textContent; btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = orig, 2000); }
            }).catch(() => alert(text));
        }

        // Command Palette
        var cmdSelectedIdx = 0;
        function getCommands() {
            const cmds = [
                { label: 'Refresh Dashboard', desc: 'Reload all dashboard data', icon: 'ðŸ”„', action: () => { closeCmdPalette(); refreshAll(); } },
                { label: 'Regenerate Briefing', desc: 'Force Oracle to regenerate briefing', icon: 'ðŸ“‹', action: () => { closeCmdPalette(); regenerateBriefing(); } },
                { label: 'Force Intel Refresh', desc: 'Fetch fresh intel from all sources', icon: 'ðŸŒ', action: () => { closeCmdPalette(); forceIntelRefresh(); } },
                { label: 'Restart All Offline', desc: 'Restart all unhealthy services', icon: 'ðŸ”´', action: () => { closeCmdPalette(); restartAllOffline(); } },
                { label: 'Export Status', desc: 'Copy system status to clipboard', icon: 'ðŸ“¤', action: () => { closeCmdPalette(); exportStatus(); } },
                { label: 'Toggle Logs', desc: 'Show/hide the service logs panel', icon: 'ðŸ“œ', action: () => { closeCmdPalette(); toggleSection('logs'); } },
                { label: 'Settings', desc: 'Open dashboard settings', icon: 'âš™', action: () => { closeCmdPalette(); openSettings(); } },
                { label: 'Open KittBox', desc: 'Command Center :8585', icon: 'ðŸ¤–', action: () => { closeCmdPalette(); window.open('http://${HOST}:8585', '_blank'); } },
                { label: 'Open VoiceAccess', desc: 'Voice management :8875', icon: 'ðŸŽ¤', action: () => { closeCmdPalette(); window.open('http://${HOST}:8875', '_blank'); } },
                { label: 'Open Personas', desc: 'AI personas :8770', icon: 'ðŸ‘¤', action: () => { closeCmdPalette(); window.open('http://${HOST}:8770', '_blank'); } },
                { label: 'Open MCP Bridge', desc: 'MCP servers :8860', icon: 'ðŸ”Œ', action: () => { closeCmdPalette(); window.open('http://${HOST}:8860', '_blank'); } },
                { label: 'Open All UIs', desc: 'Open all service dashboards', icon: 'ðŸ–¥ï¸', action: () => { closeCmdPalette(); openAllUIs(); } },
                { label: 'Clear All Alerts', desc: 'Acknowledge all alerts', icon: 'ðŸ”•', action: () => { closeCmdPalette(); ackAllAlerts(); } },
                { label: 'System Health Check', desc: 'Check all services now', icon: 'ðŸ’š', action: () => { closeCmdPalette(); loadServices(); } },
            ];
            // Add restart commands for each service
            lastServiceResults.forEach(s => {
                if (SERVICE_KEY_MAP[s.name]) {
                    cmds.push({ label: 'Restart ' + s.name, desc: ':' + s.port + ' â€” ' + s.status, icon: 'â†»', action: () => { closeCmdPalette(); restartServiceQuick(s.name, null); } });
                }
                cmds.push({ label: 'Open ' + s.name, desc: 'Open :' + s.port + ' in browser', icon: 'ðŸ”—', action: () => { closeCmdPalette(); window.open(`http://${HOST}:` + s.port, '_blank'); } });
            });
            return cmds;
        }

        function openCmdPalette() {
            document.getElementById('cmdPalette').classList.add('active');
            const input = document.getElementById('cmdInput');
            input.value = '';
            input.focus();
            cmdSelectedIdx = 0;
            filterCommands();
        }
        function closeCmdPalette() {
            document.getElementById('cmdPalette').classList.remove('active');
        }
        var _filteredCmds = [];
        function filterCommands() {
            const q = document.getElementById('cmdInput').value.toLowerCase();
            _filteredCmds = getCommands().filter(c => !q || c.label.toLowerCase().includes(q) || c.desc.toLowerCase().includes(q));
            cmdSelectedIdx = Math.min(cmdSelectedIdx, _filteredCmds.length - 1);
            document.getElementById('cmdResults').innerHTML = _filteredCmds.slice(0, 15).map((c, i) =>
                '<div class="cmd-item' + (i === cmdSelectedIdx ? ' selected' : '') + '" onmouseenter="cmdSelectedIdx=' + i + ';filterCommands()" onclick="_filteredCmds[' + i + '].action()" style="display:flex;align-items:center;gap:12px;padding:10px 14px;cursor:pointer;border-radius:8px;' + (i === cmdSelectedIdx ? 'background:#2a2a3e;' : '') + '">' +
                '<span style="font-size:16px;">' + c.icon + '</span>' +
                '<div><div style="color:#fff;font-size:13px;">' + c.label + '</div><div style="color:#666;font-size:11px;">' + c.desc + '</div></div>' +
                '</div>'
            ).join('') || '<div style="color:#666;text-align:center;padding:20px;">No matching commands</div>';
        }
        function handleCmdKey(e) {
            if (e.key === 'ArrowDown') { e.preventDefault(); cmdSelectedIdx = Math.min(cmdSelectedIdx + 1, _filteredCmds.length - 1); filterCommands(); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); cmdSelectedIdx = Math.max(cmdSelectedIdx - 1, 0); filterCommands(); }
            else if (e.key === 'Enter' && _filteredCmds[cmdSelectedIdx]) { e.preventDefault(); _filteredCmds[cmdSelectedIdx].action(); }
            else if (e.key === 'Escape') { closeCmdPalette(); }
        }

        // Settings panel
        let refreshIntervalId = null;
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('setAutoRestart').checked = dashSettings.autoRestart;
            document.getElementById('setAlertSound').checked = dashSettings.alertSound;
            document.getElementById('setNotifications').checked = dashSettings.desktopNotifications;
            document.getElementById('setRefreshInterval').value = String(dashSettings.refreshInterval);
        }
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        function toggleSetting(key, value) {
            dashSettings[key] = value;
            saveSettings();
            if (key === 'desktopNotifications' && value && 'Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        function changeRefreshInterval(val) {
            dashSettings.refreshInterval = parseInt(val);
            saveSettings();
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            refreshIntervalId = setInterval(refreshAll, dashSettings.refreshInterval * 1000);
        }
        function resetSettings() {
            dashSettings = { autoRestart: false, refreshInterval: 30, alertSound: false, desktopNotifications: true, compactMode: false };
            saveSettings();
            openSettings(); // re-render checkboxes
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            refreshIntervalId = setInterval(refreshAll, 30000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            }
            if (e.key === 'k' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                openCmdPalette();
                return;
            }
            if (e.key === 'r' && !e.ctrlKey && !e.metaKey && e.target.tagName !== 'INPUT') {
                refreshAll();
            }
        });

        // Init â€” populate services from Orchestrator, then start refresh cycle
        (async () => {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            await populateServicesFromOrchestrator();
            refreshAll();
            loadTopology();
            loadWeather();
            loadClaudePerf();
            loadCuratedIntel();
            refreshIntervalId = setInterval(refreshAll, dashSettings.refreshInterval * 1000);
        })();
    </script>
</body>
</html>
