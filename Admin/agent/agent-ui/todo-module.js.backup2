/**
 * TODO Module v2.0.0
 * Free-floating, draggable TODO panel with multiple lists
 * 
 * Path: C:\DevClaude\SimWidget_Engine\Admin\agent\agent-ui\todo-module.js
 * Last Updated: 2025-01-09
 * 
 * Usage: Include this script and call TodoModule.init(apiBase)
 */

const TodoModule = (function() {
    let apiBase = '';
    let allLists = {};
    let currentListName = 'General';
    let todos = [];
    let draggedItem = null;
    let isMinimized = false;
    let config = {
        assistantName: 'Kitt',
        inputSelector: '#message-input'
    };
    
    const DEFAULT_LISTS = ['General', 'SimWidget', 'Agent', 'Admin', 'MSFS'];
    
    const PRIORITIES = [
        { id: 'mustdo', label: '‚ö° MUSTDO', color: '#ff4444' },
        { id: 'high', label: 'üî¥ High', color: '#ff8844' },
        { id: 'medium', label: 'üü° Medium', color: '#ffcc00' },
        { id: 'low', label: 'üü¢ Low', color: '#44cc44' },
        { id: 'thought', label: 'üí≠ Thought', color: '#888888' }
    ];

    function createStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .todo-panel {
                position: fixed;
                top: 80px;
                right: 20px;
                width: 320px;
                max-height: 500px;
                background: #1a1a2e;
                border: 1px solid #333;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                z-index: 9999;
                display: flex;
                flex-direction: column;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                overflow: hidden;
            }
            .todo-panel.minimized {
                max-height: 44px;
                width: auto;
                min-width: 120px;
            }
            .todo-panel.minimized .todo-body,
            .todo-panel.minimized .todo-input-area {
                display: none;
            }
            .todo-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 14px;
                background: #2a2a3e;
                cursor: move;
                user-select: none;
                border-bottom: 1px solid #333;
            }
            .todo-header h3 {
                margin: 0;
                font-size: 14px;
                color: #fff;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .todo-count {
                background: #4a9eff;
                color: #fff;
                font-size: 11px;
                padding: 2px 6px;
                border-radius: 10px;
            }
            .todo-header-btns {
                display: flex;
                gap: 4px;
            }
            .todo-header-btn {
                background: none;
                border: none;
                color: #888;
                cursor: pointer;
                font-size: 16px;
                padding: 4px;
                border-radius: 4px;
            }
            .todo-header-btn:hover {
                background: #3a3a4e;
                color: #fff;
            }
            .todo-list-selector {
                background: #1a1a2e;
                border: 1px solid #333;
                border-radius: 6px;
                padding: 4px 8px;
                color: #4a9eff;
                font-size: 12px;
                cursor: pointer;
                margin-left: 8px;
            }
            .todo-list-selector:hover {
                border-color: #4a9eff;
            }
            .todo-list-selector:focus {
                outline: none;
                border-color: #4a9eff;
            }
            .todo-new-list-btn {
                background: none;
                border: 1px solid #333;
                color: #888;
                cursor: pointer;
                font-size: 14px;
                padding: 2px 6px;
                border-radius: 4px;
                margin-left: 4px;
            }
            .todo-new-list-btn:hover {
                background: #3a3a4e;
                color: #4a9eff;
                border-color: #4a9eff;
            }
            .todo-body {
                flex: 1;
                overflow-y: auto;
                padding: 8px;
                max-height: 350px;
            }
            .todo-section {
                margin-bottom: 12px;
            }
            .todo-section-header {
                font-size: 11px;
                font-weight: 600;
                color: #888;
                padding: 4px 8px;
                text-transform: uppercase;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            .todo-section-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
            }
            .todo-item {
                background: #2a2a3e;
                border: 1px solid #333;
                border-radius: 8px;
                padding: 10px 12px;
                margin-bottom: 6px;
                cursor: grab;
                display: flex;
                align-items: flex-start;
                gap: 10px;
                transition: all 0.3s ease;
            }
            .todo-item:hover {
                border-color: #4a9eff;
            }
            .todo-item.dragging {
                opacity: 0.5;
                transform: scale(1.02);
            }
            .todo-item.drag-over {
                border-color: #4a9eff;
                background: #3a3a4e;
            }
            .todo-checkbox {
                width: 18px;
                height: 18px;
                border: 2px solid #555;
                border-radius: 4px;
                cursor: pointer;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-top: 2px;
            }
            .todo-checkbox:hover {
                border-color: #4a9eff;
            }
            .todo-checkbox.checked {
                background: #22c55e;
                border-color: #22c55e;
            }
            .todo-checkbox.checked::after {
                content: '‚úì';
                color: #fff;
                font-size: 12px;
            }
            .todo-content {
                flex: 1;
                min-width: 0;
                cursor: pointer;
            }
            .todo-content:hover {
                background: rgba(74, 158, 255, 0.1);
                border-radius: 4px;
                margin: -4px;
                padding: 4px;
            }
            .todo-text {
                color: #e0e0e0;
                font-size: 13px;
                word-wrap: break-word;
                cursor: pointer;
            }
            .todo-text:hover {
                background: rgba(74, 158, 255, 0.1);
                border-radius: 4px;
            }
            .todo-edit-input {
                width: 100%;
                background: #1a1a2e;
                border: 1px solid #4a9eff;
                border-radius: 4px;
                padding: 4px 8px;
                color: #e0e0e0;
                font-size: 13px;
                outline: none;
                resize: none;
                overflow: hidden;
                font-family: inherit;
                line-height: 1.4;
            }
            .todo-thought {
                font-size: 11px;
                color: #888;
                font-style: italic;
                margin-top: 4px;
                padding: 4px 8px;
                background: rgba(74, 158, 255, 0.1);
                border-radius: 4px;
                border-left: 2px solid #4a9eff;
                cursor: pointer;
            }
            .todo-thought:hover {
                background: rgba(74, 158, 255, 0.2);
            }
            .todo-item.completed .todo-text {
                text-decoration: line-through;
                color: #666;
            }
            .todo-item.completed {
                opacity: 0.5;
                transition: opacity 0.5s ease, transform 0.5s ease;
            }
            .todo-meta {
                font-size: 10px;
                color: #666;
                margin-top: 4px;
            }
            .todo-actions {
                display: flex;
                gap: 2px;
                opacity: 0;
                transition: opacity 0.15s;
            }
            .todo-item:hover .todo-actions {
                opacity: 1;
            }
            .todo-action-btn {
                background: none;
                border: none;
                color: #666;
                cursor: pointer;
                font-size: 14px;
                padding: 2px 4px;
                border-radius: 4px;
            }
            .todo-action-btn:hover {
                background: #3a3a4e;
                color: #fff;
            }
            .todo-action-btn.delete:hover {
                color: #ff4444;
            }
            .todo-action-btn[data-action="send"]:hover {
                color: #4a9eff;
            }
            .todo-input-area {
                padding: 10px;
                border-top: 1px solid #333;
                background: #2a2a3e;
            }
            .todo-input-row {
                display: flex;
                gap: 8px;
            }
            .todo-input {
                flex: 1;
                background: #1a1a2e;
                border: 1px solid #333;
                border-radius: 6px;
                padding: 8px 12px;
                color: #e0e0e0;
                font-size: 13px;
                outline: none;
            }
            .todo-input:focus {
                border-color: #4a9eff;
            }
            .todo-thought-input {
                width: 100%;
                background: #1a1a2e;
                border: 1px solid #333;
                border-radius: 6px;
                padding: 6px 12px;
                color: #888;
                font-size: 12px;
                font-style: italic;
                outline: none;
                margin-top: 6px;
            }
            .todo-thought-input:focus {
                border-color: #4a9eff;
                color: #e0e0e0;
            }
            .todo-priority-select {
                background: #1a1a2e;
                border: 1px solid #333;
                border-radius: 6px;
                padding: 8px;
                color: #ccc;
                font-size: 12px;
                cursor: pointer;
            }
            .todo-add-btn {
                background: #4a9eff;
                border: none;
                border-radius: 6px;
                padding: 8px 14px;
                color: #fff;
                font-size: 13px;
                cursor: pointer;
                font-weight: 500;
            }
            .todo-add-btn:hover {
                background: #3a8eef;
            }
            .todo-empty {
                text-align: center;
                padding: 30px;
                color: #666;
                font-size: 13px;
            }
            .priority-menu {
                position: absolute;
                background: #2a2a3e;
                border: 1px solid #333;
                border-radius: 8px;
                padding: 4px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
            .priority-menu-item {
                padding: 8px 12px;
                cursor: pointer;
                border-radius: 4px;
                font-size: 12px;
                color: #ccc;
            }
            .priority-menu-item:hover {
                background: #3a3a4e;
            }
            .priority-menu-item.selected {
                background: #3a3a4e;
                border-left: 3px solid #4a9eff;
            }
            .priority-menu-item.selected::after {
                content: '?';
                float: right;
                color: #4a9eff;
                font-weight: bold;
            }
        `;
        document.head.appendChild(style);
    }

    function createPanel() {
        const panel = document.createElement('div');
        panel.className = 'todo-panel';
        panel.id = 'todo-panel';
        panel.innerHTML = `
            <div class="todo-header" id="todo-drag-handle">
                <h3>üìã <select class="todo-list-selector" id="todo-list-selector"></select><button class="todo-new-list-btn" id="todo-new-list" title="New List">+</button> <span class="todo-count" id="todo-count">0</span></h3>
                <div class="todo-header-btns">
                    <button class="todo-header-btn" id="todo-minimize" title="Minimize">‚àí</button>
                    <button class="todo-header-btn" id="todo-close" title="Close">√ó</button>
                </div>
            </div>
            <div class="todo-body" id="todo-body"></div>
            <div class="todo-input-area">
                <div class="todo-input-row">
                    <input type="text" class="todo-input" id="todo-new-input" placeholder="Add new task...">
                    <select class="todo-priority-select" id="todo-new-priority">
                        ${PRIORITIES.map(p => `<option value="${p.id}">${p.label}</option>`).join('')}
                    </select>
                    <button class="todo-add-btn" id="todo-add-btn">Add</button>
                </div>
                <input type="text" class="todo-thought-input" id="todo-new-thought" placeholder="üí≠ Add thought/notes (optional)...">
            </div>
        `;
        document.body.appendChild(panel);
        
        setupDragPanel(panel);
        setupEvents();
    }

    function setupDragPanel(panel) {
        const handle = document.getElementById('todo-drag-handle');
        let isDragging = false;
        let startX, startY, startLeft, startTop;

        handle.addEventListener('mousedown', (e) => {
            if (e.target.tagName === 'BUTTON') return;
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            const rect = panel.getBoundingClientRect();
            startLeft = rect.left;
            startTop = rect.top;
            panel.style.transition = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            panel.style.left = (startLeft + dx) + 'px';
            panel.style.top = (startTop + dy) + 'px';
            panel.style.right = 'auto';
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                saveState();
            }
            isDragging = false;
            panel.style.transition = '';
        });
    }

    function setupEvents() {
        document.getElementById('todo-minimize').addEventListener('click', toggleMinimize);
        document.getElementById('todo-close').addEventListener('click', hide);
        document.getElementById('todo-add-btn').addEventListener('click', addTodo);
        document.getElementById('todo-new-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTodo();
        });
        // Auto-submit when priority is selected and there's text
        document.getElementById('todo-new-priority').addEventListener('change', () => {
            const input = document.getElementById('todo-new-input');
            if (input.value.trim()) {
                addTodo();
            }
        });
        // List selector
        document.getElementById('todo-list-selector').addEventListener('change', (e) => {
            switchList(e.target.value);
        });
        // New list button
        document.getElementById('todo-new-list').addEventListener('click', createNewList);
    }
    
    function populateListSelector() {
        const selector = document.getElementById('todo-list-selector');
        const lists = Object.keys(allLists).length > 0 ? Object.keys(allLists) : DEFAULT_LISTS;
        selector.innerHTML = lists.map(name => 
            `<option value="${name}" ${name === currentListName ? 'selected' : ''}>${name}</option>`
        ).join('');
    }
    
    async function switchList(listName) {
        // Save current list first
        allLists[currentListName] = todos;
        
        currentListName = listName;
        todos = allLists[listName] || [];
        render();
        saveState();
        await saveTodos();
    }
    
    async function createNewList() {
        const name = prompt('New list name:');
        if (!name || name.trim() === '') return;
        
        const trimmedName = name.trim();
        if (allLists[trimmedName]) {
            alert('List already exists');
            return;
        }
        
        // Save current list
        allLists[currentListName] = todos;
        
        // Create new list
        allLists[trimmedName] = [];
        currentListName = trimmedName;
        todos = [];
        
        populateListSelector();
        render();
        saveState();
        await saveTodos();
    }

    function toggleMinimize() {
        const panel = document.getElementById('todo-panel');
        isMinimized = !isMinimized;
        panel.classList.toggle('minimized', isMinimized);
        document.getElementById('todo-minimize').textContent = isMinimized ? '+' : '‚àí';
        saveState();
    }

    function hide() {
        document.getElementById('todo-panel').style.display = 'none';
        saveState();
    }

    function toggle() {
        const panel = document.getElementById('todo-panel');
        if (panel.style.display === 'none' || !panel.style.display) {
            show();
        } else {
            hide();
        }
    }

    async function show() {
        const panel = document.getElementById('todo-panel');
        panel.style.display = 'flex';
        await loadTodos();
        saveState();
    }
    
    function saveState() {
        const panel = document.getElementById('todo-panel');
        const state = {
            visible: panel.style.display !== 'none',
            minimized: isMinimized,
            currentList: currentListName,
            top: panel.style.top,
            left: panel.style.left,
            right: panel.style.right
        };
        localStorage.setItem('todo-panel-state', JSON.stringify(state));
    }
    
    async function loadState() {
        try {
            const saved = localStorage.getItem('todo-panel-state');
            if (saved) {
                const state = JSON.parse(saved);
                const panel = document.getElementById('todo-panel');
                
                // Restore current list name
                if (state.currentList) {
                    currentListName = state.currentList;
                }
                
                if (state.visible) {
                    panel.style.display = 'flex';
                    await loadTodos();
                }
                
                if (state.minimized) {
                    isMinimized = true;
                    panel.classList.add('minimized');
                    document.getElementById('todo-minimize').textContent = '+';
                }
                
                if (state.top) panel.style.top = state.top;
                if (state.left) panel.style.left = state.left;
                if (state.right) panel.style.right = state.right;
            }
        } catch (err) {
            console.error('Failed to load todo panel state:', err);
        }
    }

    async function loadTodos() {
        try {
            const response = await fetch(`${apiBase}/api/todos`);
            const data = await response.json();
            
            // Always ensure default lists exist
            DEFAULT_LISTS.forEach(name => {
                if (!allLists[name]) {
                    allLists[name] = [];
                }
            });
            
            // Handle new multi-list format or migrate from old format
            if (data.lists && Object.keys(data.lists).length > 0) {
                // Merge with defaults
                Object.keys(data.lists).forEach(name => {
                    allLists[name] = data.lists[name];
                });
                currentListName = data.currentList || currentListName;
            } else if (data.todos && data.todos.length > 0) {
                // Migrate old format - put old todos in General
                allLists['General'] = data.todos;
                currentListName = 'General';
            }
            
            // Ensure current list exists
            if (!allLists[currentListName]) {
                currentListName = 'General';
            }
            
            todos = allLists[currentListName] || [];
            populateListSelector();
            render();
            
            // Save to ensure defaults are persisted
            saveTodos();
        } catch (err) {
            console.error('Failed to load todos:', err);
            DEFAULT_LISTS.forEach(name => {
                allLists[name] = [];
            });
            todos = [];
            populateListSelector();
            render();
        }
    }

    async function saveTodos() {
        try {
            // Update current list in allLists
            allLists[currentListName] = todos;
            
            await fetch(`${apiBase}/api/todos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    lists: allLists,
                    currentList: currentListName
                })
            });
        } catch (err) {
            console.error('Failed to save todos:', err);
        }
    }

    function render() {
        const body = document.getElementById('todo-body');
        const count = document.getElementById('todo-count');
        
        const activeTodos = todos.filter(t => !t.completed);
        count.textContent = activeTodos.length;

        if (todos.length === 0) {
            body.innerHTML = '<div class="todo-empty">No tasks yet.<br>Add one below!</div>';
            return;
        }

        // Group by priority
        const grouped = {};
        PRIORITIES.forEach(p => grouped[p.id] = []);
        todos.forEach(t => {
            if (grouped[t.priority]) grouped[t.priority].push(t);
            else grouped['medium'].push(t);
        });

        // Sort each group: incomplete first, completed at bottom
        PRIORITIES.forEach(p => {
            grouped[p.id].sort((a, b) => (a.completed ? 1 : 0) - (b.completed ? 1 : 0));
        });

        let html = '';
        PRIORITIES.forEach(p => {
            const items = grouped[p.id];
            if (items.length === 0) return;
            
            html += `
                <div class="todo-section" data-priority="${p.id}">
                    <div class="todo-section-header">
                        <span class="todo-section-dot" style="background:${p.color}"></span>
                        ${p.label} (${items.length})
                    </div>
                    ${items.map(t => renderItem(t)).join('')}
                </div>
            `;
        });

        body.innerHTML = html;
        setupItemEvents();
    }

    function renderItem(todo) {
        const time = new Date(todo.createdAt).toLocaleDateString();
        return `
            <div class="todo-item ${todo.completed ? 'completed' : ''}" 
                 data-id="${todo.id}" 
                 draggable="true">
                <div class="todo-checkbox ${todo.completed ? 'checked' : ''}" data-action="toggle"></div>
                <div class="todo-content">
                    <div class="todo-text" data-action="edit-text" title="Click to edit">${escapeHtml(todo.text)}</div>
                    ${todo.thought ? `<div class="todo-thought" data-action="edit-thought" title="Click to edit">üí≠ ${escapeHtml(todo.thought)}</div>` : ''}
                    <div class="todo-meta">${time}</div>
                </div>
                <div class="todo-actions">
                    <button class="todo-action-btn" data-action="send" title="Send to ${config.assistantName}">‚û§</button>
                    <button class="todo-action-btn" data-action="priority" title="Change priority">‚óê</button>
                    <button class="todo-action-btn delete" data-action="delete" title="Delete">√ó</button>
                </div>
            </div>
        `;
    }

    function setupItemEvents() {
        document.querySelectorAll('.todo-item').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragend', handleDragEnd);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragleave', handleDragLeave);

            item.querySelector('[data-action="toggle"]').addEventListener('click', () => {
                toggleComplete(item.dataset.id);
            });

            item.querySelector('[data-action="delete"]').addEventListener('click', () => {
                deleteTodo(item.dataset.id);
            });

            item.querySelector('[data-action="priority"]').addEventListener('click', (e) => {
                showPriorityMenu(e, item.dataset.id);
            });

            // Send to input button
            item.querySelector('[data-action="send"]').addEventListener('click', () => {
                copyToInput(item.dataset.id);
            });
            
            // Click to edit text
            const textEl = item.querySelector('[data-action="edit-text"]');
            if (textEl) {
                textEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    startEditText(item.dataset.id, textEl);
                });
            }
            
            // Click to edit thought
            const thoughtEl = item.querySelector('[data-action="edit-thought"]');
            if (thoughtEl) {
                thoughtEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    startEditThought(item.dataset.id, thoughtEl);
                });
            }
        });
    }

    function handleDragStart(e) {
        draggedItem = e.target.closest('.todo-item');
        draggedItem.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }
        document.querySelectorAll('.todo-item').forEach(i => i.classList.remove('drag-over'));
    }

    function handleDragOver(e) {
        e.preventDefault();
        const item = e.target.closest('.todo-item');
        if (item && item !== draggedItem) {
            item.classList.add('drag-over');
        }
        
        // Auto-scroll when near edges
        const todoBody = document.querySelector('.todo-body');
        if (todoBody) {
            const rect = todoBody.getBoundingClientRect();
            const scrollZone = 40; // pixels from edge to trigger scroll
            const scrollSpeed = 8;
            
            if (e.clientY < rect.top + scrollZone) {
                // Near top - scroll up
                todoBody.scrollTop -= scrollSpeed;
            } else if (e.clientY > rect.bottom - scrollZone) {
                // Near bottom - scroll down
                todoBody.scrollTop += scrollSpeed;
            }
        }
    }

    function handleDragLeave(e) {
        const item = e.target.closest('.todo-item');
        if (item) item.classList.remove('drag-over');
    }

    async function handleDrop(e) {
        e.preventDefault();
        const targetItem = e.target.closest('.todo-item');
        if (!targetItem || !draggedItem || targetItem === draggedItem) return;

        const draggedId = draggedItem.dataset.id;
        const targetId = targetItem.dataset.id;
        
        // Get target's priority section
        const targetSection = targetItem.closest('.todo-section');
        const newPriority = targetSection ? targetSection.dataset.priority : 'medium';

        // Find indices
        const draggedIdx = todos.findIndex(t => t.id === draggedId);
        const targetIdx = todos.findIndex(t => t.id === targetId);

        if (draggedIdx > -1 && targetIdx > -1) {
            // Update priority
            todos[draggedIdx].priority = newPriority;
            
            // Reorder
            const [removed] = todos.splice(draggedIdx, 1);
            const newTargetIdx = todos.findIndex(t => t.id === targetId);
            todos.splice(newTargetIdx, 0, removed);
            
            await saveTodos();
            render();
        }
    }

    function showPriorityMenu(e, todoId) {
        // Remove existing menu
        const existing = document.querySelector('.priority-menu');
        if (existing) existing.remove();

        const menu = document.createElement('div');
        menu.className = 'priority-menu';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';

        menu.innerHTML = PRIORITIES.map(p => `
            <div class="priority-menu-item" data-priority="${p.id}">
                <span style="color:${p.color}">‚óè</span> ${p.label}
            </div>
        `).join('');

        document.body.appendChild(menu);

        menu.querySelectorAll('.priority-menu-item').forEach(item => {
            item.addEventListener('click', () => {
                changePriority(todoId, item.dataset.priority);
                menu.remove();
            });
        });

        // Close on click outside
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 0);
    }

    async function changePriority(id, priority) {
        const todo = todos.find(t => t.id === id);
        if (todo) {
            if (todo.priority === priority) {
                // Same priority selected - show a brief flash feedback
                const item = document.querySelector(`.todo-item[data-id="${id}"]`);
                if (item) {
                    item.style.background = '#4a9eff';
                    setTimeout(() => {
                        item.style.background = '';
                    }, 200);
                }
                return;
            }
            todo.priority = priority;
            await saveTodos();
            render();
        }
    }

    async function toggleComplete(id) {
        const todo = todos.find(t => t.id === id);
        if (!todo) return;
        
        // Get the item element for animation
        const item = document.querySelector(`.todo-item[data-id="${id}"]`);
        
        if (!todo.completed && item) {
            // Animate fade when completing
            item.style.opacity = '0.5';
            item.style.transform = 'translateX(10px)';
            setTimeout(async () => {
                todo.completed = !todo.completed;
                await saveTodos();
                render();
            }, 300);
        } else {
            todo.completed = !todo.completed;
            await saveTodos();
            render();
        }
    }

    async function deleteTodo(id) {
        todos = todos.filter(t => t.id !== id);
        await saveTodos();
        render();
    }
    
    function startEditText(id, element) {
        const todo = todos.find(t => t.id === id);
        if (!todo) return;
        
        const currentText = todo.text;
        const rect = element.getBoundingClientRect();
        
        const textarea = document.createElement('textarea');
        textarea.className = 'todo-edit-input';
        textarea.value = currentText;
        textarea.style.minHeight = Math.max(rect.height, 24) + 'px';
        
        element.innerHTML = '';
        element.appendChild(textarea);
        textarea.focus();
        textarea.select();
        
        // Auto-resize to content
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
        
        const saveEdit = async () => {
            const newText = textarea.value.trim();
            if (newText && newText !== currentText) {
                todo.text = newText;
                await saveTodos();
            }
            render();
        };
        
        textarea.addEventListener('blur', saveEdit);
        textarea.addEventListener('input', () => {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        });
        textarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                textarea.blur();
            } else if (e.key === 'Escape') {
                render();
            }
        });
    }
    
    function startEditThought(id, element) {
        const todo = todos.find(t => t.id === id);
        if (!todo) return;
        
        const currentThought = todo.thought || '';
        const rect = element.getBoundingClientRect();
        
        const textarea = document.createElement('textarea');
        textarea.className = 'todo-edit-input';
        textarea.value = currentThought;
        textarea.placeholder = 'Add thought...';
        textarea.style.minHeight = Math.max(rect.height, 20) + 'px';
        textarea.style.fontSize = '11px';
        textarea.style.fontStyle = 'italic';
        
        element.innerHTML = '';
        element.appendChild(textarea);
        textarea.focus();
        textarea.select();
        
        // Auto-resize to content
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
        
        const saveEdit = async () => {
            const newThought = textarea.value.trim();
            if (newThought !== currentThought) {
                todo.thought = newThought;
                await saveTodos();
            }
            render();
        };
        
        textarea.addEventListener('blur', saveEdit);
        textarea.addEventListener('input', () => {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        });
        textarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                textarea.blur();
            } else if (e.key === 'Escape') {
                render();
            }
        });
    }

    function copyToInput(id) {
        const todo = todos.find(t => t.id === id);
        if (!todo) return;
        
        // Find message input and set value
        const input = document.querySelector(config.inputSelector);
        if (input) {
            input.value = todo.text;
            input.focus();
            
            // Visual feedback on the todo item
            const item = document.querySelector(`.todo-item[data-id="${id}"]`);
            if (item) {
                item.style.background = '#3a5a3a';
                setTimeout(() => {
                    item.style.background = '';
                }, 300);
            }
        }
    }

    async function addTodo() {
        const input = document.getElementById('todo-new-input');
        const priority = document.getElementById('todo-new-priority').value;
        const thoughtInput = document.getElementById('todo-new-thought');
        const text = input.value.trim();
        const thought = thoughtInput.value.trim();

        if (!text) return;

        const todo = {
            id: Date.now().toString(),
            text,
            thought,
            priority,
            completed: false,
            createdAt: new Date().toISOString()
        };

        todos.unshift(todo);
        await saveTodos();
        render();
        input.value = '';
        thoughtInput.value = '';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function init(baseUrl, options = {}) {
        apiBase = baseUrl || `http://${location.hostname}:8585`;
        config = { ...config, ...options };
        createStyles();
        createPanel();
        loadState();
    }

    return { init, show, hide, toggle, loadTodos };
})();

