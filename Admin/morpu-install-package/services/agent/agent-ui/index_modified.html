!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SimWidget Agent - \"Kit\"</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #1a1a2e;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #333;
        }
        .header h1 { font-size: 18px; font-weight: 600; }
        .btn-logs { background: none; border: none; color: #888; cursor: pointer; font-size: 16px; padding: 4px 8px; margin-right: auto; }
        .btn-logs:hover { color: #4a9eff; }
        .btn-menu, .btn-services, .btn-refresh {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            color: #888;
            transition: all 0.2s;
        }
        .btn-menu { font-size: 20px; }
        .btn-menu:hover, .btn-services:hover, .btn-refresh:hover { color: #4a9eff; }
        .btn-refresh.spinning { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .header-cost { background: #1a3a1a; color: #22c55e; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; cursor: pointer; }
        .header-cost:hover { background: #22c55e; color: #000; }
        .btn-todo { background: #2a2a3e; border: none; color: #ccc; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .btn-todo:hover { background: #4a9eff; color: #fff; }
        .status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #ff4444;
            cursor: pointer;
        }
        .status.connected { background: #44aa44; }
        .status.busy { background: #eab308; color: #000; }
        .compact-status { display: flex; gap: 6px; margin-right: 8px; align-items: center; }
        .compact-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        .compact-dot.online { background: #22c55e; box-shadow: 0 0 6px rgba(34,197,94,0.6); }
        .compact-dot.offline { background: #ef4444; box-shadow: 0 0 6px rgba(239,68,68,0.6); }
        .compact-dot.checking { background: #eab308; animation: pulse 1s infinite; }
        .header-cost { 
            font-size: 12px; color: #22c55e; cursor: pointer; margin-left: 4px;
            padding: 2px 6px; background: rgba(34,197,94,0.1); border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
        }
        .header-cost:hover { background: rgba(34,197,94,0.2); }
        .header-cost.cost-changed {
            animation: costPulse 0.6s ease;
            background: rgba(34,197,94,0.4);
        }
        .cost-delta {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #ff6b6b;
            background: rgba(255,107,107,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            animation: deltaFade 2s ease forwards;
        }
        @keyframes costPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); background: rgba(34,197,94,0.5); }
            100% { transform: scale(1); }
        }
        @keyframes deltaFade {
            0% { opacity: 1; transform: translateX(-50%) translateY(0); }
            70% { opacity: 1; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }

        /* Overlays & Panels */
        .overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 100;
        }
        .overlay.active { display: block; }
        .admin-menu, .services-panel {
            position: fixed; top: 0; width: 300px; height: 100%;
            background: #1a1a2e; z-index: 101;
            transition: all 0.3s ease;
            display: flex; flex-direction: column;
        }
        .admin-menu { left: -320px; border-right: 1px solid #333; }
        .admin-menu.active { left: 0; }
        .services-panel { right: -320px; border-left: 1px solid #333; }
        .services-panel.active { right: 0; }
        .admin-header, .services-header, .log-header {
            padding: 16px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .admin-header h2, .services-header h2, .log-header h2 { font-size: 16px; font-weight: 600; }
        .btn-close { background: none; border: none; color: #888; font-size: 20px; cursor: pointer; }
        .btn-close:hover { color: #fff; }
        .admin-content, .services-content { flex: 1; padding: 16px; overflow-y: auto; }
        .section-label { font-size: 10px; font-weight: 600; color: #666; letter-spacing: 1px; margin-bottom: 12px; }
        .admin-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .admin-btn {
            background: #2a2a3e; border: 1px solid #333; color: #ccc;
            padding: 10px 14px; border-radius: 8px; font-size: 13px; cursor: pointer;
        }
        .admin-btn:hover { background: #3a3a4e; color: #fff; border-color: #4a9eff; }
        .notes-section { padding: 0 12px; }
        .notes-section textarea { width: 100%; background: #1a1a2e; border: 1px solid #333; color: #e0e0e0; border-radius: 8px; padding: 10px; font-size: 13px; resize: vertical; margin-bottom: 8px; font-family: inherit; box-sizing: border-box; }
        .notes-section textarea:focus { outline: none; border-color: #4a9eff; }
        .notes-save { width: 100%; margin-bottom: 12px; }
        .service-row {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .status-dot {
            width: 10px; height: 10px; border-radius: 50%;
            background: #666; cursor: pointer; flex-shrink: 0;
        }
        .status-dot.online { background: #22c55e; box-shadow: 0 0 8px rgba(34,197,94,0.5); }
        .status-dot.offline { background: #ef4444; }
        .status-dot.checking { background: #eab308; animation: pulse 1s infinite; }
        .service-info { flex: 1; cursor: pointer; }
        .service-name { font-size: 14px; font-weight: 500; }
        .service-port { font-size: 12px; color: #888; font-family: 'Consolas', monospace; }
        .service-controls { display: flex; gap: 4px; }
        .btn-control {
            width: 32px; height: 32px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 14px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-start { background: #0f3460; color: #22c55e; }
        .btn-start:hover { background: #1a4a7a; }
        .btn-stop { background: #3d1a1a; color: #ef4444; }
        .btn-stop:hover { background: #5a2a2a; }
        .btn-log { background: #1a2a3d; color: #4a9eff; }
        .btn-log:hover { background: #2a3a4d; }

        /* Log Viewer Modal */
        .log-modal {
            display: none; position: fixed;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 600px; max-height: 80vh;
            background: #1a1a2e; border: 1px solid #333; border-radius: 12px;
            z-index: 102; flex-direction: column; overflow: hidden;
        }
        .log-modal.active { display: flex; }
        .log-content {
            flex: 1; padding: 16px; overflow-y: auto;
            font-family: 'Consolas', monospace; font-size: 12px;
            background: #0a0a14; white-space: pre-wrap; color: #88cc88;
            min-height: 200px; max-height: 400px;
        }
        .log-content .error { color: #ff6666; }
        .log-content .warn { color: #ffcc00; }
        .log-footer { padding: 12px 16px; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .log-footer-left { display: flex; gap: 8px; }
        .log-footer button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .btn-refresh-log { background: #0f3460; color: #4a9eff; }
        .btn-copy-log { background: #1a3a1a; color: #22c55e; }
        .btn-copy-log.copied { background: #22c55e; color: #000; }
        .btn-clear-log { background: #3d1a1a; color: #ef4444; }
        .btn-close-log-bottom { background: #2a2a3e; color: #888; }
        .btn-close-log-bottom:hover { background: #3a3a4e; color: #fff; }
        
        /* Cost Report Modal */
        .cost-modal {
            display: none; position: fixed;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; max-height: 80vh;
            background: #1a1a2e; border: 1px solid #333; border-radius: 12px;
            z-index: 102; flex-direction: column; overflow: hidden;
        }
        .cost-modal.active { display: flex; }
        .cost-content { flex: 1; padding: 16px; overflow-y: auto; }
        .cost-card {
            background: #2a2a3e; border-radius: 8px; padding: 16px; margin-bottom: 12px;
        }
        .cost-card h3 { font-size: 12px; color: #888; margin-bottom: 8px; text-transform: uppercase; }
        .cost-row { display: flex; justify-content: space-between; padding: 4px 0; }
        .cost-label { color: #aaa; }
        .cost-value { color: #fff; font-weight: 500; }
        .cost-value.highlight { color: #4a9eff; font-size: 18px; }
        .cost-history { font-size: 12px; }
        .cost-history-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #333; }
        .cost-history-row:last-child { border-bottom: none; }
        
        /* Chat */
        .chat-container {
            flex: 1; overflow-y: auto; padding: 16px;
            display: flex; flex-direction: column; gap: 12px;
        }
        .message {
            max-width: 85%; padding: 12px 16px; border-radius: 16px;
            line-height: 1.4; white-space: pre-wrap; word-wrap: break-word;
        }
        .message.user { background: #4a9eff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .message.assistant { background: #2a2a3e; align-self: flex-start; border-bottom-left-radius: 4px; }
        .message.thinking { background: #2a2a3e; align-self: flex-start; color: #888; font-style: italic; }
        .message.error { background: #442222; color: #ff8888; align-self: center; }
        .message.system { background: #1a3a1a; color: #88cc88; align-self: center; font-size: 13px; }
        .message code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 13px; }
        .message pre { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; overflow-x: auto; margin: 8px 0; }
        
        /* Pending Task Bubble */
        .pending-bubble {
            display: none; background: #2a2a3e; border: 1px solid #4a9eff;
            border-radius: 12px; padding: 12px 16px; margin: 0 16px 8px;
            animation: slideUp 0.2s ease;
        }
        .pending-bubble.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pending-text { font-size: 13px; color: #ccc; margin-bottom: 10px; max-height: 60px; overflow: hidden; cursor: pointer; }
        .pending-text:hover { color: #fff; }
        .pending-text:active { color: #4a9eff; }
        .pending-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .pending-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; }
        .pending-send { background: #4a9eff; color: white; }
        .pending-send:hover:not(:disabled) { background: #3a8eef; }
        .pending-send:disabled { background: #333; color: #666; cursor: not-allowed; }
        .pending-todo { background: #0f3460; color: #4a9eff; }
        .pending-todo:hover { background: #1a4a7a; }
        .priority-select { background: #1a1a2e; border: 1px solid #333; color: #ccc; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
        .priority-select option[value="mustdo"] { color: #ff4444; font-weight: bold; }
        .pending-cancel { background: none; color: #888; font-size: 16px; padding: 4px 8px; }
        .pending-cancel:hover { color: #ef4444; }

        /* Input */
        .input-container { background: #1a1a2e; padding: 12px 16px; display: flex; gap: 8px; border-top: 1px solid #333; }
        .input-wrapper { flex: 1; display: flex; background: #2a2a3e; border-radius: 24px; overflow: hidden; }
        #message-input { flex: 1; background: transparent; border: none; padding: 12px 16px; color: #e0e0e0; font-size: 16px; outline: none; }
        #message-input::placeholder { color: #666; }
        .btn { width: 48px; height: 48px; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .btn-send { background: #4a9eff; color: white; }
        .btn-send:hover { background: #3a8eef; }
        .btn-send:disabled { background: #333; cursor: not-allowed; }
        .btn-voice { background: transparent; color: #888; }
        .btn-voice:hover { color: #4a9eff; }
        .btn-voice.listening { color: #ff4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .quick-actions { display: flex; gap: 8px; padding: 8px 16px; overflow-x: auto; background: #1a1a2e; }
        .quick-btn { background: #2a2a3e; border: 1px solid #333; color: #aaa; padding: 8px 12px; border-radius: 16px; font-size: 12px; white-space: nowrap; cursor: pointer; }
        .quick-btn:hover { background: #3a3a4e; color: #fff; }
        ::-web\"Kit\"-scrollbar { width: 6px; }
        ::-web\"Kit\"-scrollbar-track { background: transparent; }
        ::-web\"Kit\"-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <button class="btn-menu" id="btn-menu" title="Menu">â˜°</button>
        <h1>ðŸ¤– Admin \"Kit\"</h1>
        <button class="btn-logs" onclick="toggleLog('agent')" title="View Logs">ðŸ“œ</button>
        <div class="header-right">
            <button class="btn-todo" id="btn-todo" onclick="TodoModule.toggle()" title="TODO List">ðŸ“‹</button>
            <div class="compact-status" id="compact-status">
                <span class="compact-dot" id="dot-simwidget" title="SimWidget :8080"></span>
                <span class="compact-dot" id="dot-agent" title="Agent :8585"></span>
                <span class="compact-dot" id="dot-remote" title="Remote :8590"></span>
                <span class="header-cost" id="header-cost" onclick="toggleCostReport()" title="Today's cost">$0.00</span>
            </div>
            <button class="btn-services" id="btn-services" title="Services">âš™ï¸</button>
            <button class="btn-refresh" id="btn-refresh" title="Reconnect">ðŸ”„</button>
            <div class="status" id="status">Disconnected</div>
        </div>
    </div>

    <!-- Admin Menu -->
    <div class="overlay" id="admin-overlay"></div>
    <div class="admin-menu" id="admin-menu">
        <div class="admin-header"><h2>Admin</h2><button class="btn-close" id="btn-close-admin">Ã—</button></div>
        <div class="admin-content">
            <div class="section-label">QUICK COMMANDS</div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="sendQuick('server status')">ðŸ“Š Status</button>
                <button class="admin-btn" onclick="sendQuick('restart server')">ðŸ”„ Restart</button>
                <button class="admin-btn" onclick="sendQuick('run tests')">ðŸ§ª Tests</button>
                <button class="admin-btn" onclick="sendQuick('show errors')">âš ï¸ Errors</button>
            </div>
            <div class="section-label">SYSTEM</div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="sendQuick('list processes')">ðŸ“‹ Processes</button>
                <button class="admin-btn" onclick="sendQuick('disk usage')">ðŸ’¾ Disk</button>
                <button class="admin-btn" onclick="sendQuick('sync to github')">ðŸ“¤ Git Sync</button>
            </div>
            <div class="section-label">WIDGETS</div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="sendQuick('list widgets')">ðŸŽ›ï¸ List All</button>
                <button class="admin-btn" onclick="sendQuick('create widget')">âž• New Widget</button>
            </div>
            <div class="section-label">LINKS</div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="window.open(`http://${baseHost}:8080`, '_blank')">ðŸš€ SimWidget UI</button>
                <button class="admin-btn" onclick="showCostReport()">ðŸ’° API Costs</button>
            </div>
            <div class="section-label">LOGS</div>
            <div class="admin-buttons">
                <button class="admin-btn" onclick="showLog('errors')">âš ï¸ Agent Errors</button>
                <button class="admin-btn" onclick="showLog('chat')">ðŸ’¬ Chat History</button>
                <button class="admin-btn" onclick="showLog('simwidget')">ðŸŽ›ï¸ SimWidget</button>
                <button class="admin-btn" onclick="showLog('usage')">ðŸ“Š Usage Log</button>
            </div>
            <div class="section-label">NOTES</div>
            <div class="notes-section">
                <textarea id="admin-notes" placeholder="Quick notes..." rows="6"></textarea>
                <button class="admin-btn notes-save" onclick="saveNotes()">ðŸ’¾ Save Notes</button>
            </div>
        </div>
    </div>

    <!-- Services Panel -->
    <div class="overlay" id="services-overlay"></div>
    <div class="services-panel" id="services-panel">
        <div class="services-header"><h2>SimWidget Services</h2><button class="btn-close" id="btn-close-services">Ã—</button></div>
        <div class="services-content">
            <div class="section-label">SERVICES</div>
            <div class="service-row" data-service="simwidget">
                <span class="status-dot" id="status-simwidget"></span>
                <div class="service-info" onclick="showLog('simwidget')"><div class="service-name">SimWidget</div></div>
                <div class="service-port">:8080</div>
                <div class="service-controls">
                    <button class="btn-control btn-log" onclick="showLog('simwidget')" title="View Log">ðŸ“‹</button>
                    <button class="btn-control btn-start" data-action="start" title="Start">â–¶</button>
                    <button class="btn-control btn-stop" data-action="stop" title="Stop">â– </button>
                </div>
            </div>
            <div class="service-row" data-service="agent">
                <span class="status-dot" id="status-agent"></span>
                <div class="service-info" onclick="showLog('agent')"><div class="service-name">Agent</div></div>
                <div class="service-port">:8585</div>
                <div class="service-controls">
                    <button class="btn-control btn-log" onclick="showLog('agent')" title="View Log">ðŸ“‹</button>
                    <button class="btn-control btn-start" data-action="start" title="Start">â–¶</button>
                    <button class="btn-control btn-stop" data-action="stop" title="Stop">â– </button>
                </div>
            </div>
            <div class="service-row" data-service="remote">
                <span class="status-dot" id="status-remote"></span>
                <div class="service-info" onclick="showLog('remote')"><div class="service-name">Remote</div></div>
                <div class="service-port">:8590</div>
                <div class="service-controls">
                    <button class="btn-control btn-log" onclick="showLog('remote')" title="View Log">ðŸ“‹</button>
                    <button class="btn-control btn-start" data-action="start" title="Start">â–¶</button>
                    <button class="btn-control btn-stop" data-action="stop" title="Stop">â– </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Viewer Modal -->
    <div class="log-modal" id="log-modal">
        <div class="log-header"><h2 id="log-title">Service Log</h2><button class="btn-close" id="btn-close-log">Ã—</button></div>
        <div class="log-content" id="log-content">Loading...</div>
        <div class="log-footer">
            <div class="log-footer-left">
                <button class="btn-refresh-log" onclick="refreshLog()">ðŸ”„ Refresh</button>
                <button class="btn-copy-log" id="btn-copy-log" onclick="copyLog()">ðŸ“‹ Copy</button>
                <button class="btn-clear-log" onclick="clearLog()">ðŸ—‘ï¸ Clear</button>
            </div>
            <button class="btn-close-log-bottom" onclick="logModal.classList.remove('active')">âœ• Close</button>
        </div>
    </div>

    <!-- Cost Report Modal -->
    <div class="cost-modal" id="cost-modal">
        <div class="log-header"><h2>ðŸ’° API Usage & Costs</h2><button class="btn-close" id="btn-close-cost">Ã—</button></div>
        <div class="cost-content" id="cost-content">
            <div class="cost-card">
                <h3>Today</h3>
                <div class="cost-row"><span class="cost-label">Requests</span><span class="cost-value" id="today-requests">-</span></div>
                <div class="cost-row"><span class="cost-label">Input Tokens</span><span class="cost-value" id="today-input">-</span></div>
                <div class="cost-row"><span class="cost-label">Output Tokens</span><span class="cost-value" id="today-output">-</span></div>
                <div class="cost-row"><span class="cost-label">Cost</span><span class="cost-value highlight" id="today-cost">$0.00</span></div>
            </div>
            <div class="cost-card">
                <h3>All Time</h3>
                <div class="cost-row"><span class="cost-label">Requests</span><span class="cost-value" id="total-requests">-</span></div>
                <div class="cost-row"><span class="cost-label">Input Tokens</span><span class="cost-value" id="total-input">-</span></div>
                <div class="cost-row"><span class="cost-label">Output Tokens</span><span class="cost-value" id="total-output">-</span></div>
                <div class="cost-row"><span class="cost-label">Total Cost</span><span class="cost-value highlight" id="total-cost">$0.00</span></div>
            </div>
            <div class="cost-card">
                <h3>ðŸ“Š Projected Costs</h3>
                <div class="cost-row"><span class="cost-label">Daily Avg</span><span class="cost-value" id="proj-daily">$0.00</span></div>
                <div class="cost-row"><span class="cost-label">Weekly</span><span class="cost-value" id="proj-weekly">$0.00</span></div>
                <div class="cost-row"><span class="cost-label">Monthly</span><span class="cost-value highlight" id="proj-monthly">$0.00</span></div>
                <div class="cost-row"><span class="cost-label">Yearly</span><span class="cost-value" id="proj-yearly">$0.00</span></div>
            </div>
            <div class="cost-card cost-history">
                <h3>Last 7 Days</h3>
                <div id="cost-history"></div>
            </div>
            <div class="cost-card cost-history">
                <h3>Monthly Breakdown</h3>
                <div id="cost-months"></div>
            </div>
        </div>
    </div>

    <div class="quick-actions">
        <button class="quick-btn" onclick="sendQuick('server status')">Status</button>
        <button class="quick-btn" onclick="sendQuick('restart server')">Restart</button>
        <button class="quick-btn" onclick="sendQuick('run tests')">Tests</button>
        <button class="quick-btn" onclick="sendQuick('list widgets')">Widgets</button>
        <button class="quick-btn" onclick="sendQuick('sync to github')">Git Sync</button>
    </div>

    <div class="chat-container" id="chat"></div>

    <!-- Pending Task Bubble -->
    <div class="pending-bubble" id="pending-bubble">
        <div class="pending-text" id="pending-text" onclick="copyPendingText()" title="Click to copy"></div>
        <div class="pending-actions">
            <button class="pending-btn pending-send" id="pending-send-btn" onclick="sendPending()" disabled>Send (when ready)</button>
            <button class="pending-btn pending-todo" onclick="addTodo()">TODO:</button>
            <select class="priority-select" id="priority-select">
                <option value="mustdo">âš¡ MUSTDO</option>
                <option value="high">High</option>
                <option value="medium" selected>Medium</option>
                <option value="low">Low</option>
            </select>
            <button class="pending-btn pending-cancel" onclick="cancelPending()">âœ•</button>
        </div>
    </div>

    <div class="input-container">
        <div class="input-wrapper">
            <input type="text" id="message-input" placeholder="Message \"Kit\"..." autocomplete="off">
            <button class="btn btn-voice" id="btn-voice" title="Voice input">ðŸŽ¤</button>
        </div>
        <button class="btn btn-send" id="btn-send" title="Send">âž¤</button>
    </div>

    <script>
        const chat = document.getElementById('chat');
        const input = document.getElementById('message-input');
        const btnSend = document.getElementById('btn-send');
        const btnVoice = document.getElementById('btn-voice');
        const btnRefresh = document.getElementById('btn-refresh');
        const status = document.getElementById('status');
        const pendingBubble = document.getElementById('pending-bubble');
        const pendingText = document.getElementById('pending-text');
        const prioritySelect = document.getElementById('priority-select');

        let ws = null;
        let recognition = null;
        let isBusy = false;
        let pendingMessage = '';
        let currentLogService = null;
        let reconnectTimeout = null;
        let manualDisconnect = false;

        const services = {
            simwidget: { port: 8080, status: 'checking' },
            agent: { port: 8585, status: 'checking' },
            remote: { port: 8590, status: 'checking' }
        };

        // ==================== MENUS ====================
        const adminMenu = document.getElementById('admin-menu');
        const adminOverlay = document.getElementById('admin-overlay');
        const servicesPanel = document.getElementById('services-panel');
        const servicesOverlay = document.getElementById('services-overlay');
        const logModal = document.getElementById('log-modal');

        document.getElementById('btn-menu').addEventListener('click', () => togglePanel('admin'));
        document.getElementById('btn-close-admin').addEventListener('click', () => togglePanel('admin'));
        document.getElementById('admin-overlay').addEventListener('click', () => togglePanel('admin'));
        
        document.getElementById('btn-services').addEventListener('click', () => togglePanel('services'));
        document.getElementById('compact-status').addEventListener('click', () => togglePanel('services'));
        document.getElementById('btn-close-services').addEventListener('click', () => togglePanel('services'));
        document.getElementById('services-overlay').addEventListener('click', () => togglePanel('services'));
        
        document.getElementById('btn-close-log').addEventListener('click', () => logModal.classList.remove('active'));

        const costModal = document.getElementById('cost-modal');
        document.getElementById('btn-close-cost').addEventListener('click', () => costModal.classList.remove('active'));

        function togglePanel(panel) {
            if (panel === 'admin') {
                adminMenu.classList.toggle('active');
                adminOverlay.classList.toggle('active');
            } else {
                servicesPanel.classList.toggle('active');
                servicesOverlay.classList.toggle('active');
            }
        }

        function closeAllPanels() {
            adminMenu.classList.remove('active');
            adminOverlay.classList.remove('active');
            servicesPanel.classList.remove('active');
            servicesOverlay.classList.remove('active');
        }

        // ==================== LOG VIEWER ====================
        function toggleLog(service) {
            if (logModal.classList.contains('active')) {
                logModal.classList.remove('active');
            } else {
                showLog(service);
            }
        }
        
        async function showLog(service) {
            // Map 'agent' to 'errors' for agent error log
            currentLogService = (service === 'agent') ? 'errors' : service;
            document.getElementById('log-title').textContent = `${service.charAt(0).toUpperCase() + service.slice(1)} Log`;
            logModal.classList.add('active');
            await refreshLog();
        }

        async function refreshLog() {
            const logContent = document.getElementById('log-content');
            logContent.textContent = 'Loading...';
            
            // Route to correct server based on log type
            let endpoint;
            if (currentLogService === 'errors' || currentLogService === 'chat' || currentLogService === 'usage') {
                endpoint = `http://${location.hostname}:8585/api/logs/${currentLogService}`;
            } else {
                endpoint = `http://${baseHost}:8080/api/logs/${currentLogService}`;
            }
            
            try {
                const response = await fetch(endpoint, { timeout: 3000 });
                if (response.ok) {
                    const data = await response.json();
                    logContent.innerHTML = formatLog(data.log || 'No log data');
                } else {
                    logContent.textContent = 'Failed to fetch log';
                }
            } catch (err) {
                logContent.textContent = `Error: ${err.message}\n\nService may not be running or log endpoint not available.`;
            }
        }

        function formatLog(log) {
            return log
                .replace(/error/gi, '<span class="error">error</span>')
                .replace(/warn/gi, '<span class="warn">warn</span>');
        }

        async function clearLog() {
            if (!currentLogService) return;
            if (!confirm(`Clear ${currentLogService} log permanently?`)) return;
            
            // Determine which endpoint to use
            let endpoint;
            if (currentLogService === 'errors' || currentLogService === 'chat' || currentLogService === 'usage') {
                endpoint = `http://${location.hostname}:8585/api/logs/${currentLogService}`;
            } else {
                endpoint = `http://${location.hostname}:8080/api/logs/${currentLogService}`;
            }
            
            try {
                const res = await fetch(endpoint, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('log-content').textContent = 'Log cleared';
                } else {
                    document.getElementById('log-content').textContent = 'Error: ' + (data.error || 'Unknown error');
                }
            } catch (err) {
                document.getElementById('log-content').textContent = 'Error: ' + err.message;
            }
        }

        async function copyLog() {
            const logContent = document.getElementById('log-content');
            const btn = document.getElementById('btn-copy-log');
            const text = logContent.innerText;
            
            try {
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // Fallback for non-HTTPS or older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
                btn.classList.add('copied');
                btn.textContent = 'âœ“ Copied';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.textContent = 'ðŸ“‹ Copy';
                }, 2000);
            } catch (err) {
                console.error('Copy failed:', err);
                btn.textContent = 'âŒ Failed';
                setTimeout(() => btn.textContent = 'ðŸ“‹ Copy', 2000);
            }
        }

        // ==================== COST REPORT ====================
        function toggleCostReport() {
            if (costModal.classList.contains('active')) {
                costModal.classList.remove('active');
            } else {
                showCostReport();
            }
        }
        
        async function showCostReport() {
            closeAllPanels();
            costModal.classList.add('active');
            
            try {
                const response = await fetch(`http://${baseHost}:8585/api/usage`);
                const data = await response.json();
                
                // Today
                document.getElementById('today-requests').textContent = data.today.requests.toLocaleString();
                document.getElementById('today-input').textContent = data.today.inputTokens.toLocaleString();
                document.getElementById('today-output').textContent = data.today.outputTokens.toLocaleString();
                document.getElementById('today-cost').textContent = '$' + data.today.cost.toFixed(4);
                
                // Total
                document.getElementById('total-requests').textContent = data.total.requests.toLocaleString();
                document.getElementById('total-input').textContent = data.total.inputTokens.toLocaleString();
                document.getElementById('total-output').textContent = data.total.outputTokens.toLocaleString();
                document.getElementById('total-cost').textContent = '$' + data.total.cost.toFixed(4);
                
                // Projections
                if (data.projections) {
                    document.getElementById('proj-daily').textContent = '$' + data.projections.daily.toFixed(4);
                    document.getElementById('proj-weekly').textContent = '$' + data.projections.weekly.toFixed(2);
                    document.getElementById('proj-monthly').textContent = '$' + data.projections.monthly.toFixed(2);
                    document.getElementById('proj-yearly').textContent = '$' + data.projections.yearly.toFixed(2);
                }
                
                // History (last 7 days)
                const historyDiv = document.getElementById('cost-history');
                if (data.history.length === 0) {
                    historyDiv.innerHTML = '<div style="color:#666">No history yet</div>';
                } else {
                    historyDiv.innerHTML = data.history.map(day => `
                        <div class="cost-history-row">
                            <span>${day.date}</span>
                            <span>${day.requests} req</span>
                            <span>$${day.cost.toFixed(4)}</span>
                        </div>
                    `).join('');
                }
                
                // Monthly breakdown
                const monthsDiv = document.getElementById('cost-months');
                if (data.months && data.months.length > 0) {
                    monthsDiv.innerHTML = data.months.map(m => `
                        <div class="cost-history-row">
                            <span>${m.month}</span>
                            <span>${m.requests} req</span>
                            <span>$${m.cost.toFixed(2)}</span>
                        </div>
                    `).join('');
                } else {
                    monthsDiv.innerHTML = '<div style="color:#666">No monthly data yet</div>';
                }
            } catch (err) {
                document.getElementById('cost-content').innerHTML = `<div style="color:#ff6666">Error loading usage: ${err.message}</div>`;
            }
        }

        // ==================== SERVICES ====================
        const baseHost = location.hostname; // Use actual host, not localhost
        
        async function checkService(name) {
            const service = services[name];
            updateServiceStatus(name, 'checking');
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const response = await fetch(`http://${baseHost}:${service.port}/api/status`, { 
                    signal: controller.signal,
                    mode: 'cors'
                });
                clearTimeout(timeoutId);
                service.status = response.ok ? 'online' : 'offline';
            } catch (err) { 
                console.log(`Service ${name} check failed:`, err.message);
                service.status = 'offline'; 
            }
            updateServiceStatus(name, service.status);
        }

        function updateServiceStatus(name, status) {
            const dot = document.getElementById(`status-${name}`);
            if (dot) dot.className = 'status-dot ' + status;
            const compactDot = document.getElementById(`dot-${name}`);
            if (compactDot) compactDot.className = 'compact-dot ' + status;
        }

        async function checkAllServices() {
            for (const name of Object.keys(services)) await checkService(name);
        }

        document.querySelectorAll('.service-row').forEach(row => {
            const service = row.dataset.service;
            row.querySelectorAll('.btn-start, .btn-stop').forEach(btn => {
                btn.addEventListener('click', () => controlService(service, btn.dataset.action));
            });
        });

        async function controlService(service, action) {
            try {
                await fetch(`http://${baseHost}:8080/api/services`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ service, action })
                });
                setTimeout(() => checkService(service), 2000);
            } catch (err) { console.error('Service control failed:', err); }
        }

        checkAllServices();
        setInterval(checkAllServices, 10000);
        
        // Load and update header cost
        let lastKnownCost = null;
        
        async function updateHeaderCost() {
            try {
                const response = await fetch(`http://${baseHost}:8585/api/usage`);
                const data = await response.json();
                const newCost = data.today.cost;
                const costEl = document.getElementById('header-cost');
                
                // Check if cost changed
                if (lastKnownCost !== null && newCost > lastKnownCost) {
                    const delta = newCost - lastKnownCost;
                    
                    // Remove any existing delta
                    const existingDelta = costEl.querySelector('.cost-delta');
                    if (existingDelta) existingDelta.remove();
                    
                    // Update text first
                    costEl.childNodes.forEach(n => { if (n.nodeType === 3) n.remove(); });
                    costEl.insertBefore(document.createTextNode('$' + newCost.toFixed(4)), costEl.firstChild);
                    
                    // Show delta notification
                    const deltaEl = document.createElement('span');
                    deltaEl.className = 'cost-delta';
                    deltaEl.textContent = '+$' + delta.toFixed(4);
                    costEl.appendChild(deltaEl);
                    
                    // Pulse animation
                    costEl.classList.add('cost-changed');
                    
                    // Cleanup after animation
                    setTimeout(() => {
                        costEl.classList.remove('cost-changed');
                        if (deltaEl.parentNode) deltaEl.remove();
                    }, 2000);
                } else {
                    costEl.textContent = '$' + newCost.toFixed(4);
                }
                
                lastKnownCost = newCost;
            } catch (err) {
                console.error('Failed to load cost:', err);
            }
        }
        updateHeaderCost();
        setInterval(updateHeaderCost, 30000); // Update every 30s

        // ==================== NOTES ====================
        async function loadNotes() {
            try {
                const response = await fetch(`http://${baseHost}:8585/api/notes`);
                const data = await response.json();
                document.getElementById('admin-notes').value = data.notes || '';
            } catch (err) {
                console.error('Failed to load notes:', err);
            }
        }
        
        async function saveNotes() {
            const notes = document.getElementById('admin-notes').value;
            try {
                await fetch(`http://${baseHost}:8585/api/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                // Flash save button green
                const btn = document.querySelector('.notes-save');
                btn.textContent = 'âœ“ Saved';
                btn.style.background = '#22c55e';
                btn.style.color = '#000';
                setTimeout(() => {
                    btn.textContent = 'ðŸ’¾ Save Notes';
                    btn.style.background = '';
                    btn.style.color = '';
                }, 1500);
            } catch (err) {
                console.error('Failed to save notes:', err);
            }
        }
        
        loadNotes();

        // ==================== PENDING TASK ====================
        const pendingSendBtn = document.getElementById('pending-send-btn');
        
        function showPendingBubble(text) {
            pendingMessage = text;
            pendingText.textContent = text;
            pendingBubble.classList.add('active');
            updatePendingSendBtn();
        }

        function hidePendingBubble() {
            pendingBubble.classList.remove('active');
            pendingMessage = '';
        }
        
        function updatePendingSendBtn() {
            pendingSendBtn.disabled = isBusy;
            pendingSendBtn.textContent = isBusy ? 'Send (when ready)' : 'Send Now';
        }
        
        async function copyPendingText() {
            try {
                await navigator.clipboard.writeText(pendingMessage);
                const original = pendingText.textContent;
                pendingText.textContent = 'âœ“ Copied!';
                setTimeout(() => pendingText.textContent = original, 1000);
            } catch (err) {
                console.error('Copy failed:', err);
            }
        }

        function sendPending() {
            if (pendingMessage && !isBusy) {
                addMessage('user', pendingMessage);
                ws.send(JSON.stringify({ type: 'chat', content: pendingMessage }));
                hidePendingBubble();
            }
        }

        function addTodo() {
            const priority = prioritySelect.value;
            const todoText = `Add to TODO (${priority}): ${pendingMessage}`;
            addMessage('system', `ðŸ“ Added to TODO [${priority.toUpperCase()}]: ${pendingMessage}`);
            // Could also send to server to persist
            ws.send(JSON.stringify({ type: 'todo', content: pendingMessage, priority }));
            hidePendingBubble();
        }

        function cancelPending() {
            hidePendingBubble();
        }

        // ==================== CHAT ====================
        function connect() {
            // Clear any pending reconnect
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                manualDisconnect = true;
                ws.close();
            }
            
            btnRefresh.classList.add('spinning');
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/chat`);

            ws.onopen = () => {
                status.textContent = 'Connected';
                status.className = 'status connected';
                btnRefresh.classList.remove('spinning');
                manualDisconnect = false;
                
                // Only show message once per session (persists across hot reloads)
                if (!sessionStorage.getItem('\"Kit\"Connected')) {
                    sessionStorage.setItem('\"Kit\"Connected', 'true');
                    addMessage('system', 'âœ“ Connected to "\"Kit\""', { fadeAfter: 10000 });
                }
                
                // Keep-alive ping every 25s to prevent mobile browsers from dropping connection
                if (window.keepAliveInterval) clearInterval(window.keepAliveInterval);
                window.keepAliveInterval = setInterval(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 25000);
            };

            ws.onclose = () => {
                status.textContent = 'Disconnected';
                status.className = 'status';
                btnRefresh.classList.remove('spinning');
                isBusy = false;
                
                // Clear keep-alive
                if (window.keepAliveInterval) {
                    clearInterval(window.keepAliveInterval);
                    window.keepAliveInterval = null;
                }
                
                // Only auto-reconnect if not manually disconnected
                if (!manualDisconnect) {
                    reconnectTimeout = setTimeout(connect, 3000);
                }
                manualDisconnect = false;
            };

            ws.onerror = () => btnRefresh.classList.remove('spinning');

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'thinking') {
                    showThinking();
                    isBusy = true;
                    updatePendingSendBtn();
                    status.textContent = 'Thinking...';
                    status.className = 'status busy';
                } else if (msg.type === 'response') {
                    hideThinking();
                    addMessage('assistant', msg.content);
                    isBusy = false;
                    updatePendingSendBtn();
                    updateHeaderCost(); // Update cost after each response
                    status.textContent = 'Connected';
                    status.className = 'status connected';
                } else if (msg.type === 'error') {
                    hideThinking();
                    addMessage('error', 'Error: ' + msg.content);
                    isBusy = false;
                    updatePendingSendBtn();
                    status.textContent = 'Connected';
                    status.className = 'status connected';
                }
            };
        }

        btnRefresh.addEventListener('click', () => { addMessage('system', 'Reconnecting...'); connect(); });

        function addMessage(role, content, options = {}) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            content = content.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre>$2</pre>');
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
            div.innerHTML = content;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            
            // Auto-fade after specified time
            if (options.fadeAfter) {
                setTimeout(() => {
                    div.style.transition = 'opacity 1s ease';
                    div.style.opacity = '0';
                    setTimeout(() => div.remove(), 1000);
                }, options.fadeAfter);
            }
        }

        let thinkingEl = null;
        function showThinking() {
            hideThinking();
            thinkingEl = document.createElement('div');
            thinkingEl.className = 'message thinking';
            thinkingEl.textContent = 'Thinking...';
            chat.appendChild(thinkingEl);
            chat.scrollTop = chat.scrollHeight;
        }
        function hideThinking() { if (thinkingEl) { thinkingEl.remove(); thinkingEl = null; } }

        function send() {
            const text = input.value.trim();
            if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            if (isBusy) {
                showPendingBubble(text);
                input.value = '';
                return;
            }
            
            addMessage('user', text);
            ws.send(JSON.stringify({ type: 'chat', content: text }));
            input.value = '';
        }

        function sendQuick(text) {
            closeAllPanels();
            if (isBusy) {
                showPendingBubble(text);
                return;
            }
            input.value = text;
            send();
        }

        btnSend.addEventListener('click', send);
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') send(); });

        // Voice
        if ('web\"Kit\"SpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.web\"Kit\"SpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'en-US';
            recognition.onstart = () => btnVoice.classList.add('listening');
            recognition.onend = () => btnVoice.classList.remove('listening');
            recognition.onresult = (e) => { input.value = e.results[0][0].transcript; send(); };
            btnVoice.addEventListener('click', () => btnVoice.classList.contains('listening') ? recognition.stop() : recognition.start());
        } else { btnVoice.style.display = 'none'; }

        connect();
    </script>
    <script src="todo-module.js"></script>
    <script src="hot-update/hot-client.js"></script>
    <script>
        // Initialize TODO module
        TodoModule.init(null, {
            assistantName: '\"Kit\"',
            inputSelector: '#message-input'
        });
    </script>
</body>
</html>

