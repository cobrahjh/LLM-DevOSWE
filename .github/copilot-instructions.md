# SimWidget Engine – AI Working Notes

- **Core purpose:** Flight-sim widget platform (Flow Pro replacement) for MSFS 2020/2024: Node.js backend on port 8080 + WebSocket streaming to Electron/HTML widgets; optional services orchestrated via Master O (8500), Agent (8585), Remote Support (8590), KeySender TCP 5111. See [SimWidget_Engine/ARCHITECTURE.md](SimWidget_Engine/ARCHITECTURE.md).
- **Main code roots:** [SimWidget_Engine/simwidget-hybrid/backend](SimWidget_Engine/simwidget-hybrid/backend) (server.js, key-sender.js, camera-controller.js), [SimWidget_Engine/simwidget-hybrid/ui](SimWidget_Engine/simwidget-hybrid/ui) (aircraft-control, fuel, camera, keymap-editor), [SimWidget_Engine/shared-ui](SimWidget_Engine/simwidget-hybrid/shared-ui) (Flow-compatible client), [SimWidget_Engine/KeySenderService](SimWidget_Engine/KeySenderService) (.NET key injector), [SimWidget_Engine/tests](SimWidget_Engine/tests) (fixture-based test runner).
- **Two-PC Google Drive workflow:** Dev PC edits under C:\LLM-DevOSWE\…; Remote PC runs MSFS from synced path G:\Other computers\…; restart backend or refresh browser after sync. Quick start: double-click start-server.bat on remote, browse http://localhost:8080. Details in [SimWidget_Engine/simwidget-hybrid/README.md](SimWidget_Engine/simwidget-hybrid/README.md).
- **Service start commands (PowerShell-friendly; use `;` not `&&`):** start-all-servers.bat for full stack; backend only: `cd simwidget-hybrid; node backend/server.js` (or `npx nodemon backend/server.js`); overlay: `cd overlay; npm start`. Ports: backend 8080, orchestrator 8500, agent 8585, remote 8590, KeySender TCP 5111. From [SimWidget_Engine/CLAUDE.md](SimWidget_Engine/CLAUDE.md).
- **Tests:** Fixture-based runner. Run `node tests/test-runner.js [category] [--update|--db|--cloud]`; categories include plugins, templates, files, services, widgets, api, security. Admin CLI: `node tests/test-admin.js history|report|trends|schedule …`. See [SimWidget_Engine/tests/README.md](SimWidget_Engine/tests/README.md).
- **API surface (port 8080):** REST `/api/status`, `/api/keymaps`, `/api/command`, `/api/sendkey`, `/api/camsys/*`; WebSocket `flightData` payload and `command` messages. Client widgets rely on Flow-compatible shim in [SimWidget_Engine/simwidget-hybrid/shared-ui/flow-api.js](SimWidget_Engine/simwidget-hybrid/shared-ui/flow-api.js). Contracts outlined in [SimWidget_Engine/ARCHITECTURE.md](SimWidget_Engine/ARCHITECTURE.md) and [SimWidget_Engine/CLAUDE.md](SimWidget_Engine/CLAUDE.md).
- **Keymaps v3.0 (GUID-based):** Stored in [SimWidget_Engine/simwidget-hybrid/config/keymaps.json](SimWidget_Engine/simwidget-hybrid/config/keymaps.json); fields `originalId`, `name`, `key`, `trigger`, `isDefault`. Maintain backward compatibility with v2.0 exports (`/api/keymaps/export/v2`).
- **Camera control routing:** Prefer ChasePlane via camera-helper.ahk writing camera-command.txt; fallback to native SimConnect/keyboard. Buttons map differently per mode (TCM Alt+Z vs TOGGLE_DRONE_MODE). Logic in [SimWidget_Engine/simwidget-hybrid/backend/camera-controller.js](SimWidget_Engine/simwidget-hybrid/backend/camera-controller.js); helper script camera-helper.ahk.
- **UI standards (strict):** All floating panels must be draggable and support snap-to-edge; use header drag handles and snap preview; ensure bounds safety. Reference patterns in [SimWidget_Engine/STANDARDS.md](SimWidget_Engine/STANDARDS.md) and reuse `setupDraggable` + snap logic.
- **Timing & retries:** Defaults from [SimWidget_Engine/STANDARDS.md](SimWidget_Engine/STANDARDS.md): 100ms polling for input/simconnect, 100–200ms debounce, 3000ms WebSocket reconnect, 2000ms TCP timeout, 100ms config watch.
- **Windows conventions:** Avoid spaces in paths; prefer absolute paths; PowerShell for scripts with `;` separators; services packaged via WinSW with LocalSystem account. Service names: simwidgetmainserver.exe (8080), simwidgetagent.exe (8585), simwidgetmastero.exe (8500), simwidgetrelay.exe (8600), simwidgetclaudebridge.exe (8601), simwidgetremotesupport.exe (8590), simwidgetkeysender. See [SimWidget_Engine/STANDARDS.md](SimWidget_Engine/STANDARDS.md).
- **Widget dev basics:** Widgets are plain JS/HTML/CSS; register via SimWidgetEngine.registerWidget; use Flow-style `$api.variables.get/set` and loops `loop_1hz`/`loop_5hz`/`exit`. Examples in [SimWidget_Engine/README.md](SimWidget_Engine/README.md).
- **SimConnect data/events:** Core set of 35 simvars/events already mapped in backend/server.js; extend by adding to data definitions and client update paths; keep REST/WebSocket schemas stable (update fixtures when schema changes).
- **Component CSS prefixes:** AxisPad `.swc-ap`, PushButton `.swc-pb`, LinearSlider `.swc-ls`, DataField `.swc-df`, StatusLamp `.swc-sl` (legacy aliases exist). From [SimWidget_Engine/CLAUDE.md](SimWidget_Engine/CLAUDE.md).
- **Testing prerequisites:** `widgets` and `api` suites require backend running; `services` may need Lorby AAO/other external services; use `--update` when intentional response changes modify fixtures.
- **Performance expectations:** Aim for sub-50ms control latency; prefer KeySenderService TCP over PowerShell for key injection (~5ms vs ~700ms). From [SimWidget_Engine/PROJECT-PLAN.md](SimWidget_Engine/PROJECT-PLAN.md) and [SimWidget_Engine/CLAUDE.md](SimWidget_Engine/CLAUDE.md).
- **Docs index:** For deeper context see [SimWidget_Engine/DIRECTORY-STRUCTURE.md](SimWidget_Engine/DIRECTORY-STRUCTURE.md) and [SimWidget_Engine/ARCHITECTURE.md](SimWidget_Engine/ARCHITECTURE.md) before altering architecture or services.

Use this as the starting brief; prefer existing patterns over inventing new ones, and keep fixtures/config formats backward compatible.
